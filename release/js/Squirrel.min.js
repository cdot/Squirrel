/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
/*@preserve  AES implementation in JavaScript                     (c) Chris Veness 2005-2014 / MIT Licence */
"use strict";function RGBA(r,g,b,a){function parseComponent(value,max){if(/%\s*$/.test(value)){return parseFloat(value)*max/100}return parseFloat(value)}if(1!==arguments.length)return this.r=r,this.g=g,this.b=b,void(this.a=a);{if("string"==typeof r){if("string"==typeof r){var named=CSSColours[r.toLowerCase()];if(void 0!==named&&(r=named),"#"==r.charAt(0))return this.r=parseInt(r.substr(1,2),16)/255,this.g=parseInt(r.substr(3,2),16)/255,void(this.b=parseInt(r.substr(5,2),16)/255);if(/^hsla?\(.*\)$/.test(r)){a=r.replace(/(hsla?\(|\))/g,"").split(/[,\s]+/);var n=RGBA.fromHSL(parseComponent(a[0],360),parseComponent(a[1],1),parseComponent(a[2],1),a.length>3?parseComponent(a[3],1):void 0);return this.r=n.r,this.g=n.g,this.b=n.b,void(this.a=n.a)}if(/^rgba?\(.*\)$/.test(r))return a=r.replace(/(rgba?\(|\))/g,"").split(","),this.r=Math.floor(parseComponent(a[0],255))/255,this.g=Math.floor(parseComponent(a[1],255))/255,this.b=Math.floor(parseComponent(a[2],255))/255,void(a.length>3&&(this.a=parseComponent(a[3],1)))}throw"object"==typeof r&&"RGBA"===r.constructor.name&&jQuery.extend(this,r),"Cannot construct from "+typeof r}if("Array"===r.constructor.name)this.r=r[0],this.g=r[1],this.b=r[2],this.a=r[3];else{if("number"!=typeof r.r||"number"!=typeof r.g||"number"!=typeof r.b)throw"Don't know how to make an RGBA from this";this.r=r.r,this.g=r.g,this.b=r.b,this.a=r.a}}}function AbstractStore(params){params.ok.call(this)}function LayeredStore(params){var self=this,pok=params.ok;params.ok=function(){self.engine=this,pok.call(self)},params.understore(params)}function LocalStorageStore(params){if(params.user)this.user(params.user);else{for(var key,i=0,poss_user=null;null!=(key=localStorage.key(i));){var m=/^Squirrel\.(.*)$/.exec(key);if(m){if(poss_user){poss_user=null;break}poss_user=m[1]}i++}poss_user&&(global.DEBUG&&console.debug("LocalStorageStore: Identified possible user "+poss_user),this.user(poss_user))}AbstractStore.call(this,params)}function EncryptedStore(params){LayeredStore.call(this,params)}function Hoard(name,data){if(this.name=name,data){if("object"!=typeof data&&(data=JSON.parse(data)),this.last_sync=data.last_sync,this.actions=data.actions,this.cache=data.cache,this.options=data.options,this.version=data.version||VERSION,this.version>VERSION)throw name+" hoard error: cannot read a version "+data.version+" hoard with "+VERSION+" code"}else this.last_sync=null,this.clear_actions(),this.cache=null,this.version=VERSION;void 0===this.options&&(this.options={store_path:null})}!function($){$.fn.edit_in_place=function(options){function blurb(){$input.remove(),$this.show(),closed()}var $this=$(this),h=options.height||$this.height()||"1em",w=options.width||$this.width()||"1em",changed=options.changed||function(){return $this.text()},closed=options.closed||function(){},$input=$(document.createElement("input")),text=options.text||$this.text();$this.hide(),$input.insertBefore($this).addClass("in_place_editor").val(text).css("height",h).css("width",w).on("change",function(){var val=$(this).val();blurb(),val!==text&&(text=changed.call($this,val))}).on("keydown",function(e){return 27!==e.keyCode&&(13!==e.keyCode||$(this).val()!==text)||(blurb(),!1)}).blur(blurb).select()}}(jQuery),/*@preserve Copyright (C) 2018 Crawford Currie http://c-dot.co.uk license MIT*/
function($){$.fn.simulated_password=function(){$(this).each(function(){function skip_next_change($this){$this.data("skip_pass_change",$this.data("skip_pass_change")+1)}var $this=$(this);this.type="text";var $showpass=$('<input type="checkbox" class="TX_title"/>');$this.after($showpass),$this.data("skip_pass_change",0),$this.data("pass_hidden",!0),$this.data("hidden_pass",""),$showpass.on("click",function(){$this.data("pass_hidden")?($this.val($this.data("hidden_pass")),skip_next_change($this),$this.data("pass_hidden",!1)):($this.data("hidden_pass",$this.val()),skip_next_change($this),$this.val($this.val().replace(/./g,"•")),$this.data("pass_hidden",!0))}).prop("checked",!1),$this.on("input",function(){var v=$this.val();if($this.data("pass_hidden")){var hp=$this.data("hidden_pass");if(v.length>hp.length){var c=v.substring(v.length-1);$this.data("hidden_pass",hp+c),skip_next_change($this),$this.val(v.substring(0,v.length-1)+"•")}else $this.data("hidden_pass",hp.substring(0,hp.length-(hp.length-v.length)));return!1}$this.data("hidden_pass",v)}),$this.on("change",function(){return $this.data("skip_pass_change")>0?($this.data("skip_pass_change",$this.data("skip_pass_change")-1),!1):($this.val($this.data("hidden_pass")),!0)})})}}(jQuery),/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
function($){$.fn.scroll_into_view=function(){return this.each(function(){var offset=$(this).offset().top,thisht=$(this).height(),$win=$(window),curtop=$win.scrollTop(),winht=$win.innerHeight();if(offset<curtop||offset+thisht>curtop+winht){var newtop=offset-winht/2;return newtop<0&&(newtop=0),console.log("Scrolling to "+newtop),$("html,body").animate({scrollTop:newtop},500),!1}return!0})}}(jQuery),/*@preserve Copyright (C) 2017 Crawford Currie http://c-dot.co.uk license MIT*/
function($){$.widget("squirrel.iconbutton",$.ui.button,{_create:function(){this.options.icon=this.options.icon||this.element.data("icon"),this.options.icon&&!/^ui-icon-/.test(this.options.icon)&&(this.options.icons={primary:this.options.icon},this.options.classes={"ui-button-icon":"squirrel-icon"},delete this.options.icon),this.options.text=!1,this._super()},_setOption:function(option,value){"icon"!==option||/^ui-icon-/.test(value)||(option="icons",value={primary:value}),this._super(option,value)}})}(jQuery),/*@preserve Copyright (C) 2015-2018 Crawford Currie http://c-dot.co.uk license MIT*/
function($){$.widget("squirrel.squirrelDialog",$.ui.dialog,{control:function(name){return this.element.find("[data-id='"+name+"']")},open:function(options){var $dlg=this.element;return $dlg.hasClass("dlg-initialised")||($dlg.addClass("dlg-initialised"),this.control("cancel").on($.getTapEvent(),function(){return $dlg.squirrelDialog("close"),!1}),$dlg.trigger("dlg-initialise")),options&&options.$node&&$dlg.data("node",options.$node),$dlg.trigger("dlg-open",options),$.isTouchCapable()&&!this.options.position&&(this.options.position={my:"left top",at:"left top",of:$("body")}),this.options.modal=!0,this.options.width="auto",this.options.closeOnEscape=!1,this._super()}})}(jQuery);/*@preserve Copyright (C) 2017 Crawford Currie http://c-dot.co.uk license MIT*/
const CSSColours={aliceblue:"#F0F8FF",antiquewhite:"#FAEBD7",aqua:"#00FFFF",aquamarine:"#7FFFD4",azure:"#F0FFFF",beige:"#F5F5DC",bisque:"#FFE4C4",black:"#000000",blanchedalmond:"#FFEBCD",blue:"#0000FF",blueviolet:"#8A2BE2",brown:"#A52A2A",burlywood:"#DEB887",cadetblue:"#5F9EA0",chartreuse:"#7FFF00",chocolate:"#D2691E",coral:"#FF7F50",cornflowerblue:"#6495ED",cornsilk:"#FFF8DC",crimson:"#DC143C",cyan:"#00FFFF",darkblue:"#00008B",darkcyan:"#008B8B",darkgoldenrod:"#B8860B",darkgray:"#A9A9A9",darkgrey:"#A9A9A9",darkgreen:"#006400",darkkhaki:"#BDB76B",darkmagenta:"#8B008B",darkolivegreen:"#556B2F",darkorange:"#FF8C00",darkorchid:"#9932CC",darkred:"#8B0000",darksalmon:"#E9967A",darkseagreen:"#8FBC8F",darkslateblue:"#483D8B",darkslategray:"#2F4F4F",darkslategrey:"#2F4F4F",darkturquoise:"#00CED1",darkviolet:"#9400D3",deeppink:"#FF1493",deepskyblue:"#00BFFF",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1E90FF",firebrick:"#B22222",floralwhite:"#FFFAF0",forestgreen:"#228B22",fuchsia:"#FF00FF",gainsboro:"#DCDCDC",ghostwhite:"#F8F8FF",gold:"#FFD700",goldenrod:"#DAA520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#ADFF2F",honeydew:"#F0FFF0",hotpink:"#FF69B4",indianred:"#CD5C5C",indigo:"#4B0082",ivory:"#FFFFF0",khaki:"#F0E68C",lavender:"#E6E6FA",lavenderblush:"#FFF0F5",lawngreen:"#7CFC00",lemonchiffon:"#FFFACD",lightblue:"#ADD8E6",lightcoral:"#F08080",lightcyan:"#E0FFFF",lightgoldenrodyellow:"#FAFAD2",lightgray:"#D3D3D3",lightgrey:"#D3D3D3",lightgreen:"#90EE90",lightpink:"#FFB6C1",lightsalmon:"#FFA07A",lightseagreen:"#20B2AA",lightskyblue:"#87CEFA",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#B0C4DE",lightyellow:"#FFFFE0",lime:"#00FF00",limegreen:"#32CD32",linen:"#FAF0E6",magenta:"#FF00FF",maroon:"#800000",mediumaquamarine:"#66CDAA",mediumblue:"#0000CD",mediumorchid:"#BA55D3",mediumpurple:"#9370DB",mediumseagreen:"#3CB371",mediumslateblue:"#7B68EE",mediumspringgreen:"#00FA9A",mediumturquoise:"#48D1CC",mediumvioletred:"#C71585",midnightblue:"#191970",mintcream:"#F5FFFA",mistyrose:"#FFE4E1",moccasin:"#FFE4B5",navajowhite:"#FFDEAD",navy:"#000080",oldlace:"#FDF5E6",olive:"#808000",olivedrab:"#6B8E23",orange:"#FFA500",orangered:"#FF4500",orchid:"#DA70D6",palegoldenrod:"#EEE8AA",palegreen:"#98FB98",paleturquoise:"#AFEEEE",palevioletred:"#DB7093",papayawhip:"#FFEFD5",peachpuff:"#FFDAB9",peru:"#CD853F",pink:"#FFC0CB",plum:"#DDA0DD",powderblue:"#B0E0E6",purple:"#800080",rebeccapurple:"#663399",red:"#FF0000",rosybrown:"#BC8F8F",royalblue:"#4169E1",saddlebrown:"#8B4513",salmon:"#FA8072",sandybrown:"#F4A460",seagreen:"#2E8B57",seashell:"#FFF5EE",sienna:"#A0522D",silver:"#C0C0C0",skyblue:"#87CEEB",slateblue:"#6A5ACD",slategray:"#708090",slategrey:"#708090",snow:"#FFFAFA",springgreen:"#00FF7F",steelblue:"#4682B4",tan:"#D2B48C",teal:"#008080",thistle:"#D8BFD8",tomato:"#FF6347",turquoise:"#40E0D0",violet:"#EE82EE",wheat:"#F5DEB3",white:"#FFFFFF",whitesmoke:"#F5F5F5",yellow:"#FFFF00",yellowgreen:"#9ACD32"};RGBA.prototype.inverse=function(){return new RGBA(1-this.r,1-this.g,1-this.b,this.a)},RGBA.prototype.complement=function(){var hsv=this.toHSV();return RGBA.fromHSV((hsv[0]+180)%360,hsv[1],hsv[2],this.a)},RGBA.prototype.luma=function(){return.2126*this.r+.7152*this.g+.0722*this.b},RGBA.prototype.toString=function(){var tuple=[Math.round(255*this.r),Math.round(255*this.g),Math.round(255*this.b)];if(void 0!==this.a)return tuple.push(this.a),"rgba("+tuple.join(",")+")";for(var s="#",i=0;i<3;i++){var v=tuple[i].toString(16);s+=1==v.length?"0"+v:v}return s.toUpperCase()},RGBA.prototype.toHSV=function(){var M=Math.max(this.r,this.g,this.b),m=Math.min(this.r,this.g,this.b),C=M-m,V=M,S=0==V?0:C/V,H=0;0!=C&&(H=this.r===M?(this.g-this.b)/C%6*60:this.g===M?60*((this.b-this.r)/C+2):60*((this.r-this.g)/C+4))<0&&(H+=360);var hsv=[H,S,V];return void 0!==this.a&&hsv.push(this.a),hsv},RGBA.prototype.toHSL=function(){var H,S,L,M=Math.max(this.r,this.g,this.b),m=Math.min(this.r,this.g,this.b),C=M-m;0==C?(H=S=0,L=M):(L=(M+m)/2,S=C/(L>.5?2-M-m:M+m)),0!=C&&(H=this.r===M?(this.g-this.b)/C%6*60:this.g===M?60*((this.b-this.r)/C+2):60*((this.r-this.g)/C+4))<0&&(H+=360);var hsl=[H,S,L];return void 0!==this.a&&hsl.push(this.a),hsl},RGBA.fromHSV=function(H,S,V,A){var R,G,B;if(1===arguments.length&&(A=H[3],V=H[2],S=H[1],H=H[0]),0==S)R=G=B=V;else{H/=60;var i=Math.floor(H),f=H-i,p=V*(1-S),q=V*(1-S*f),t=V*(1-S*(1-f));switch(i){case 0:R=V,G=t,B=p;break;case 1:R=q,G=V,B=p;break;case 2:R=p,G=V,B=t;break;case 3:R=p,G=q,B=V;break;case 4:R=t,G=p,B=V;break;default:R=V,G=p,B=q}}return new RGBA(R,G,B,A)},RGBA.fromHSL=function(H,S,L,A){function hue2RGB(p,q,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?p+6*(q-p)*t:t<.5?q:t<2/3?p+(q-p)*(2/3-t)*6:p}var R,G,B;if(1===arguments.length&&(A=H[3],L=H[2],S=H[1],H=H[0]),0==S)R=G=B=L;else{H/=360;var q=L<.5?L*(1+S):L+S-L*S,p=2*L-q;R=hue2RGB(p,q,H+1/3),G=hue2RGB(p,q,H),B=hue2RGB(p,q,H-1/3)}return new RGBA(R,G,B,A)},"undefined"!=typeof module&&(module.exports=RGBA),/*@preserve Copyright (C) 2017 Crawford Currie http://c-dot.co.uk license MIT*/
function($){$.reset_styling=function(){var is_light,$body=$("body"),bgcol=$body.css("background-color");is_light=!(!bgcol||"transparent"===bgcol||"inherit"===bgcol||"initial"===bgcol)&&new RGBA(bgcol).luma()<.65;var $el=$(document.createElement("div")).addClass("ui-widget").addClass("ui-widget-content").hide();$body.append($el),bgcol=$el.css("background-color");var style="body {";for(var attr in{font:0,color:0,"background-color":0}){style+=attr+": "+$el.css(attr)+";\n"}style+="}",$el.remove();var need_light;if(need_light=bgcol&&"transparent"!==bgcol&&"initial"!==bgcol&&"inherit"!==bgcol?new RGBA(bgcol).luma()<.65:is_light,is_light&&!need_light||!is_light&&need_light)for(var i=0;i<document.styleSheets.length;i++){var sheet=document.styleSheets[i];if(sheet){var rules;try{rules=sheet.rules||sheet.cssRules}catch(e){}if(rules)for(var j=0;j<rules.length;j++){var rule=rules[j];if(/\.[-:a-z0-9]*$/i.test(rule.selectorText)){var a,s="";if(rule.style.color)try{a=new RGBA(rule.style.color),s+="color: "+a.inverse().toString()+";\n"}catch(e){global.DEBUG&&console.log(e)}if(rule.style.backgroundColor)try{a=new RGBA(rule.style.backgroundColor),s+="background-color: "+a.inverse().toString()+";\n"}catch(e){global.DEBUG&&console.log(e+":"+rule.style.backgroundColor)}s.length>0&&(style+=rule.selectorText+"{"+s+"}\n")}}}}$("#computed-styles").remove();var $style=$(document.createElement("style")).attr("id","computed-styles").text(style);$body.append($style)}}(jQuery);var Aes={};if(Aes.cipher=function(input,w){for(var Nr=w.length/4-1,state=[[],[],[],[]],i=0;i<16;i++)state[i%4][Math.floor(i/4)]=input[i];state=Aes.addRoundKey(state,w,0,4);for(var round=1;round<Nr;round++)state=Aes.subBytes(state,4),state=Aes.shiftRows(state,4),state=Aes.mixColumns(state,4),state=Aes.addRoundKey(state,w,round,4);state=Aes.subBytes(state,4),state=Aes.shiftRows(state,4),state=Aes.addRoundKey(state,w,Nr,4);for(var output=new Array(16),i=0;i<16;i++)output[i]=state[i%4][Math.floor(i/4)];return output},Aes.keyExpansion=function(key){for(var Nk=key.length/4,Nr=Nk+6,w=new Array(4*(Nr+1)),temp=new Array(4),i=0;i<Nk;i++){var r=[key[4*i],key[4*i+1],key[4*i+2],key[4*i+3]];w[i]=r}for(var i=Nk;i<4*(Nr+1);i++){w[i]=new Array(4);for(var t=0;t<4;t++)temp[t]=w[i-1][t];if(i%Nk==0){temp=Aes.subWord(Aes.rotWord(temp));for(var t=0;t<4;t++)temp[t]^=Aes.rCon[i/Nk][t]}else Nk>6&&i%Nk==4&&(temp=Aes.subWord(temp));for(var t=0;t<4;t++)w[i][t]=w[i-Nk][t]^temp[t]}return w},Aes.subBytes=function(s,Nb){for(var r=0;r<4;r++)for(var c=0;c<Nb;c++)s[r][c]=Aes.sBox[s[r][c]];return s},Aes.shiftRows=function(s,Nb){for(var t=new Array(4),r=1;r<4;r++){for(var c=0;c<4;c++)t[c]=s[r][(c+r)%Nb];for(var c=0;c<4;c++)s[r][c]=t[c]}return s},Aes.mixColumns=function(s,Nb){for(var c=0;c<4;c++){for(var a=new Array(4),b=new Array(4),i=0;i<4;i++)a[i]=s[i][c],b[i]=128&s[i][c]?s[i][c]<<1^283:s[i][c]<<1;s[0][c]=b[0]^a[1]^b[1]^a[2]^a[3],s[1][c]=a[0]^b[1]^a[2]^b[2]^a[3],s[2][c]=a[0]^a[1]^b[2]^a[3]^b[3],s[3][c]=a[0]^b[0]^a[1]^a[2]^b[3]}return s},Aes.addRoundKey=function(state,w,rnd,Nb){for(var r=0;r<4;r++)for(var c=0;c<Nb;c++)state[r][c]^=w[4*rnd+c][r];return state},Aes.subWord=function(w){for(var i=0;i<4;i++)w[i]=Aes.sBox[w[i]];return w},Aes.rotWord=function(w){for(var tmp=w[0],i=0;i<3;i++)w[i]=w[i+1];return w[3]=tmp,w},Aes.sBox=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],Aes.rCon=[[0,0,0,0],[1,0,0,0],[2,0,0,0],[4,0,0,0],[8,0,0,0],[16,0,0,0],[32,0,0,0],[64,0,0,0],[128,0,0,0],[27,0,0,0],[54,0,0,0]],"undefined"!=typeof module&&module.exports&&(module.exports=Aes),"function"==typeof define&&define.amd&&define([],function(){return Aes}),void 0===global)var global={};global.DEBUG=!1;var Utils={waiting_for_sometime:{},sometime_timeout:!0,last_yield:Date.now(),IMMEDIATE:1,SOON:50,SOMETIME:250,MSPERDAY:864e5,TIMEUNITS:{y:{days:360,ms:314496e5,format:"$1 year$?($1!=1,s,)"},m:{days:30,ms:2592e6,format:"$1 month$?($1!=1,s,)"},d:{days:1,ms:864e5,format:"$1 day$?($1!=1,s,)"}}};Utils.setUpAjax=function(options,originalOptions,jqXHR){if(window.FormData&&(options.dataType&&"binary"===options.dataType||options.data&&(window.ArrayBuffer&&options.data instanceof ArrayBuffer||window.Blob&&options.data instanceof Blob)))return{send:function(headers,callback){var xhr=new XMLHttpRequest,url=options.url,type=options.type,async=options.async||!0,dataType=options.responseType||"blob",data=options.data||null,username=options.username||null,password=options.password||null;xhr.addEventListener("load",function(){var data2={};data2[options.dataType]=xhr.response,callback(xhr.status,xhr.statusText,data2,xhr.getAllResponseHeaders())}),xhr.open(type,url,async,username,password);for(var i in headers)xhr.setRequestHeader(i,headers[i]);xhr.responseType=dataType,xhr.send(data)},abort:function(){jqXHR.abort()}}},"undefined"!=typeof jQuery&&jQuery.ajaxTransport("+binary",Utils.setUpAjax),Utils.generate_password=function(constraints){var sor,eor;void 0===constraints.length&&(constraints.length=24),void 0===constraints.charset&&(constraints.charset="A-Za-z0-9");for(var cs=constraints.charset,legal=[];cs.length>0;)if(cs.length>=3&&"-"===cs.charAt(1))for(sor=cs.charCodeAt(0),eor=cs.charCodeAt(2),cs=cs.substring(3);sor<=eor;)legal.push(String.fromCharCode(sor++));else legal.push(cs.charAt(0)),cs=cs.substring(1);var array=new Uint8Array(constraints.length);window.crypto.getRandomValues(array);for(var s="",i=0;i<constraints.length;i++)s+=legal[array[i]%legal.length];return s},Utils.sometime=function(event){Utils.waiting_for_sometime[event]||(Utils.waiting_for_sometime[event]=!0,null===Utils.sometime_timeout&&(Utils.sometime_timeout=window.setTimeout(Utils.sometime_is_now,Utils.SOMETIME)))},Utils.sometime_is_now=function(){Utils.sometime_timeout=null,Utils.last_yield=Date.now();for(var event in Utils.waiting_for_sometime)$(document).triggerHandler(event),delete Utils.waiting_for_sometime[event]},Utils.soon=function(fn){Date.now()-Utils.last_yield>Utils.SOON?window.setTimeout(function(){Utils.last_yield=Date.now(),fn()},Utils.IMMEDIATE):fn()},Utils.execute_queue=function(q){function q_ready(){qready=!0}function q_next(q){if(q.length>0&&qready){var fn=q.shift();qready=!1,fn(q_ready)}window?window.setTimeout(function(){Utils.last_yield=Date.now(),q_next(q)},Utils.IMMEDIATE):q_next(q)}var qready=!0;q_next(q)},Utils.load=function(libs,onload,onfail){function _done(file){delete expect[file],0===Object.keys(expect).length&&(Object.keys(failed).length>0?"function"==typeof onfail&&onfail(failed):"function"==typeof onload&&onload())}function _failed(file,mess){failed[file]=mess,_done(file)}var expect={},failed={};if(0===libs.length)return void onload();for(var i=0;i<libs.length;i++)!function(file){expect[file]=!0,/\.js$/.test(file)?$.getScript(file).done(function(){_done(file)}).fail(function(jqxhr,settings,exception){_failed(file,exception)}):/\.css$/.test(file)?($("link").appendTo("head").attr({type:"text/css",rel:"stylesheet"}).attr("href",file),_done(file)):/\.html$/.test(file)&&$.get(file).done(function(data){$(data).appendTo("body"),_done(file)}).fail(function(jqXHR,textStatus,errorThrown){_failed(file,errorThrown)})}(libs[i])},Utils.read_file=function(file,ok,fail,mode){var reader=new FileReader;if(reader.onload=function(){ok(reader.result)},reader.onerror=function(){fail(file.name+" read failed")},reader.onabort=reader.onerror,void 0===mode||"text"===mode)reader.readAsText(file);else if("arraybuffer"===mode)reader.readAsArrayBuffer(file);else if("binarystring"===mode)reader.readAsBinaryString(file);else{if("datauri"!==mode)throw"Unrecognised mode "+mode;reader.readAsDataURL(file)}},Utils.ArrayBufferToString=function(ab){if(global.DEBUG&&ab.byteLength%2!=0)throw"Internal error";for(var a8=new Uint8Array(ab),str="",i=0;i<a8.length;i+=2)str+=String.fromCharCode(a8[i+1]<<8||a8[i]);return str},Utils.StringToArrayBuffer=function(str){for(var a16=new Uint16Array(str.length),i=0,strLen=str.length;i<strLen;i++)a16[i]=str.charCodeAt(i);return a16.buffer},Utils.ArrayBufferToPackedString=function(ab){for(var a8=new Uint8Array(ab),cc=0!=(1&a8.length)?256:0,high=!0,ps="",a8_len=a8.length,i=0;i<a8_len;i++)high?(ps+=String.fromCharCode(cc|a8[i]),high=!1):(cc=a8[i]<<8,high=!0);return high&&(ps+=String.fromCharCode(cc)),ps},Utils.PackedStringToArrayBuffer=function(str){var datalen=2*str.length-1;0==(256&str.charCodeAt(0))&&datalen--;for(var high=!0,a8=new Uint8Array(datalen),i=0,j=0;j<datalen;)high?(a8[j++]|=255&str.charCodeAt(i++),high=!1):(a8[j++]=str.charCodeAt(i)>>8&255,high=!0);return a8.buffer},Utils.ArrayBufferToBase64=function(ab){for(var a8=new Uint8Array(ab),nMod3=2,sB64Enc="",nLen=a8.length,uint6ToB64=function(nUInt6){return nUInt6<26?nUInt6+65:nUInt6<52?nUInt6+71:nUInt6<62?nUInt6-4:62===nUInt6?43:63===nUInt6?47:65},nUInt24=0,nIdx=0;nIdx<nLen;nIdx++)nMod3=nIdx%3,nUInt24|=a8[nIdx]<<(16>>>nMod3&24),2!==nMod3&&nLen-nIdx!=1||(sB64Enc+=String.fromCharCode(uint6ToB64(nUInt24>>>18&63),uint6ToB64(nUInt24>>>12&63),uint6ToB64(nUInt24>>>6&63),uint6ToB64(63&nUInt24)),nUInt24=0);return sB64Enc.substr(0,sB64Enc.length-2+nMod3)+(2===nMod3?"":1===nMod3?"=":"==")},Utils.Base64ToArrayBuffer=function(sB64){for(var nMod3,nMod4,sB64Enc=sB64.replace(/[^A-Za-z0-9+\/]/g,""),nInLen=sB64Enc.length,nOutLen=3*nInLen+1>>2,ta8=new Uint8Array(nOutLen),nUInt24=0,nOutIdx=0,nInIdx=0;nInIdx<nInLen;nInIdx++)if(nMod4=3&nInIdx,nUInt24|=function(nChr){return nChr>64&&nChr<91?nChr-65:nChr>96&&nChr<123?nChr-71:nChr>47&&nChr<58?nChr+4:43===nChr?62:47===nChr?63:0}(sB64Enc.charCodeAt(nInIdx))<<6*(3-nMod4),3===nMod4||nInLen-nInIdx==1){for(nMod3=0;nMod3<3&&nOutIdx<nOutLen;nMod3++,nOutIdx++)ta8[nOutIdx]=nUInt24>>>(16>>>nMod3&24)&255;nUInt24=0}return ta8.buffer},Utils.parse_query_params=function(){for(var vars=window.location.search.substring(1).split(/[&;]+/),query={},i=0;i<vars.length;i++)if(""!==vars[i]){var ass=vars[i].split("=");if(void 0===query[ass[0]])query[ass[0]]=decodeURIComponent(ass[1]);else if("string"==typeof query[ass[0]]){var arr=[query[ass[0]],decodeURIComponent(ass[1])];query[ass[0]]=arr}else query[ass[0]].push(decodeURIComponent(ass[1]))}return query},Utils.deltaTimeString=function(date){date=new Date(date.getTime()-Date.now());var s=[],delta=date.getUTCFullYear()-1970;return delta>0&&s.push(TX.tx(Utils.TIMEUNITS.y.format,delta)),date.setUTCFullYear(1970),delta=date.getUTCMonth(),delta>0&&s.push(TX.tx(Utils.TIMEUNITS.m.format,delta)),date.setUTCMonth(0),delta=date.getUTCDate(),(delta>0||0===s.length)&&s.push(TX.tx(Utils.TIMEUNITS.d.format,delta)),s.join(" ")},Utils.expandTemplate=function(){var tmpl=arguments[0],args=arguments;return tmpl=tmpl.replace(/\$(\d+)/g,function(m,p1){var i=parseInt(p1);return args[i]}),tmpl=tmpl.replace(/\$\?\((.*?),(.*?),(.*?)\)/g,function(m,test,pass,fail){var result=!1;return eval("result=("+test+")"),result?pass:fail})},"undefined"!=typeof module&&(module.exports=Utils);/*@preserve Copyright (C) 2015-2017 Crawford Currie http://c-dot.co.uk license MIT*/
var TX={lingo:void 0,originals:void 0,language:function(code){var old=TX.lingo;return void 0!==code?(TX.lingo=code,Cookies.set("ui_lang",code,{expires:365})):old||(TX.lingo=Cookies.get("ui_lang")||window.navigator.userLanguage||window.navigator.language||"en"),old},translations:null,clean:function(s){return s.replace(/\s+/g," ").replace(/^ /,"").replace(/ $/,"")},init:function(tx_ready,tx_fail){if(TX.lingo||TX.language(),/^en(\b|$)/i.test(TX.lingo))return global.DEBUG&&console.debug("Using language 'en'"),TX.originals&&($("body").each(function(){TX.translateDOM(this,function(s){return s})}),TX.originals=void 0),void(tx_ready&&tx_ready());TX.originals=new WeakMap,$.ajax("locale/"+TX.lingo+".json",{success:function(data){TX.translations=data,$("body").each(function(){TX.translateDOM(this,function(s){var tx=TX.translations[TX.clean(s)];return void 0!==tx?tx.s:s})}),global.DEBUG&&console.debug("Using language '"+TX.lingo+"'"),tx_ready&&tx_ready()},error:function(a,b,c){var m=/^(.+)-.+/.exec(TX.lingo);global.DEBUG&&console.debug("Failed to load locale/"+TX.lingo+".json: "+c.message),tx_fail&&tx_fail("Failed to load locale/"+TX.lingo+".json: "+c.message),TX.lingo=m?m[1]:"en",TX.init(tx_ready)}})},translateDOM:function(node,translate,translating){function hasClass(element,thatClass){return(" "+element.className+" ").replace(/\s+/g," ").indexOf(" "+thatClass+" ")>=0}var t,attrs;if(TX.originals||(TX.originals=new WeakMap),TX.originals.has(node)?attrs=TX.originals.get(node):TX.originals.set(node,attrs={}),3==node.nodeType)translating&&/\S/.test(node.nodeValue)&&(t=attrs.text,void 0===t&&(attrs.text=t=node.nodeValue),t&&(t=translate(t))&&(node.nodeValue=t));else if((translating||hasClass(node,"TX_title"))&&(t=attrs.title,void 0===t&&(attrs.title=t=node.title),t&&void 0!==(t=translate(t))&&(node.title=t)),hasClass(node,"TX_html"))t=attrs.html,void 0===t&&(attrs.html=t=node.innerHTML),t&&(t=translate(t))&&(node.innerHTML=t);else{hasClass(node,"TX_text")&&(translating=!0);for(var i=0,len=node.childNodes.length;i<len;++i)TX.translateDOM(node.childNodes[i],translate,translating)}},tx:function(){var tx;return null!==TX.translations&&void 0!==(tx=TX.translations[TX.clean(arguments[0])])&&(arguments[0]=tx.s),/\$/.test(arguments[0])?Utils.expandTemplate.apply(null,arguments):arguments[0]}};/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
if("undefined"!=typeof module&&(module.exports=TX),/*@preserve Copyright (C) 2017 Crawford Currie http://c-dot.co.uk license MIT*/
function($){$.widget("squirrel.twisted",{_create:function(){function handleTap(){$container.hasClass("twisted-shut")?self.open():self.close()}var self=this,$container=self.element,$button=$(document.createElement("button")).addClass("twisted-button twisted-title").iconbutton({icon:"ui-icon-info",showLabel:!1});0===$container.children(".twisted-title").first().detach().insertBefore($container).prepend($button).on("click",handleTap).length&&$button.insertBefore($container).on("click",handleTap),$container.data("twisted-button",$button),self.close()},open:function(){var icon=this.element.data("close")||"ui-icon-circle-minus";this.element.removeClass("twisted-shut").show().data("twisted-button").iconbutton("option","icon",icon)},close:function(){var icon=this.element.data("open")||"ui-icon-circle-plus";this.element.addClass("twisted-shut").hide().data("twisted-button").iconbutton("option","icon",icon)}})}(jQuery),/*@preserve Copyright (C) 2017 Crawford Currie http://c-dot.co.uk license MIT*/
"undefined"!=typeof module&&(Utils=require("./Utils")),function($){$.widget("squirrel.template",{_create:function(){this.element.hasClass("pick-one")&&this.element.children().hide().first().show()},pick:function(id){this.element.children().hide();var $picked=this.element.children("[data-id='"+id+"']");return $picked.show(),$picked},expand:function(){var tmpl=this.element.data("raw-template");tmpl||this.element.data("raw-template",tmpl=this.element.html());for(var args=[tmpl],i=0;i<arguments.length;i++)args.push(arguments[i]);tmpl=Utils.expandTemplate.apply(null,args),this.element.html(tmpl)}})}(jQuery),"undefined"!=typeof module)var Utils=require("./Utils");/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
if(AbstractStore.NODATA="not found",AbstractStore.prototype.options=function(){return{identifier:"Unknown"}},AbstractStore.prototype.user=function(user){return void 0!==user&&(this.suser=user),this.suser},AbstractStore.prototype.pass=function(pass){return 1===arguments.length&&void 0!==pass&&(this.spass=pass),this.spass},AbstractStore.prototype.write=function(path,data,ok,fail){fail.call(this,"Store has no write method")},AbstractStore.prototype.writes=function(path,str,ok,fail){this.write(path,Utils.StringToArrayBuffer(str),ok,fail)},AbstractStore.prototype.read=function(path,ok,fail){fail.call(this,"Store has no read method")},AbstractStore.prototype.reads=function(path,ok,fail){var self=this;this.read(path,function(ab){var data;try{data=Utils.ArrayBufferToString(ab)}catch(e){return global.DEBUG&&console.debug("Caught "+e),void fail.call(self,e)}ok.call(self,data)},fail)},"undefined"!=typeof module&&(module.exports=AbstractStore),"undefined"!=typeof module)var AbstractStore=require("./AbstractStore");/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
if(LayeredStore.prototype=Object.create(AbstractStore.prototype),LayeredStore.prototype.options=function(){return this.engine.options()},LayeredStore.prototype.user=function(u){return this.engine.user(u)},LayeredStore.prototype.pass=function(pw){return this.engine.pass(pw)},"undefined"!=typeof module&&(module.exports=LayeredStore),"undefined"!=typeof module)var AbstractStore=require("./AbstractStore");global.CLOUD_STORE=LocalStorageStore,LocalStorageStore.prototype=Object.create(AbstractStore.prototype),LocalStorageStore.prototype.options=function(){return $.extend(AbstractStore.prototype.options(),{needs_path:!0,identifier:"browser"})},LocalStorageStore.prototype.read=function(path,ok,fail){var str;global.DEBUG&&console.debug("LocalStorageStore: Reading "+path);try{str=localStorage.getItem(path)}catch(e){return global.DEBUG&&console.debug("Caught "+e),void fail.call(this,e)}if(null===str)fail.call(this,AbstractStore.NODATA);else{var data=Utils.PackedStringToArrayBuffer(str);ok.call(this,data)}},LocalStorageStore.prototype.write=function(path,data,ok,fail){global.DEBUG&&console.debug("LocalStorageStore: Writing "+path);try{var str=Utils.ArrayBufferToPackedString(data);localStorage.setItem(path,str)}catch(e){return global.DEBUG&&console.debug("Caught "+e),void fail.call(this,e)}ok.call(this)},"undefined"!=typeof module&&(module.exports=LocalStorageStore),/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
"undefined"!=typeof module&&(Aes=require("../libs/aes"));var AES={};/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
if(AES.encrypt=function(ab,password,nBits){for(var plaintext=new Uint8Array(ab),nBytes=nBits/8,pwBytes=new Array(nBytes),i=0;i<nBytes;i++)i<password.length?pwBytes[i]=255&password.charCodeAt(i):pwBytes[i]=0;var key=Aes.cipher(pwBytes,Aes.keyExpansion(pwBytes));key=key.concat(key.slice(0,nBytes-16));var counterBlock=new Uint8Array(8),size=8,nonce=Date.now(),nonceMs=nonce%1e3,nonceSec=nonce/1e3>>0,nonceRnd=65535*Math.random()>>0;for(i=0;i<2;i++)counterBlock[i]=nonceMs>>>8*i&255;for(i=0;i<2;i++)counterBlock[i+2]=nonceRnd>>>8*i&255;for(i=0;i<4;i++)counterBlock[i+4]=nonceSec>>>8*i&255;for(var keySchedule=Aes.keyExpansion(key),blockCount=Math.ceil(plaintext.length/16),ciphertxt=new Array(blockCount),b=0;b<blockCount;b++){for(var c=0;c<4;c++)counterBlock[15-c]=b>>>8*c&255;for(c=0;c<4;c++)counterBlock[15-c-4]=b/4294967296>>>8*c;var cipherCntr=Aes.cipher(counterBlock,keySchedule),blockLength=b<blockCount-1?16:(plaintext.length-1)%16+1,cipherChar=new Uint8Array(blockLength);for(size+=blockLength,i=0;i<blockLength;i++)cipherCntr[i],cipherChar[i]=cipherCntr[i]^plaintext[16*b+i];ciphertxt[b]=cipherChar}var ct=new Uint8Array(size);ct.set(counterBlock);var offset=counterBlock.length;for(b=0;b<blockCount;b++)ct.set(ciphertxt[b],offset),offset+=ciphertxt[b].length;return ct},AES.decrypt=function(ab,password,nBits){for(var ciphertext=new Uint8Array(ab),nBytes=nBits/8,pwBytes=new Uint8Array(nBytes),i=0;i<nBytes;i++)i<password.length?pwBytes[i]=255&password.charCodeAt(i):pwBytes[i]=0;var key=Aes.cipher(pwBytes,Aes.keyExpansion(pwBytes));key=key.concat(key.slice(0,nBytes-16));var counterBlock=new Uint8Array(8);for(i=0;i<8;i++)counterBlock[i]=ciphertext[i];for(var keySchedule=Aes.keyExpansion(key),nBlocks=Math.ceil((ciphertext.length-8)/16),ct=new Array(nBlocks),offset=8,b=0;b<nBlocks;b++)ct[b]=ciphertext.subarray(offset,offset+16),offset+=16;var plaintxt=new Array(nBlocks),size=0;for(b=0;b<nBlocks;b++){for(var c=0;c<4;c++)counterBlock[15-c]=b>>>8*c&255;for(c=0;c<4;c++)counterBlock[15-c-4]=(b+1)/4294967296-1>>>8*c&255;var cipherCntr=Aes.cipher(counterBlock,keySchedule),blen=ct[b].length,plaintxtByte=new Uint8Array(blen);for(i=0;i<blen;i++)plaintxtByte[i]=cipherCntr[i]^ct[b][i];plaintxt[b]=plaintxtByte,size+=blen}var pt=new Uint8Array(size);for(offset=0,b=0;b<nBlocks;b++)pt.set(plaintxt[b],offset),offset+=plaintxt[b].length;return pt.buffer},"undefined"!=typeof module&&(module.exports=AES),"undefined"!=typeof module)var LayeredStore=require("./LayeredStore");EncryptedStore.prototype=Object.create(LayeredStore.prototype),EncryptedStore.prototype.options=function(){return $.extend(LayeredStore.prototype.options.call(this),{needs_pass:!0})},EncryptedStore.prototype.read=function(path,ok,fail){var self=this;global.DEBUG&&console.debug("EncryptedStore: reading "+path+" with password "+self.engine.pass()),this.engine.read(path,function(ab){var data;try{global.DEBUG&&console.debug("EncryptedStore: decrypting using password "+self.engine.pass()),data=AES.decrypt(ab,self.engine.pass(),256)}catch(e){return global.DEBUG&&console.debug("Caught "+e),void fail.call(self,e)}ok.call(self,data)},fail)},EncryptedStore.prototype.write=function(path,ab,ok,fail){var self=this;global.DEBUG&&console.debug("EncryptedStore: writing "+path+" with password "+self.engine.pass());var xa;try{xa=AES.encrypt(ab,this.engine.pass(),256)}catch(e){return global.DEBUG&&console.debug("Caught "+e),void fail.call(this,e)}this.engine.write(path,xa.buffer,function(){ok.call(self)},fail)},"undefined"!=typeof module&&(module.exports=EncryptedStore);/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
const VERSION=2;"undefined"!=typeof module&&(TX=require("./Translation")),Hoard.stringify_action=function(action){return action.type+":"+action.path.join("↘")+(void 0!==action.data?" '"+action.data+"'":"")+" @"+new Date(action.time).toLocaleString()},global.DEBUG&&(Hoard.prototype.dump=function(){for(var data=this.JSON()+"\n",i=0;i<this.actions.length;i++)data=data+Hoard.stringify_action(this.actions[i])+"\n";return data}),Hoard.prototype.clear_actions=function(){this.actions=[]},Hoard.new_action=function(){var type,path,data,time;if("string"==typeof arguments[0])type=arguments[0],path=arguments[1],time=arguments[2],data=arguments[3];else{var e=arguments[0];type=e.type,path=e.path,time=e.time,data=e.data}var n={type:type,path:path.slice(),time:time||Date.now()};return void 0!==data&&(n.data=data),n},Hoard.prototype.push_action=function(){var copy=Hoard.new_action.apply(this,arguments);return this.actions.push(copy),copy},Hoard.prototype.pop_action=function(){if(global.DEBUG&&0===this.actions.length)throw this.name+" hoard error: Cannot pop from empty actions stream";return this.actions.pop()},Hoard.prototype.locate_node=function(path,offset){var node=this.cache;offset=offset||0;for(var i=0;i<path.length-offset;i++){var name=path[i];if(node&&"string"==typeof node.data)throw this.name+" hoard error: Cannot recurse into leaf node";if(!node||!node.data[name])return;node=node.data[name]}return node},Hoard.prototype.play_action=function(e,listener){function conflict(e,mess){return{conflict:e,message:TX.tx("Cannot ")+{A:TX.tx("add reminder to"),C:TX.tx("cancel reminder"),D:TX.tx("delete"),E:TX.tx("change value of"),M:TX.tx("move"),N:TX.tx("create"),R:TX.tx("rename"),X:TX.tx("constrain")}[e.type]+" '"+e.path.join("↘")+"': "+mess}}if(e.time||(e.time=Date.now()),0===e.path.length)return conflict(e,"Zero length path");this.cache||(this.cache={data:{}});var parent=this.locate_node(e.path,1);if(!parent)return conflict(e,TX.tx("Parent folder not found"));var name=e.path[e.path.length-1],node=parent.data[name];if("N"===e.type){if(node)return conflict(e,TX.tx("It already exists")+" @"+new Date(node.time));parent.time=e.time,parent.data[name]={time:e.time,data:"string"==typeof e.data?e.data:{}}}else{if(!node)return conflict(e,TX.tx("It does not exist"));switch(e.type){case"M":var new_parent=this.locate_node(e.data);if(!new_parent)return conflict(TX.tx("New folder '$1' does not exist",e.data.join("↘")));new_parent.time=parent.time=e.time,delete parent.data[name],new_parent.data[name]=node;break;case"D":delete parent.data[name],parent.time=e.time;break;case"R":if(parent.data[e.data])return conflict(e," '"+e.data+"': "+TX.tx("It already exists"));parent.data[e.data]=node,delete parent.data[name],parent.time=e.time;break;case"E":node.data=e.data,node.time=e.time;break;case"A":e.data?node.alarm=e.data:delete node.alarm,node.time=e.time;break;case"C":if(!node)return conflict(e,TX.tx("It does not exist"));delete node.alarm,node.time=e.time;break;case"X":if(!node)return conflict(e,TX.tx("It does not exist"));e.data?node.constraints=e.data:delete node.constraints,node.time=e.time;break;default:global.DEBUG}}return listener&&listener.call(this,e),null},Hoard.prototype.merge_actions=function(actions){var etop=0,added=0;actions.sort(function(a,b){return a.time<b.time?-1:a.time>b.time?1:0});for(var ntop=0;ntop<actions.length;ntop++){var na=actions[ntop];if(ntop>0&&na.time<actions[ntop-1].time)throw this.name+" hoard; merged action stream is out of order";for(;etop<this.actions.length&&this.actions[etop].time<na.time;)etop++;if(etop<this.actions.length){var ea=this.actions[etop];if(na.time==ea.time&&na.type==ea.type&&na.path.join("/")==ea.path.join("/")&&na.data==ea.data)continue}this.actions.splice(etop,0,Hoard.new_action(na)),added++}return added},Hoard.prototype._reconstruct_actions=function(data,path,reconstruct,progress,chain){function handle_node(node,p,ready){if(0===p.length)return void ready();var time=void 0!==node.time?node.time:Date.now(),action=Hoard.new_action("N",p,time);"string"==typeof node.data?action.data=node.data:global.DEBUG&&node.data,reconstruct.call(self,action,function(){node.alarm&&reconstruct.call(self,Hoard.new_action("A",p,time,node.alarm)),node.constraints&&reconstruct.call(self,Hoard.new_action("X",p,time,node.constraints)),ready()})}function list_nodes(q,node,pat){var key,p;if(q.push(function(ready){handle_node(node,pat,ready),progress&&progress(Math.floor(100*counter++/count))}),"object"==typeof node.data)for(key in node.data)p=pat.slice(),p.push(key),list_nodes(q,node.data[key],p)}var count,counter,self=this,queue=[];list_nodes(queue,data,path.slice()),count=queue.length,counter=0,chain&&queue.push(function(ready){chain(),ready()}),Utils.execute_queue(queue)},Hoard.prototype.actions_from_hierarchy=function(data,reconstruct,progress,chain){this._reconstruct_actions(data,[],reconstruct,progress,chain)},Hoard.prototype.reconstruct_actions=function(reconstruct,progress,chain){this.cache?this._reconstruct_actions(this.cache,[],reconstruct,progress,chain):chain()},Hoard.prototype.play_actions=function(new_actions,listener,progress){var i,c,conflicts=[],count=new_actions.length;for(global.DEBUG&&console.log("Playing new actions since "+new Date(this.last_sync).toLocaleString()),i=0;i<count;i++)new_actions[i].time>this.last_sync?(global.DEBUG&&console.log("Play "+Hoard.stringify_action(new_actions[i])),(c=this.play_action(new_actions[i],listener))&&(global.DEBUG&&console.log("Conflict: "+c.message),conflicts.push(c))):global.DEBUG&&console.log("Skip old "+Hoard.stringify_action(new_actions[i])),progress&&progress(Math.floor(100*i/count));return this.last_sync=Date.now(),conflicts},Hoard.prototype.get_node=function(path){var i,node=this.cache;for(i=0;i<path.length;i++){if("string"==typeof node.data)return null;node=node.data[path[i]]}return node},Hoard.prototype.each_alarm=function(){for(var self=this,alarum=function(){self.each_alarm()};this.check&&this.check.queue.length>0;){var name,item=this.check.queue.pop(),node=item.node;if("object"==typeof node.data)for(name in node.data){var snode=node.data[name];this.check.queue.push({node:snode,path:item.path.slice().concat([name])})}if(void 0!==node.alarm&&Date.now()-node.time>=node.alarm*Utils.MSPERDAY)return void this.check.alarm(item.path,new Date(node.time+node.alarm*Utils.MSPERDAY),alarum)}delete this.check},Hoard.prototype.check_alarms=function(callback){this.cache&&(this.check={queue:[{path:[],node:this.cache}],alarm:callback},this.each_alarm())},Hoard.prototype.JSON=function(){var data="";return this.cache&&(data=JSON.stringify(this.cache.data,null,"\t")),data},"undefined"!=typeof module&&(module.exports=Hoard),/*@preserve Copyright (C) 2015-2018 Crawford Currie http://c-dot.co.uk license MIT*/
function($){$(function(){function constraints_changed($dlg){var $node=$dlg.data("node"),nc=$node.data("constraints");nc=void 0!==nc?nc.split(/;/,2):[DEFAULT_RANDOM_LEN,DEFAULT_RANDOM_CHS];var dlg_l=$dlg.squirrelDialog("control","len").val(),dlg_c=$dlg.squirrelDialog("control","chs").val();dlg_l!=nc[0]||dlg_c!=nc[1]?$dlg.squirrelDialog("control","remember").show():$dlg.squirrelDialog("control","remember").hide(),dlg_l!==DEFAULT_RANDOM_LEN||dlg_c!==DEFAULT_RANDOM_CHS?$dlg.squirrelDialog("control","reset").show():$dlg.squirrelDialog("control","reset").hide(),$dlg.squirrelDialog("control","again").trigger($.getTapEvent())}function reset_constraints($dlg){$dlg.squirrelDialog("control","len").val(DEFAULT_RANDOM_LEN),$dlg.squirrelDialog("control","chs").val(DEFAULT_RANDOM_CHS),constraints_changed($dlg)}function _updateNext($dlg){var numb=$dlg.squirrelDialog("control","number").val();numb*=Utils.TIMEUNITS[$dlg.squirrelDialog("control","units").val()].days;var alarmd=new Date(Date.now()+numb*Utils.MSPERDAY);$dlg.squirrelDialog("control","nextmod").template("expand",Utils.deltaTimeString(alarmd),alarmd.toLocaleDateString())}function _changeImage($dlg){var fail=function(e){$dlg.squirrelDialog("control","message").template("pick","cui").template("expand",e)},file=$dlg.squirrelDialog("control","file")[0].files[0];Utils.read_file(file,function(data){(data="data:"+file.type+";base64,"+Utils.ArrayBufferToBase64(data))!==$dlg.squirrelDialog("control","steg_image").attr("src",data)&&$dlg.squirrelDialog("control","steg_image").attr("src",data).off("load").on("load",function(){$(this).off("load");var steg=new Steganographer(this);try{steg.inject("tada")}catch(e){return global.DEBUG&&console.debug("Caught "+e),void fail(e)}$dlg.squirrelDialog("control","ok").iconbutton("enable");var h=this.naturalHeight,w=this.naturalWidth;this.height=100,$dlg.squirrelDialog("control","message").template("pick","xbyy").template("expand",w,h),Squirrel.getClient().status===Squirrel.IS_LOADED&&(Squirrel.getClient().status=Squirrel.NEW_SETTINGS),Squirrel.getCloud().status===Squirrel.IS_LOADED&&(Squirrel.getCloud().status=Squirrel.NEW_SETTINGS),Utils.sometime("update_save")})},fail,"arraybuffer")}function _validateUniqueKey($dlg){var $input=$dlg.squirrelDialog("control","key"),val=$input.val(),enabled=!0;if(/\S/.test(val)){$dlg.data("parent").find("ul").first().children(".tree-node").each(function(){if(0==Squirrel.compare($(this).data("key"),val))return enabled=!1,!1})}else enabled=!1;enabled?($dlg.squirrelDialog("control","ok").iconbutton("enable"),$input.removeClass("dlg-disabled").attr("title",TX.tx("Enter new name"))):($dlg.squirrelDialog("control","ok").iconbutton("disable"),$input.addClass("dlg-disabled").attr("title",TX.tx("Name is already in use")))}$("#login_dlg").on("dlg-open",function(e,options){var $dlg=$(this);$dlg.squirrelDialog("control","uReq").toggle(options.user_required),$dlg.squirrelDialog("control","pReq").toggle(options.pass_required);var $user=$dlg.squirrelDialog("control","user"),$pass=$dlg.squirrelDialog("control","pass"),$signin=$dlg.squirrelDialog("control","signin"),sign_in=function(){return $dlg.squirrelDialog("close"),$signin.off($.getTapEvent()),$user.off("change"),$pass.off("change"),options.on_signin.call(options.store,$user.val(),$pass.data("hidden_pass")),!0};$signin.off($.getTapEvent()).on($.getTapEvent(),sign_in),$user.off("change").val(options.store.user()),$pass.off("change").val(options.store.pass()),options.user_required&&($user.attr("autofocus","autofocus"),options.pass_required?$user.off("change").on("change",function(){$pass.focus()}):$user.off("change").on("change",sign_in),$user.focus()),options.pass_required&&($dlg.squirrelDialog("control","foruser").toggle(null!==options.store.user()).text(options.store.user()||""),$pass.attr("autofocus","autofocus"),options.user_required?$pass.on("change",function(){$signin.focus()}):($pass.focus(),$pass.on("change",function(){return sign_in()})))}),$("#delete_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","ok").on($.getTapEvent(),function(){return $dlg.squirrelDialog("close"),Squirrel.playAction(Hoard.new_action("D",$dlg.data("node").tree("getPath"),Date.now())),!0}),$dlg.squirrelDialog("control","cancel").on($.getTapEvent(),function(){return $dlg.squirrelDialog("close"),!1})}).on("dlg-open",function(){var $dlg=$(this);$dlg.squirrelDialog("control","path").text($dlg.data("node").tree("getPath").join("↘")),$dlg.squirrelDialog("control","coll").toggle(!$dlg.data("node").hasClass("tree-leaf"))}),$("#pick_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","clear").on($.getTapEvent(),function(){$dlg.find(".dlg-picked").removeClass("dlg-picked")})}).on("dlg-open",function(){var i,$f,$dlg=$(this),$node=$dlg.data("node"),val=$node.data("value"),$which=$dlg.squirrelDialog("control","which"),$from=$dlg.squirrelDialog("control","from");$dlg.find(".dlg-pick-cell").remove();var item_clicked=function(){var ii=$(this).data("i");$dlg.find("td.i"+ii).addClass("dlg-picked")};for(i=0;i<val.length;i++)$f=$from.children("td.i"+i),0===$f.length&&($(document.createElement("td")).data("i",i).addClass("dlg-pick-cell i"+i).text(i+1).on($.getTapEvent(),item_clicked).appendTo($which),$f=$(document.createElement("td")).data("i",i).addClass("dlg-pick-cell i"+i).on($.getTapEvent(),item_clicked).appendTo($from)),$f.text(val.charAt(i));for(;i<$from.children("td").length;)$from.children("td").last().remove(),i++;$dlg.find(".dlg-picked").removeClass("dlg-picked")});const DEFAULT_RANDOM_LEN=30,DEFAULT_RANDOM_CHS="A-Za-z0-9!%^&*_$+-=;:@#~,./?";$("#randomise_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","again").on($.getTapEvent(),function(){return $dlg.squirrelDialog("control","idea").text(Utils.generate_password({length:$dlg.squirrelDialog("control","len").val(),charset:$dlg.squirrelDialog("control","chs").val()})),!1}),$dlg.squirrelDialog("control","use").on($.getTapEvent(),function(){return $dlg.squirrelDialog("close"),Squirrel.playAction(Hoard.new_action("E",$dlg.data("node").tree("getPath"),Date.now(),$dlg.squirrelDialog("control","idea").text())),!0}),$dlg.squirrelDialog("control","len").on("change",function(){constraints_changed($dlg)}),$dlg.squirrelDialog("control","chs").on("change",function(){constraints_changed($dlg)}),$dlg.squirrelDialog("control","remember").on($.getTapEvent(),function(){Squirrel.playAction(Hoard.new_action("X",$dlg.data("node").tree("getPath"),Date.now(),$dlg.squirrelDialog("control","len").val()+";"+$dlg.squirrelDialog("control","chs").val())),constraints_changed($dlg)}),$dlg.squirrelDialog("control","reset").on($.getTapEvent(),function(){reset_constraints($dlg)})}),$("#randomise_dlg").on("dlg-open",function(){var $dlg=$(this),$node=$dlg.data("node"),my_key=$node.data("key"),c=$node.data("constraints");c&&(c=c.split(";",2),$dlg.squirrelDialog("control","len").val(c[0]),$dlg.squirrelDialog("control","chs").val(c[1]));var path=$node.tree("getPath");$dlg.squirrelDialog("control","path").text(path.join("↘")),$dlg.squirrelDialog("control","key").text(my_key),$dlg.squirrelDialog("control","again").trigger($.getTapEvent()),$dlg.squirrelDialog("control","remember").hide(),constraints_changed($dlg)}),$("#search_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","ok").on($.getTapEvent(),function(){$dlg.squirrelDialog("close"),Squirrel.search($dlg.squirrelDialog("control","string").val())}),$dlg.squirrelDialog("control","string").on("change",function(){$dlg.squirrelDialog("control","ok").trigger($.getTapEvent())})}),$("#alarm_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","units").on("change",function(){_updateNext($dlg)}),$dlg.squirrelDialog("control","number").on("change",function(){_updateNext($dlg)}),$dlg.squirrelDialog("control","remind").on($.getTapEvent(),function(){$dlg.squirrelDialog("close");var numb=$dlg.squirrelDialog("control","number").val()*Utils.TIMEUNITS[$dlg.squirrelDialog("control","units").val()].days;return Squirrel.playAction(Hoard.new_action("A",$dlg.data("node").tree("getPath"),Date.now(),numb)),!1}),$dlg.squirrelDialog("control","clear").on($.getTapEvent(),function(){return $dlg.squirrelDialog("close"),Squirrel.playAction(Hoard.new_action("C",$dlg.data("node").tree("getPath"),Date.now())),!1})}),$("#alarm_dlg").on("dlg-open",function(){var $dlg=$(this),$node=$dlg.data("node");$dlg.squirrelDialog("control","path").text($node.tree("getPath").join("↘")),$dlg.data("node",$node);var lastmod=$node.data("last-time-changed");if($dlg.squirrelDialog("control","lastmod").template("expand",new Date(lastmod).toLocaleString()),void 0!==$node.data("alarm")){var alarm=new Date(lastmod+$node.data("alarm")*Utils.MSPERDAY);$dlg.squirrelDialog("control","current").template("expand",Utils.deltaTimeString(alarm),alarm.toLocaleDateString()).show(),$dlg.squirrelDialog("control","clear").show()}else $dlg.squirrelDialog("control","current").hide(),$dlg.squirrelDialog("control","clear").hide();_updateNext(this)}),$("#store_settings_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","file").hide().on($.getTapEvent(),function(){_changeImage($dlg)}),$dlg.squirrelDialog("control","image").on($.getTapEvent(),function(e){$dlg.squirrelDialog("control","file").trigger("change",e)}),$dlg.squirrelDialog("control","storepath").on("keyup",function(){return""===$dlg.squirrelDialog("control","storepath").val()?($dlg.squirrelDialog("control","message").template("pick","mnbe"),!1):(Squirrel.getClient().hoard.options.store_path!==$dlg.squirrelDialog("control","storepath").val()&&(Squirrel.getClient().hoard.options.store_path=$dlg.squirrelDialog("control","storepath").val(),Squirrel.getClient().status===Squirrel.IS_LOADED&&(Squirrel.getClient().status=Squirrel.NEW_SETTINGS),Utils.sometime("update_save")),!0)}).on("change",function(){$dlg.squirrelDialog("control","ok").trigger($.getTapEvent())}),$dlg.squirrelDialog("control","ok").on($.getTapEvent(),function(){if(""===$dlg.squirrelDialog("control","storepath").val())return $dlg.squirrelDialog("control","message").template("pick","mnbe"),!1;$dlg.squirrelDialog("close")})}),$("#store_settings_dlg").on("dlg-open",function(){var $dlg=$(this);$dlg.squirrelDialog("control","message").hide(),$dlg.squirrelDialog("control","storepath").focus().val(Squirrel.getClient().hoard.options.store_path)}),$("#chpw_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","show").on("change",function(){$dlg.squirrelDialog("control","show").prop("checked")?($dlg.squirrelDialog("control","pass").attr("type","text"),$dlg.squirrelDialog("control","conf").attr("type","text")):($dlg.squirrelDialog("control","pass").attr("type","password"),$dlg.squirrelDialog("control","conf").attr("type","password"))}),$dlg.data("validate",function(){var p=$dlg.squirrelDialog("control","pass").val(),c=$dlg.squirrelDialog("control","conf").val();return $dlg.squirrelDialog("control","nomatch").toggle(p!==c),p===c}),$dlg.squirrelDialog("control","conf").on("change",function(){$dlg.data("validate").call()}),$dlg.squirrelDialog("control","set").on($.getTapEvent(),function(){if(!$dlg.data("validate").call())return!1;$dlg.squirrelDialog("close");var p=$dlg.squirrelDialog("control","pass").val();return Squirrel.getClient().store.pass(p),Squirrel.getClient().status=Squirrel.NEW_SETTINGS,Squirrel.getCloud().store.pass(p),Squirrel.getCloud().status=Squirrel.NEW_SETTINGS,Utils.sometime("update_save"),!0})}),$("#chpw_dlg").on("dlg-open",function(){$(this).data("validate").call()}),$("#json_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","text").on("input",function(){$dlg.squirrelDialog("control","ok").iconbutton("enable")}),$dlg.squirrelDialog("control","ok").on($.getTapEvent(),function(){$dlg.squirrelDialog("close");var datum;try{datum=JSON.parse($dlg.squirrelDialog("control","text").val())}catch(e){return Squirrel.alert({title:TX.tx("JSON could not be parsed"),severity:"error",message:e}),!1}return $dlg.squirrelDialog("control","ok").iconbutton("disable"),global.DEBUG&&console.debug("Importing..."),Squirrel.insert_data([],datum),!0})}),$("#json_dlg").on("dlg-open",function(){var $dlg=$(this),data=Squirrel.getClient().hoard.JSON();$dlg.squirrelDialog("control","text").text(data).select(),$dlg.squirrelDialog("control","ok").iconbutton("disable")}),$("#extras_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","theme").on("selectmenuchange",function(){Squirrel.theme($(this).val())}).selectmenu(),$dlg.squirrelDialog("control","autosave").on("change",function(){Squirrel.autosave($(this).prop("checked"))}),$dlg.squirrelDialog("control","hidevalues").on("change",function(){$("#sites-node").tree("hide_values",$(this).prop("checked"))}),$dlg.squirrelDialog("control","chpw").on($.getTapEvent(),function(){$dlg.squirrelDialog("close"),$("#chpw_dlg").squirrelDialog("open")}),$dlg.squirrelDialog("control","chss").on($.getTapEvent(),function(){$dlg.squirrelDialog("close"),$("#store_settings_dlg").squirrelDialog("open")}),$dlg.squirrelDialog("control","theme").on($.getTapEvent(),function(){$dlg.squirrelDialog("close"),$("#theme_dlg").squirrelDialog("open")}),$dlg.squirrelDialog("control","json").on($.getTapEvent(),function(){$dlg.squirrelDialog("close"),$("#json_dlg").squirrelDialog("open")}),$dlg.squirrelDialog("control","optimise").on($.getTapEvent(),function(){$dlg.squirrelDialog("close"),$("#optimise_dlg").squirrelDialog("open")}),$dlg.squirrelDialog("control","bigger").on("click",function(){Squirrel.zoom(1.25)}),$dlg.squirrelDialog("control","smaller").on("click",function(){Squirrel.zoom(.8)}),$dlg.squirrelDialog("control","about").on($.getTapEvent(),function(){$dlg.squirrelDialog("close"),$("#about_dlg").squirrelDialog("open")}),$dlg.squirrelDialog("control","language").on("change",function(){var fresh=$dlg.squirrelDialog("control","language").val();fresh!==TX.language(fresh)&&TX.init()})}),$("#extras_dlg").on("dlg-open",function(){var $dlg=$(this);Squirrel.USE_STEGANOGRAPHY||Squirrel.getCloud().store&&Squirrel.getCloud().store.options().needs_path||$dlg.squirrelDialog("control","chss").hide(),$dlg.squirrelDialog("control","autosave").prop("checked",Squirrel.autosave()),$dlg.squirrelDialog("control","hidevalues").prop("checked",$("#sites-node").tree("hide_values")),$dlg.squirrelDialog("control","theme").find("option:selected").prop("selected",!1),$dlg.squirrelDialog("control","theme").find("option[value='"+Squirrel.theme()+"']").prop("selected",!0),$dlg.squirrelDialog("control","language").val(TX.language())}),$("#insert_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","key").on("input",function(){_validateUniqueKey($dlg)}),$dlg.squirrelDialog("control","ok").on($.getTapEvent(),function(){$dlg.squirrelDialog("close"),Squirrel.add_child_node($dlg.data("parent"),$dlg.squirrelDialog("control","key").val(),$dlg.data("data"))})}),$("#insert_dlg").on("dlg-open",function(e,options){var $dlg=$(this);global.DEBUG&&console.debug("Pasting");var $parent=options.$node;$dlg.data("parent",$parent),$dlg.data("data",options.data);var base=TX.tx("A copy"),name=new RegExp("^"+base+" ?(\\d*)$"),i=-1;$parent.find("ul").first().children(".tree-node").each(function(){var m=name.exec($(this).data("key"));m&&(i=Math.max(i,m[1]?parseInt(m[1]):0))}),$dlg.squirrelDialog("control","key").val(base+(i>=0?" "+(i+1):""))}),$("#add_dlg").on("dlg-initialise",function(){function ok_dialog(){$dlg.squirrelDialog("close");var $parent=$dlg.data("parent");return Squirrel.add_child_node($parent,$dlg.squirrelDialog("control","key").val(),$dlg.data("adding_value")?$dlg.squirrelDialog("control","value").val():void 0),!1}var $dlg=$(this);$dlg.squirrelDialog("control","key").on("input",function(){_validateUniqueKey($dlg)}).on("change",ok_dialog).autocomplete({source:[TX.tx("User"),TX.tx("Pass")]}),$dlg.squirrelDialog("control","ok").on($.getTapEvent(),ok_dialog)}),$("#add_dlg").on("dlg-open",function(e,options){var $dlg=$(this),$parent=options.$node,is_value=options.is_value;$dlg.data("parent",$parent),$dlg.data("adding_value",is_value),$dlg.squirrelDialog("control","path").text($parent.tree("getPath").join("↘")+"↘"),is_value?($dlg.squirrelDialog("control","value_help").show(),$dlg.squirrelDialog("control","folder_help").hide(),$dlg.squirrelDialog("control","value_parts").show(),$dlg.squirrelDialog("control","key").autocomplete("enable").select(),$dlg.squirrelDialog("control","value").val("")):($dlg.squirrelDialog("control","value_help").hide(),$dlg.squirrelDialog("control","folder_help").show(),$dlg.squirrelDialog("control","value_parts").hide(),$dlg.squirrelDialog("control","key").autocomplete("disable").select()),_validateUniqueKey($dlg)}),$("#optimise_dlg").on("dlg-initialise",function(){var $dlg=$(this);$dlg.squirrelDialog("control","optimise").on($.getTapEvent(),function(){return Squirrel.getClient().hoard.clear_actions(),Squirrel.construct_new_cloud(function(){$dlg.squirrelDialog("close")}),!1})}),$("#optimise_dlg").on("dlg-open",function(){var $dlg=$(this);$dlg.squirrelDialog("control","existing").template("expand",Squirrel.getCloud().hoard.actions.length),$dlg.squirrelDialog("control","study").hide(),$dlg.squirrelDialog("control","pointless").hide(),$dlg.squirrelDialog("control","optimise").iconbutton("disable"),$dlg.squirrelDialog("control","calculating").show().toggle("pulsate",101);var hoard=Squirrel.getClient().hoard,counts={N:0,A:0,X:0};hoard.actions_from_hierarchy(hoard.cache,function(e,follow){counts[e.type]++,follow&&follow()},null,function(){$dlg.squirrelDialog("control","calculating").hide(),$dlg.squirrelDialog("control","study").template("expand",counts.N,counts.A,counts.X,counts.N+counts.A+counts.X).show(),counts.N+counts.A+counts.X<Squirrel.getCloud().hoard.actions.length?$dlg.squirrelDialog("control","optimise").iconbutton("enable"):$dlg.squirrelDialog("control","pointless").show()})})})}(jQuery),/*@preserve Copyright (C) 2015-2017 Crawford Currie http://c-dot.co.uk license MIT*/
function($){function obscure_value(s){return"on"==Cookies.get("ui_hidevalues")?s.replace(/./g,"※"):s}function hide_values(on){if(void 0!==on){var is_on="on"==Cookies.get("ui_hidevalues");Cookies.set("ui_hidevalues",on?"on":"off",{expires:365}),on!==is_on&&$(".tree-value:not(:hover)").each(function(){var s=$(this).closest(".tree-node").data("value");$(this).text(obscure_value(s))})}return"on"==Cookies.get("ui_hidevalues")}function _makeDraggable($node){function handleDrag(event){var $within=$(".tree-collection").not(".ui-draggable-dragging").filter(function(){if($(this).is($node.parent().closest(".tree-node")))return!1;var box=$(this).offset();return!(event.pageX<box.left||event.pageY<box.top)&&!(event.pageX>box.left+$(this).outerWidth(!0)||event.pageY>box.top+$(this).outerHeight(!0))});$(".drop-target").removeClass("drop-target"),$within.length>0&&($within=$within.last(),$within.addClass("drop-target"))}function handleStop(){var $target=$(".drop-target");$target.length,$target.each(function(){var $new_parent=$(this);$new_parent.removeClass("drop-target");var oldpath=$node.tree("getPath"),newpath=$new_parent.tree("getPath");Squirrel.playAction({type:"M",path:oldpath,data:newpath})})}var $button=$(document.createElement("div")).addClass("tree-draghandle").iconbutton({icon:"ui-icon-arrow-2-n-s"}).hide();$node.children(".tree-title").append($button),$node.draggable({handle:".tree-draghandle",axis:"y",containment:".tree-collection",cursor:"pointer",revert:!0,revertDuration:1,drag:handleDrag,stop:handleStop})}function _decorate_with_alarm($node){$node.data("alarm")&&$node.find(".tree-key").first().before(function(){var $button=$(document.createElement("button")).addClass("tree-alarm");return $button.iconbutton({icon:"squirrel-icon-alarm"}).on("click",function(){return $("#alarm_dlg").squirrelDialog("open",{$node:$node}),!1}),$button})}function decorate_node($node){function hoverIn(){return Squirrel.contextMenu("close"),$("body").find("input.in_place_editor").length>0||($(".tree-hover").removeClass("tree-hover"),hide_values()&&$node.hasClass("tree-leaf")&&$(this).find(".tree-value").each(function(){$(this).text($node.data("value"))}),$(this).addClass("tree-hover").find(".tree-draghandle").first().show(),!1)}function hoverOut(){if(Squirrel.contextMenu("isOpen")||$("body").find("input.in_place_editor").length>0)return!0;hide_values()&&$node.hasClass("tree-leaf")&&$(this).find(".tree-value").each(function(){$(this).text(obscure_value($node.data("value")))}),$(this).removeClass("tree-hover").find(".tree-draghandle").first().hide()}var $title=$(document.createElement("div")).addClass("tree-title").hover(hoverIn,hoverOut).on("paste",function(){}).prependTo($node);if(!$node.hasClass("tree-leaf")){var $control=$(document.createElement("button")).addClass("tree-node-is-open-close");$control.appendTo($title),$control.iconbutton({icon:"squirrel-icon-folder-closed"}).on($.getTapEvent(),function(){return $node.tree("toggle"),!1})}var $info=$(document.createElement("div")).addClass("tree-info").appendTo($title);$(document.createElement("span")).appendTo($info).addClass("tree-key").text($node.data("key")).on($.isTouchCapable&&$.isTouchCapable()?"doubletap":"dblclick",function(e){global.DEBUG&&console.debug("Double-click 1"),e.preventDefault(),$(e.target).closest(".tree-node").tree("editKey")}),$node.hasClass("tree-leaf")&&($(document.createElement("span")).text(" : ").addClass("tree-separator").appendTo($info),$(document.createElement("span")).appendTo($info).addClass("tree-value").text(obscure_value($node.data("value"))).on($.isTouchCapable&&$.isTouchCapable()?"doubletap":"dblclick",function(e){global.DEBUG&&console.debug("Double-click 2"),e.preventDefault(),$(e.target).closest(".tree-node").tree("editValue")})),_makeDraggable($node),_decorate_with_alarm($node)}var cache={};const PATHSEP=String.fromCharCode(1);var compare,tree_widget={};tree_widget.hide_values=hide_values,tree_widget._create=function(){var $node=this.element;this.options.compare&&(compare=this.options.compare);var parent,$parent,options=this.options,is_leaf=!1,is_root=!options.path,key="";if($node.addClass("tree-node"),$node.addClass("tree-never-opened"),is_root?(cache[""]=$node,$node.addClass("tree-root"),$node.data("path",[])):(parent=options.path.slice(),key=parent.pop(),$parent=this.getNodeFromPath(parent),$node.data("key",key),void 0!==options.value&&null!==options.value&&($node.data("value",options.value).data("is_leaf",!0).addClass("tree-leaf"),is_leaf=!0)),!is_leaf){var $ul=$(document.createElement("ul")).addClass("sortable tree-subnodes").hide();$node.addClass("tree-collection").append($ul)}$parent&&this._insertInto($parent),void 0!==options.time&&this.setModified(options.time),options.on_create&&options.on_create.call($node)},tree_widget.edit=function($span,text,action){var $node=this.element,w=$node.closest(".tree-root").width();w-=$span.position().left,$span.parents().each(function(){w-=$(this).position().left}),Squirrel.contextMenu("disable");var nodepath=this.getPath();$span.edit_in_place({width:w,text:text,changed:function(s){return Squirrel.playAction({type:action,path:nodepath,data:s}),s},closed:function(){Squirrel.contextMenu("enable")}})},tree_widget.editKey=function(){var $node=this.element;this.edit($node.find(".tree-key").first(),$node.data("key"),"R")},tree_widget.editValue=function(){var $node=this.element;this.edit($node.find(".tree-value").first(),$node.data("value"),"E")},tree_widget.ringAlarm=function(){this.element.find(".tree-alarm").addClass("tree-expired").find(".squirrel-icon-alarm").removeClass("squirrel-icon-alarm").addClass("squirrel-icon-rang")},tree_widget.getPath=function(){var $node=this.element;if($node.hasClass("tree-root"))return[];$node.hasClass("tree-node");var ps=$node.data("path");return ps||(this._addToCaches(),(ps=$node.data("path"))||(ps=[])),ps},tree_widget._insertInto=function($parent){var $node=this.element;this._removeFromCaches(),$node.detach();var key=$node.data("key"),inserted=!1,$ul=$parent.find("ul").first();$ul.children(".tree-node").each(function(){if(compare($(this).data("key"),key)>0)return $node.insertBefore($(this)),inserted=!0,!1}),inserted||$ul.append($node),this._addToCaches()},tree_widget.setModified=function(time){return this.element.addClass("tree-modified").data("last-time-changed",time)},tree_widget.open=function(options){var $node=this.element;return options&&options.decorate&&decorate_node($node),$node.hasClass("tree-node-is-open")?$node:($node.hasClass("tree-never-opened")&&($node.removeClass("tree-never-opened"),$node.children(".tree-subnodes").children().each(function(){decorate_node($(this))})),$node.hasClass("tree-root")||$node.find(".tree-node-is-open-close").first().iconbutton("option","icon","squirrel-icon-folder-open"),$node.addClass("tree-node-is-open").children(".tree-subnodes").show())},tree_widget.close=function(){var $node=this.element;return $node.hasClass("tree-node-is-open")?($node.find(".tree-node-is-open-close").first().iconbutton("option","icon","squirrel-icon-folder-closed"),$node.removeClass("tree-node-is-open").children(".tree-subnodes").hide()):$node},tree_widget.toggle=function(){return this.element.hasClass("tree-node-is-open")?this.close():this.open()},tree_widget.action_E=function(action,undoable){var $node=this.element;undoable&&undoable("E",this.getPath(),action.time,$node.data("value")),$node.data("value",action.data).find(".tree-value").first().text(obscure_value(action.data)),this.setModified(action.time)},tree_widget.action_D=function(action,undoable){var $node=this.element;undoable&&undoable("N",this.getPath(),action.time,$node.data("value")),this._removeFromCaches(),$node.parent().closest(".tree-node").tree("setModified",action.time),$node.remove()},tree_widget.action_A=function(action,undoable){var $node=this.element,alarm=$node.data("alarm");alarm!==action.data&&($node.data("alarm",action.data),void 0===alarm?(_decorate_with_alarm($node),$node.parents(".tree-node").each(function(){var c=$(this).data("alarm-count")||0;$(this).data("alarm-count",c+1),$(this).addClass("tree-has-alarms")}),undoable&&undoable("C",this.getPath(),action.time)):undoable&&undoable("A",this.getPath(),action.time,alarm),this.setModified(action.time))},tree_widget.action_C=function(action,undoable){var $node=this.element,alarm=$node.data("alarm");alarm&&(undoable&&undoable("A",this.getPath(),action.time,alarm),$node.parents(".tree-node").each(function(){var c=$(this).data("alarm-count")||0;c-=1,$(this).data("alarm-count",c),0===c&&$(this).removeClass("tree-has-alarms")}),$(".tree-alarm").first().remove(),$node.removeData("alarm"),this.setModified(action.time))},tree_widget.action_X=function(action,undoable){var constraints=this.element.data("constraints");constraints!==action.data&&(undoable&&undoable("X",this.getPath(),action.time,constraints),this.element.data("constraints",action.data),this.setModified(action.time))},tree_widget.action_M=function(action,undoable){var $node=this.element,oldpath=this.getPath(),newpath=action.data.slice(),$new_parent=this.getNodeFromPath(newpath);this._insertInto($new_parent),$node.scroll_into_view(),this.setModified(action.time),newpath.push(oldpath.pop()),undoable&&undoable("M",newpath,action.time,oldpath)},tree_widget.action_R=function(action,undoable){var $node=this.element,key=action.path[action.path.length-1];$node.data("key",action.data).find(".tree-key").first().text(action.data),this.setModified(action.time),this._insertInto($node.parent().closest(".tree-collection")),$node.scroll_into_view(),undoable&&undoable("R",$node.tree("getPath"),action.time,key)},tree_widget.action=function(action,undoable,chain){if("N"===action.type)$(document.createElement("li")).tree({path:action.path,value:action.data,time:action.time,on_create:function(){undoable&&undoable("D",this.tree("getPath"),action.time),void 0!==chain&&chain(this)}});else{var $node=this.getNodeFromPath(action.path);$node.tree("action_"+action.type,action,undoable),void 0!==chain&&chain($node)}},tree_widget._addToCaches=function(){function recache($node,pa){var path=pa.concat($node.data("key"));if(global.DEBUG){if(!pa)throw"recache outside tree";if(cache[path.join(PATHSEP)])throw"Remapping path -> node";if($node.data("path"))throw"Remapping node -> path"}$node.data("path",path),cache[path.join(PATHSEP)]=$node,$node.find("ul").first().children(".tree-node").each(function(){recache($(this),path)})}var $el=this.element,$parent=$el.parent();!$parent||$parent.length,!($parent=$parent.closest(".tree-node"))||$parent.length,recache($el,$parent.tree("getPath"))},tree_widget._removeFromCaches=function(){var $node=this.element;$node.hasClass("tree-node")||($node=$node.closest(".tree-node")),$node.data("path")&&delete cache[$node.data("path").join(PATHSEP)],$node.removeData("path").find(".tree-node").each(function(){var $s=$(this);delete cache[$s.data("path").join(PATHSEP)],$s.removeData("path")})},tree_widget.getNodeFromPath=function(path){var $node=cache[path.join(PATHSEP)];return global.DEBUG&&$node&&$node.length,$node},$.widget("squirrel.tree",tree_widget)}(jQuery);/*@preserve Copyright (C) 2015-2017 Crawford Currie http://c-dot.co.uk license MIT*/
var Squirrel={NEW_SETTINGS:"has new settings",IS_LOADED:"is loaded",IS_CORRUPT:"is corrupt",IS_EMPTY:"is empty"};!function($,S){function check_alarms(){client.hoard.check_alarms(function(path,expired,next){DOMtree.getNodeFromPath(path).tree("ringAlarm"),S.alert({severity:"warning",message:"<div class='ui-icon squirrel-icon-rang'></div>"+TX.tx("Reminder on '$1' was due on $2",path.join("↘"),expired.toLocaleDateString()),after_close:next}).on("dialogclose",function(e){$(e.target).off("dialogclose")})})}function unsaved_changes(max_changes){var message=[];if($(".tree-modified").each(function(){global.DEBUG&&!$(this).tree("getPath")&&$(this).hasClass("tree-root");var path=$(this).data("path")||[];message.push(TX.tx("$1 has changed",path.join("↘")))}),message.length>max_changes){var l=message.length;message=message.slice(0,max_changes),message.push(TX.tx("... and $1 more change$?($1!=1,s,)",l-5))}return cloud.status!==S.IS_LOADED&&message.unshift(TX.tx("The $1 hoard $2",cloud.store?cloud.store.options().identifier:TX.tx("Cloud"),TX.tx(cloud.status))),client.status!==S.IS_LOADED&&message.unshift(TX.tx("The $1 hoard $2",client.store.options().identifier,TX.tx(client.status))),0===message.length?null:message.join("\n")}function finished_save(){global.DEBUG&&console.debug("...save finished"),Utils.sometime("update_save"),client_ok&&cloud_ok?"on"===Cookies.get("ui_autosave")?S.alert():S.alert({severity:"notice",message:TX.tx("Save complete")}):(S.alert({severity:"error",message:TX.tx("Save encountered errors")}),Cookies.set("ui_autosave","off",{expires:365}))}function write_client_store(){client.store.writes("S."+client.store.user(),JSON.stringify(client.hoard),function(){global.DEBUG&&console.debug("...client save OK"),$(".tree-modified").removeClass("tree-modified"),client.status=S.IS_LOADED,S.alert({severity:"notice",message:TX.tx("Saved in $1",this.options().identifier)}),finished_save()},function(e){global.DEBUG&&console.debug("...client save failed "+e),S.alert({severity:"error",message:TX.tx("Failed to save in $1: $2",this.options().identifier,e)}),client_ok=!1,finished_save()})}function save_client(){if(global.DEBUG&&console.debug("...save to client"),client.status===S.IS_LOADED&&0===$(".tree-modified").length)return void finished_save();client.status=S.PENDING_SAVE,S.alert({severity:"notice",transitory:!0,message:TX.tx("Saving in $1",client.store.options().identifier)}),Utils.soon(write_client_store)}function write_cloud_store(){cloud.store.writes(client.hoard.options.store_path,JSON.stringify(cloud.hoard),function(){global.DEBUG&&console.debug("...cloud save OK"),client.hoard.actions=[],client.hoard.last_sync=Date.now(),undos=[],S.alert({severity:"notice",message:TX.tx("Saved in $1",this.options().identifier)}),cloud.status=S.IS_LOADED,save_client()},function(e){global.DEBUG&&console.debug("...cloud save failed "+e),S.alert({severity:"error",message:TX.tx("Failed to save in $1: $2",this.options().identifier,e)}),cloud_ok=!1,save_client()})}function update_cloud_store(ready){cloud.hoard.merge_actions(client.hoard.actions),cloud.store?(global.DEBUG&&console.debug("...save to cloud"),S.alert({severity:"notice",transitory:!0,message:TX.tx("Saving in $1",cloud.store.options().identifier)}),cloud.status=S.PENDING_SAVE,Utils.soon(function(){write_cloud_store()})):(global.DEBUG&&console.debug("...no cloud store"),ready&&ready())}function cloud_store_reloaded_ok(data){global.DEBUG&&console.debug("...cloud read OK ");try{cloud.hoard=new Hoard("reloaded Cloud",data),cloud.status=S.IS_LOADED}catch(e){return global.DEBUG&&console.debug("Cloud hoard JSON parse failed: "+e),S.alert({severity:"error",message:TX.tx("$1 hoard can't be read for update",this.options().identifier)}),cloud.status=S.IS_CORRUPT,cloud_ok=!1,void S.construct_new_cloud()}cloud.status===S.IS_LOADED&&(global.DEBUG&&console.debug("...merge cloud "),client.hoard.play_actions(cloud.hoard.actions,function(e){DOMtree.action(e)},function(percent){$("#merge_progress").text(percent+"%")})),cloud.status!==S.IS_LOADED||0!==client.hoard.actions.length?(global.DEBUG&&console.debug("...update from cloud: "+cloud.status),update_cloud_store(save_client)):Utils.soon(save_client)}function cloud_store_read_failed(e){global.DEBUG&&console.debug("...cloud read failed "+e),e===AbstractStore.NODATA?(global.DEBUG&&console.debug(this.options().identifier+" contains NODATA"),cloud.status=S.IS_EMPTY,S.construct_new_cloud()):(S.alert({severity:"error",message:TX.tx("Failed to refresh from $1: $2",this.options().identifier,e)}),cloud_ok=!1,Utils.soon(save_client))}function save_hoards(){S.alert({title:TX.tx("Saving")}),client_ok=!0,cloud_ok=!0,global.DEBUG&&console.debug("Saving; client "+client.status+"; cloud "+cloud.status),cloud.status===S.NEW_SETTINGS||cloud.status===S.IS_EMPTY?(global.DEBUG&&console.debug("...constructing new cloud because settings"),S.construct_new_cloud()):(global.DEBUG&&console.debug("...reloading cloud"),cloud.store.reads(client.hoard.options.store_path,cloud_store_reloaded_ok,cloud_store_read_failed))}function update_save(){$("#undo_button").toggle(S.can_undo());var us=unsaved_changes(3),$sb=$("#save_button");null!==us?"on"===Cookies.get("ui_autosave")?save_hoards():($sb.attr("title",TX.tx("Save is required because")+": "+us),$sb.show()):$sb.hide()}function step_7_interact(){global.DEBUG&&console.debug("step_7_interact"),$("#whoami").text(client.store.user()),$("#unauthenticated").hide(),$("#authenticated").show(),$("#sites-node").tree("open"),Utils.sometime_is_now()}function step_6_hoards_loaded(){global.DEBUG&&console.debug("step_6_hoards_loaded"),$(window).on("beforeunload",function(){var us=unsaved_changes(10);if(null!==us)return us=TX.tx("You have unsaved changes")+"\n"+us+"\n"+TX.tx("Are you really sure?")}),Utils.sometime("update_save"),Utils.sometime("check_alarms"),step_7_interact()}function step_5a_merge_from_cloud(chain){global.DEBUG&&console.debug("step_5a_merge_from_cloud");var conflicts=client.hoard.play_actions(cloud.hoard.actions,function(e){DOMtree.action(e)},function(percent){$("#merge_progress").text(percent+"%")});conflicts.length>0&&(S.alert({title:TX.tx("Warning"),severity:"warning",message:TX.tx("Conflicts were detected while merging actions from the Cloud.")+" "+TX.tx("Please review these rejected actions, and make sure the data displayed is correct before saving.")}),$.each(conflicts,function(i,c){var e=c.conflict;S.alert({severity:"warning",message:Hoard.stringify_action(e)+": "+c.message})})),cloud.status=S.IS_LOADED,chain()}function step_5_load_cloud_hoard(){global.DEBUG&&console.debug("step_5_load_cloud_hoard"),cloud.store?($("#stage").text(TX.tx("Reading from cloud")),cloud.store.reads(client.hoard.options.store_path,function(data){global.DEBUG&&console.debug(this.options().identifier+" is ready");try{cloud.hoard=new Hoard("Cloud",data),global.DEBUG&&dump_cloud&&console.debug(JSON.stringify(cloud.hoard))}catch(e){return global.DEBUG&&console.debug("Cloud hoard JSON parse failed: "+e+data),S.alert({title:TX.tx("Error"),severity:"error",message:TX.tx("$1 hoard exists, but can't be read.",this.options().identifier)+" "+TX.tx("Check that you have the correct password.")}),cloud.status=S.IS_CORRUPT,void Utils.soon(step_6_hoards_loaded)}step_5a_merge_from_cloud(step_6_hoards_loaded)},function(e){e===AbstractStore.NODATA?(global.DEBUG&&console.debug(this.options().identifier+" contains NODATA"),cloud.status=S.IS_EMPTY):(global.DEBUG&&console.debug(this.options().identifier+" has NODATA: "+e),S.alert({title:TX.tx("Error"),severity:"error",message:TX.tx("Could not load cloud store")}),S.alert({severity:"notice",message:TX.tx("Check that the cloud store exists and you have the correct password.")})),Utils.soon(step_6_hoards_loaded)})):step_6_hoards_loaded()}function step_4_init_client_hoard(){global.DEBUG&&console.debug("step_4_init_client_hoard"),client.hoard=new Hoard("Client"),client.status=S.IS_EMPTY,cloud.store&&cloud.store.options().needs_path?$("#store_settings_dlg").squirrelDialog("option","close",function(){step_5_load_cloud_hoard()}).squirrelDialog("open"):step_5_load_cloud_hoard()}function step_3_load_client_hoard(){function rebuild_hoard(){$("#stage").text(TX.tx("Building UI")),client.hoard.reconstruct_actions(function(a,next){DOMtree.action(a,null,next)},function(percent){$("#load_progress").text(percent+"%")},function(){$(".tree-modified").removeClass("tree-modified");var i,p,$node,as=client.hoard.actions;for(i=0;i<as.length;i++)for(p=as[i].path.slice();p.length>0;){if($node=DOMtree.getNodeFromPath(p)){$node.addClass("tree-modified");break}p.pop()}Utils.soon(step_5_load_cloud_hoard)})}global.DEBUG&&console.debug("step_3_load_client_hoard"),$("#stage").text(TX.tx("Reading from client")),client.store.reads("S."+client.store.user(),function(data){try{client.hoard=new Hoard("Client",data),client.status=S.IS_LOADED}catch(e){return global.DEBUG&&console.debug("Caught "+e),S.alert({title:TX.tx("Error"),severity:"error",message:TX.tx("$1 hoard exists, but can't be read.",this.options().identifier),after_close:function(){Utils.sometime("init_application")}}),void S.alert({severity:"notice",message:TX.tx("Check that you have the correct password.")})}(client.store&&client.store.options().needs_path||cloud.store&&cloud.store.options().needs_path)&&!client.hoard.options.store_path?$("#store_settings_dlg").squirrelDialog("open",rebuild_hoard):rebuild_hoard()},function(e){e===AbstractStore.NODATA?(global.DEBUG&&console.debug(this.options().identifier+" contains NODATA"),Utils.soon(step_4_init_client_hoard)):S.alert({title:TX.tx("Error"),severity:"error",message:TX.tx("$1 store error: $2",this.options().identifier,e),after_close:function(){Utils.sometime("init_application")}})})}function step_2a_identify_user(){var uReq=!0,pReq=!0;global.DEBUG&&console.debug("step_2a_identify_user"),$("#stage").text(TX.tx("Authentication")),cloud.store&&void 0!==cloud.store.user()?(global.DEBUG&&console.debug("Cloud user is preferred: "+cloud.store.user()),client.store.user(cloud.store.user()),uReq=!1):client.store&&void 0!==client.store.user()&&(global.DEBUG&&console.debug("Client user is available: "+client.store.user()),cloud.store&&cloud.store.user(client.store.user()),uReq=!1),cloud.store&&void 0!==cloud.store.pass()?(global.DEBUG&&console.debug("Cloud pass is preferred"),client.store&&client.store.pass(cloud.store.pass()),pReq=!1):client.store&&void 0!==client.store.pass()&&(global.DEBUG&&console.debug("Client pass is available"),cloud.store&&cloud.store.pass(client.store.pass()),pReq=!1),uReq||pReq?$("#login_dlg").squirrelDialog("open",{store:client.store,on_signin:function(user,pass){global.DEBUG&&console.debug("Login prompt said user was "+user),client.store.user(user),client.store.pass(pass),cloud.store&&(cloud.store.user(user),cloud.store.pass(pass)),step_3_load_client_hoard()},user_required:uReq,pass_required:pReq}):step_3_load_client_hoard()}function step_2_init_client_store(){global.DEBUG&&console.debug("step_2_init_client_store");var p={understore:function(params){return new LocalStorageStore(params)},ok:function(){global.DEBUG&&console.debug(this.options().identifier+" store is ready"),client.store=this,void 0!==global.URLPARAMS.plaintext?Utils.soon(step_3_load_client_hoard):Utils.soon(step_2a_identify_user)},fail:function(e){S.alert({title:TX.tx("Error"),severity:"error",message:TX.tx("Encryption error: $1",e)})}};void 0!==global.URLPARAMS.plaintext?p.understore(p):new EncryptedStore(p)}function step_1_init_cloud_store(){global.DEBUG&&console.debug("step_1_init_cloud_store");var p={ok:function(){cloud.store=this,Utils.soon(step_2_init_client_store)},fail:function(e){S.alert({title:TX.tx("Warning"),severity:"warning",message:TX.tx("Could not open cloud store: $1",e),after_close:function(){step_2_init_client_store()}}),S.alert({severity:"warning",message:TX.tx("If you continue, only the client store will be available")})},understore:function(pp){return useSteganography?(pp.understore=function(ppp){return new global.CLOUD_STORE(ppp)},new StegaStore(pp)):new global.CLOUD_STORE(pp)}};return void 0!==global.URLPARAMS.plaintext?p.understore(p):new EncryptedStore(p)}function before_menu_open(e,ui){if(contextMenuDisables>0)return!1;var $node=ui.target.is(".tree-node")?ui.target:ui.target.closest(".tree-node"),has_alarm=void 0!==$node.data("alarm"),is_leaf=$node.hasClass("tree-leaf"),is_root=ui.target.closest(".tree-node").hasClass("tree-root"),is_open=$node.hasClass("tree-node-is-open"),$root=$("body");global.DEBUG&&console.debug("beforeOpen contextmenu on "+$node.data("key")+" "+is_leaf),$root.contextmenu("showEntry","add_alarm",!has_alarm&&!is_root).contextmenu("showEntry","add_subtree",is_open&&!is_leaf).contextmenu("showEntry","add_value",is_open&&!is_leaf&&!is_root).contextmenu("showEntry","copy_value",is_leaf).contextmenu("showEntry","delete",!is_root).contextmenu("showEntry","edit",is_leaf).contextmenu("showEntry","insert_copy",!is_leaf&&void 0!==clipboard).contextmenu("showEntry","make_copy",!is_root&&!is_leaf).contextmenu("showEntry","pick_from",is_leaf).contextmenu("showEntry","randomise",is_leaf).contextmenu("showEntry","rename",!is_root),$menuTarget=$node}function handle_menu_choice(e,ui){var $node=$menuTarget;if(!$node)return void(global.DEBUG&&console.debug("No node for contextmenu>"+ui.cmd));switch(ui.cmd){case"copy_value":clipboard=$node.data("value");break;case"make_copy":var p=$node.tree("getPath"),n=client.hoard.get_node(p);clipboard=JSON.stringify(n);break;case"insert_copy":if(clipboard)try{var data=JSON.parse(clipboard);$("#insert_dlg").squirrelDialog("open",{$node:$node,data:data})}catch(e){global.DEBUG}break;case"rename":$node.tree("editKey");break;case"edit":$node.tree("editValue");break;case"add_value":$("#add_dlg").squirrelDialog("open",{$node:$node,is_value:!0});break;case"add_subtree":$("#add_dlg").squirrelDialog("open",{$node:$node,is_value:!1});break;case"randomise":$("#randomise_dlg").squirrelDialog("open",{$node:$node});break;case"add_alarm":$("#alarm_dlg").squirrelDialog("open",{$node:$node});break;case"delete":$("#delete_dlg").squirrelDialog("open",{$node:$node});break;case"pick_from":$("#pick_dlg").squirrelDialog("open",{$node:$node});break;default:global.DEBUG}}function init_menus(){var menu={delegate:".tree-title",menu:[{title:TX.tx("Copy value"),cmd:"copy_value",uiIcon:"squirrel-icon-copy squirrel-icon"},{title:TX.tx("Pick characters"),cmd:"pick_from",uiIcon:"squirrel-icon-pick squirrel-icon"},{title:TX.tx("Rename"),cmd:"rename",uiIcon:"squirrel-icon-edit squirrel-icon"},{title:TX.tx("Edit value"),cmd:"edit",uiIcon:"squirrel-icon-edit squirrel-icon"},{title:TX.tx("Add reminder"),cmd:"add_alarm",uiIcon:"squirrel-icon-alarm squirrel-icon"},{title:TX.tx("Generate new random value"),cmd:"randomise",uiIcon:"squirrel-icon-key squirrel-icon"},{title:TX.tx("Add new value"),cmd:"add_value",uiIcon:"squirrel-icon-add-value squirrel-icon"},{title:TX.tx("Add new folder"),cmd:"add_subtree",uiIcon:"squirrel-icon-add-folder squirrel-icon"},{title:TX.tx("Copy folder"),cmd:"make_copy",uiIcon:"squirrel-icon-copy squirrel-icon"},{title:TX.tx("Insert copy of folder"),cmd:"insert_copy",uiIcon:"squirrel-icon-paste squirrel-icon"},{title:TX.tx("Delete"),cmd:"delete",uiIcon:"squirrel-icon-delete squirrel-icon"}],preventContextMenuForPopup:!0,preventSelect:!0,beforeOpen:before_menu_open,select:handle_menu_choice};$("body").contextmenu(menu),S.valueCopyClipboard=new ClipboardJS(".ui-contextmenu li[data-command='copy_value']",{text:function(){var $node=$menuTarget;return global.DEBUG&&console.debug("clip val from: "+$node.data("key")),$node.data("value")}}),S.treeCopyClipboard=new ClipboardJS(".ui-contextmenu li[data-command='make_copy']",{text:function(){var $node=$menuTarget;global.DEBUG&&console.debug("clip json from: "+$node.data("key"));var p=$node.tree("getPath"),n=client.hoard.get_node(p);return JSON.stringify(n)}})}function init_application(){$("#stage").text(TX.tx("Loading application")),step_1_init_cloud_store()}function init_ui(){if($("#sites-node").tree({is_root:!0,compare:S.compare}),DOMtree=$("#sites-node").data("squirrelTree"),global.DEBUG&&console.debug("DOM tree rooted "+DOMtree),$(".dlg-dialog").squirrelDialog({autoOpen:!1}),$("#alerts").dialog({autoOpen:!1}),$(".template").template(),$(".twisted").twisted(),$('input[type="password"]').simulated_password(),global.DEBUG){var pick=1;$("#template-test").template().template("pick",pick).template("expand","Cats"),$("#template-tester").iconbutton().on("click",function(){$("#template-test").template("pick",pick).template("expand","Squirrels","cats"),pick=(pick+1)%3})}else $(".debug-only").remove();$("#save_button").hide().on($.getTapEvent(),function(){return save_hoards(),!1}),$("#undo_button").hide().on($.getTapEvent(),function(){return S.undo(function(mess){S.alert({title:"Undo",message:mess})}),!1}),$("#extras_button").on($.getTapEvent(),function(){$("#extras_dlg").squirrelDialog("open")}),$("#search_input").on("change",function(){S.search($(this).val())}),$("#search_button").on($.getTapEvent(),function(){S.search($("#search_input").val())}),$("button").iconbutton(),init_menus(),$(document).on("init_application",init_application).on("check_alarms",check_alarms).on("update_save",update_save).on("reset_styling",function(){$.reset_styling()}),$.reset_styling(),Utils.sometime_is_now()}var clipboard,DOMtree,$menuTarget,useSteganography=!1,dump_cloud=!1,undos=[],contextMenuDisables=0,client={store:null,hoard:null,status:S.IS_EMPTY},cloud={store:null,hoard:null,status:S.IS_EMPTY},sort_prio=[TX.tx("A new folder"),TX.tx("A new value"),TX.tx("User"),TX.tx("Pass")];S.alert=function(p){var $dlg=$("#alerts");if($dlg.hasClass("dlg-initialised")||($dlg.find(".close").on("click",function(){$dlg.dialog("close")}),$dlg.addClass("dlg-initialised")),void 0===p)return void($dlg.dialog("isOpen")&&$dlg.dialog("close"));$dlg.dialog("isOpen")||($dlg.find(".messages").empty(),$dlg.dialog("option","title",p.title||TX.tx("Alert")),$dlg.dialog("open")),$dlg.find(".transitory").remove();var $mess=$(document.createElement("div")).addClass("dlg-"+p.severity);p.transitory&&$mess.addClass("transitory"),$mess.append(p.message),$dlg.find(".messages").append($mess)},S.theme=function(theme){return void 0!==theme&&($("#jQueryTheme").each(function(){this.href=this.href.replace(/\/themes\/[^\/]+/,"/themes/"+theme),$(this).replaceWith($(this)),Utils.sometime("reset_styling")}),"base"===theme?Cookies.remove("ui_theme"):Cookies.set("ui_theme",theme,{expires:365})),Cookies.get("ui_theme")},S.scale=function(scale){return void 0!==scale&&scale>6&&($("body").css("font-size",scale+"px"),Cookies.set("ui_scale",scale,{expires:365})),Cookies.get("ui_scale")},S.zoom=function(factor){var now=$("body").css("font-size");now=now.replace(/px/,""),S.scale(Math.round(factor*parseInt(now)))},S.autosave=function(on){if(void 0!==typeof on){var ons=on?"on":"off";Cookies.get("ui_autosave")!==ons&&(Cookies.set("ui_autosave",ons,{expires:365}),Utils.sometime("update_save"))}return Cookies.get("ui_autosave")},S.compare=function(a,b){if(a==b)return 0;for(var i=0;i<sort_prio.length;i++){if(a==sort_prio[i])return-1;if(b==sort_prio[i])return 1}return a<b?-1:1};var client_ok=!0,cloud_ok=!0;S.construct_new_cloud=function(progress,ready){global.DEBUG&&console.debug("...construct cloud "),cloud.hoard=new Hoard("new Cloud"),client.hoard.reconstruct_actions(function(a,next){cloud.hoard.push_action(a),next&&next()},progress,function(){update_cloud_store(ready)})},S.contextMenu=function(f){switch(f){case"enable":contextMenuDisables>0&&contextMenuDisables--,global.DEBUG&&console.log("Context menu disables "+contextMenuDisables),contextMenuDisables<=0&&$("body").contextmenu("option","autoTrigger",!0);break;case"disable":contextMenuDisables++,global.DEBUG&&console.log("Context menu disables "+contextMenuDisables),$("body").contextmenu("option","autoTrigger",!1);break;default:return $("body").contextmenu(f)}},S.add_child_node=function($node,title,value){var p=$node.tree("getPath");p=p.concat(title);var e=client.hoard.push_action("N",p,Date.now(),"string"==typeof value?value:void 0),res=client.hoard.play_action(e,function(e){DOMtree.action(e,S.pushUndo,function($newnode){global.DEBUG,"string"!=typeof value&&void 0!==value&&S.insert_data($newnode.tree("getPath"),value),$newnode.tree("open",{decorate:!0}),Utils.sometime("update_save")})});null!==res&&S.alert({message:res.message})};var last_search="",picked_hit=0;S.search=function(s){var hits;if($(".picked-hit").removeClass("picked-hit"),s!==last_search){$("#search_hits").text(TX.tx("Searching..."));var re;try{re=new RegExp(s,"i")}catch(e){return void S.alert({message:TX.tx("Error in search expression")+" '"+s+"': "+e})}if(last_search=s,$(".search-hit").removeClass("search-hit"),$(".tree-node").not(".tree-root").each(function(){var $node=$(this);($node.data("key").match(re)||$node.hasClass("tree-leaf")&&$node.data("value").match(re))&&$node.addClass("search-hit")}),hits=$(".search-hit"),0===hits.length)return void $("#search_hits").text(TX.tx("Not found"));picked_hit=0}hits=hits||$(".search-hit"),picked_hit<hits.length&&($("#search_hits").text(TX.tx("$1 of $2 found",picked_hit+1,hits.length)),$(hits[picked_hit]).addClass("picked-hit").parents(".tree-collection").each(function(){$(this).tree("open")}),$(hits[picked_hit]).scroll_into_view(),picked_hit=(picked_hit+1)%hits.length)},S.insert_data=function(path,data){S.alert({title:"Loading"}),client.hoard.actions_from_hierarchy({data:data},function(act,next){act.path=path.slice().concat(act.path),act=this.push_action(act);var res=this.play_action(act,function(sact){DOMtree.action(sact,null,next)});null!==res&&S.alert({severity:"notice",message:res.message}),next&&next()},null,function(){Utils.sometime("update_save"),S.alert({severity:"notice",message:TX.tx("JSON has been loaded")})})},S.getClient=function(){return client},S.getCloud=function(){return cloud},S.playAction=function(action,more){action=client.hoard.push_action(action);var res=client.hoard.play_action(action,function(e){DOMtree.action(e,S.pushUndo,function($node){more&&more($node),Utils.sometime("update_save")})});null!==res&&S.alert({title:TX.tx("Error"),severity:"error",message:res.message})},S.pushUndo=function(){undos.push(Hoard.new_action.apply(null,arguments))},S.can_undo=function(){return 0!==undos.length},S.undo=function(){global.DEBUG&&undos.length;var a=undos.pop();a.time=Date.now(),global.DEBUG&&console.debug("Undo "+Hoard.stringify_action(a)),client.hoard.pop_action();var res=client.hoard.play_action(a,function(e){DOMtree.action(e,null,function(){0===undos.length&&client.status===S.IS_LOADED&&$(".tree-modified").removeClass("tree-modified"),Utils.sometime("update_save")})});null!==res&&S.alert({title:TX.tx("Error"),severity:"error",message:res.message})},$(function(){var qs=Utils.parse_query_params();global.URLPARAMS=qs,qs.debug&&(global.DEBUG=!0,console.log("Debug enabled"),$.isTouchCapable&&$.isTouchCapable()&&console.log("Device is touch-capable")),global.DEBUG&&console.log("Device is "+window.screen.width+" X "+window.screen.height+" Body is "+$("body").width()+" X "+$("body").height()),global.DEBUG&&qs.dumpcloud&&(dump_cloud=!0),global.DEBUG||$.ajaxSetup({cache:!0});var theme=Cookies.get("ui_theme");theme&&"base"!==theme&&S.theme(theme);var scale=Cookies.get("ui_scale");scale&&scale>0&&S.scale(scale);var extension="undefined"!=typeof UNMINIFIED&&UNMINIFIED?".js":".min.js",store=qs.store||"TestStore",store_modules=["js/"+store+extension];void 0!==qs.steg&&(useSteganography=!0),useSteganography?(store_modules.push("js/Steganographer"+extension),store_modules.push("js/StegaStore"+extension)):$(".using_steganography").remove(),Utils.load(store_modules,function(){TX.init(function(){init_ui(),init_application()})},function(fails){var e=TX.tx("Javascript module load failed");for(var f in fails)e=e+"<div>"+f+": "+fails[f]+"</div>";$("#init_error").html(e).show()})})}(jQuery,Squirrel);