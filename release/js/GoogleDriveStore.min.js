/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
function GoogleDriveStore(e){"use strict";if(gapi_is_loaded)global.DEBUG&&console.debug("gapi is already loaded"),this._init(e);else{var o=this;gapi_loader=function(){global.DEBUG&&console.debug("Loading GoogleDriveStore"),o._init(e)},$.getScript("https://apis.google.com/js/client.js?onload=gapi_on_load").fail(function(t,i,r){e.fail.call(o,TX.tx("Failed to load Google APIs: $1 $2",r,t.status))})}}function gapi_on_load(){"use strict";global.DEBUG&&console.debug("gapi is loaded"),gapi_is_loaded=!0,gapi_loader&&gapi_loader()}var CLIENT_ID="985219699584-mt1do7j28ifm2vt821d498emarmdukbt.apps.googleusercontent.com",SCOPE="https://www.googleapis.com/auth/drive",gapi_is_loaded=!1,gapi_loader;GoogleDriveStore.prototype=Object.create(AbstractStore.prototype),global.CLOUD_STORE=GoogleDriveStore,GoogleDriveStore.prototype._analyse_error=function(e,o,t){"use strict";var i=o+TX.tx(" failed: ");401===e.status?i+=TX.tx("Your access token has expired, or you are not logged in.")+" "+TX.tx("Please refresh the page in order to save in Google Drive"):e.result?i+=e.result.error.message:i+=e.body,t.call(this,i)},GoogleDriveStore.prototype._init=function(e){"use strict";var o=this,t=window.setTimeout(function(){window.clearTimeout(t),e.fail.call(o,TX.tx("Timeout trying to authorise access to Google Drive.")+" "+TX.tx("Are popups blocked in your browser?"))},2e4),i=function(){global.DEBUG&&console.debug("GoogleDriveStore: drive/v2 loaded"),gapi.client.drive.about.get("name").then(function(t){200===t.status?o.user(t.result.user.displayName):o._analyse_error(t,TX.tx("Google Drive load"),e.fail),AbstractStore.call(o,e)},function(t){o._analyse_error(t,TX.tx("Google Drive load"),e.fail)})},r=function(r){var l;window.clearTimeout(t),r&&!r.fail?(global.DEBUG&&console.debug("GoogleDriveStore: auth OK"),gapi.client.load("drive","v2",i)):(l=null===r?TX.tx("Could not authorise access to Google Drive"):r.fail,e.fail.call(o,l))};global.DEBUG&&console.debug("GoogleDriveStore: authorising"),gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPE},r)};var BOUNDARY="-------314159265358979323846",DELIMITER="\r\n--"+BOUNDARY+"\r\n",RETIMILED="\r\n--"+BOUNDARY+"--";GoogleDriveStore.prototype._getfile=function(e,o,t){"use strict";var i=this,r=gapi.auth.getToken();global.DEBUG&&console.debug("GoogleDriveStore: GET "+e),$.ajax({url:e,method:"GET",dataType:"binary",responseType:"arraybuffer",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+r.access_token)},success:function(e){global.DEBUG&&console.debug("GoogleDriveStore: _getfile OK"),o.call(i,e)},error:function(e,o,r){var l=o+" "+r;global.DEBUG&&console.debug("_getfile failed",l),t.call(i,l)}})},GoogleDriveStore.prototype._follow_path=function(e,o,t,i,r){"use strict";var l=this;if(0===o.length)return void t.call(l,e);var a=o.slice(),n=a.shift(),s=function(){var o={title:n,mimeType:"application/vnd.google-apps.folder"};"root"!==e&&(o.parents=[{id:e}]),global.DEBUG&&console.debug("Creating folder "+n+" under "+e),gapi.client.drive.files.insert(o).then(function(e){var o=e.result.id;l._follow_path(o,a,t,i,!0)},function(e){l._analyse_error(e,TX.tx("Create folder"),i)})},d="title='"+n+"' and '"+e+"' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false";gapi.client.drive.files.list({q:d}).then(function(e){var o=e.result.items;if(o.length>0){var n=o[0].id;global.DEBUG&&console.debug("GoogleDriveStore: found "+d+" at "+n),l._follow_path(n,a,t,i,r)}else global.DEBUG&&console.debug("GoogleDriveStore: could not find "+d),r?s():i.call(l,AbstractStore.NODATA)},function(e){l._analyse_error(e,TX.tx("Follow path"),i)})},GoogleDriveStore.prototype._putfile=function(e,o,t,i,r,l){"use strict";var a=this,n="/upload/drive/v2/files",s="POST",d={uploadType:"multipart",visibility:"PRIVATE"},g={title:o,mimeType:"application/octet-stream"};void 0!==e&&(g.parents=[{id:e}]),void 0!==l&&(n+="/"+l,s="PUT");var c=DELIMITER+"Content-Type: application/json\r\n\r\n"+JSON.stringify(g)+DELIMITER+"Content-Type: application/octet-stream\r\nContent-Transfer-Encoding: base64\r\n\r\n"+Utils.ArrayBufferToBase64(t)+RETIMILED;gapi.client.request({path:n,method:s,params:d,headers:{"Content-Type":'multipart/related; boundary="'+BOUNDARY+'"'},body:c}).then(function(e){i.call(a,e.result)},function(e){a._analyse_error(e,TX.tx("Put"),r)})},GoogleDriveStore.prototype.options=function(){"use strict";return $.extend(AbstractStore.prototype.options(),{needs_path:!0,identifier:"Google Drive"})},GoogleDriveStore.prototype.write=function(e,o,t,i){"use strict";var r=this,l=e.split("/"),a=l.pop(),n=function(e){var l="title='"+a+"' and '"+e+"' in parents and trashed=false";global.DEBUG&&console.debug("GoogleDriveStore: checking existance of "+a),gapi.client.drive.files.list({q:l}).then(function(l){var n,s=l.result.items;s.length>0?(n=s[0].id,global.DEBUG&&console.debug("GoogleDriveStore: updating "+a+" id "+n)):global.DEBUG&&console.debug("GoogleDriveStore: creating "+a+" in "+e),r._putfile(e,a,o,t,i,n)},function(e){r._analyse_error(e,TX.tx("Write"),i)})};global.DEBUG&&console.debug("GoogleDriveStore: following "+e),this._follow_path("root",l,n,i,!0)},GoogleDriveStore.prototype.read=function(e,o,t){"use strict";global.DEBUG&&console.debug("GoogleDriveStore: read "+e);var i=e.split("/"),r=i.pop(),l=this,a=function(e){var i="title='"+r+"' and '"+e+"' in parents and trashed=false";gapi.client.drive.files.list({q:i}).then(function(e){var i=e.result.items;if(i.length>0){var a=i[0].downloadUrl;global.DEBUG&&console.debug("GoogleDriveStore: download found "+r+" at "+a),l._getfile(a,o,t)}else global.DEBUG&&console.debug("GoogleDriveStore: could not find "+r),t.call(l,AbstractStore.NODATA)},function(e){l._analyse_error(e,TX.tx("Read"),t)})};this._follow_path("root",i,a,t,!1)},"undefined"!=typeof module&&(module.exports=GoogleDriveStore);