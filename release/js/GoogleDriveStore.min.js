/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
function GoogleDriveStore(e){"use strict";if(gapi_is_loaded)this._init(e);else{var t=this;gapi_loader=function(){t._init(e)},$.getScript("https://apis.google.com/js/client.js?onload=gapi_on_load").fail(function(o,i,r){e.fail.call(t,TX.tx("Failed to load Google APIs: $1 $2",r,o.status))})}}function gapi_on_load(){"use strict";gapi_is_loaded=!0,gapi_loader&&gapi_loader()}var gapi_loader,CLIENT_ID="985219699584-mt1do7j28ifm2vt821d498emarmdukbt.apps.googleusercontent.com",SCOPE="https://www.googleapis.com/auth/drive",gapi_is_loaded=!1;GoogleDriveStore.prototype=Object.create(AbstractStore.prototype),SQUIRREL_STORE=GoogleDriveStore,GoogleDriveStore.prototype._analyse_error=function(e,t,o){"use strict";var i=t+TX.tx(" failed: ");401===e.status?i+=TX.tx("Your access token has expired, or you are not logged in.")+" "+TX.tx("Please refresh the page in order to save in Google Drive"):e.result?i+=e.result.error.message:i+=e.body,o.call(this,i)},GoogleDriveStore.prototype._init=function(e){"use strict";var t=this,o=window.setTimeout(function(){window.clearTimeout(o),e.fail.call(t,TX.tx("Timeout trying to authorise access to Google Drive.")+" "+TX.tx("Are popups blocked in your browser?"))},2e4),i=function(){gapi.client.drive.about.get("name").then(function(o){200===o.status?t.user(o.result.user.displayName):t._analyse_error(o,TX.tx("Google Drive load"),e.fail),AbstractStore.call(t,e)},function(o){t._analyse_error(o,TX.tx("Google Drive load"),e.fail)})};gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPE},function(r){var a;window.clearTimeout(o),r&&!r.fail?gapi.client.load("drive","v2",i):(a=null===r?TX.tx("Could not authorise access to Google Drive"):r.fail,e.fail.call(t,a))})};var BOUNDARY="-------314159265358979323846",DELIMITER="\r\n--"+BOUNDARY+"\r\n",RETIMILED="\r\n--"+BOUNDARY+"--";GoogleDriveStore.prototype._getfile=function(e,t,o){"use strict";var i=this,r=gapi.auth.getToken();$.ajax({url:e,method:"GET",dataType:"binary",responseType:"arraybuffer",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+r.access_token)},success:function(e){t.call(i,e)},error:function(e,t,r){var a=t+" "+r;o.call(i,a)}})},GoogleDriveStore.prototype._follow_path=function(e,t,o,i,r){"use strict";var a=this;if(0!==t.length){var n=t.slice(),l=n.shift(),s="title='"+l+"' and '"+e+"' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false";gapi.client.drive.files.list({q:s}).then(function(t){var s=t.result.items;if(s.length>0){var p=s[0].id;a._follow_path(p,n,o,i,r)}else r?function(){var t={title:l,mimeType:"application/vnd.google-apps.folder"};"root"!==e&&(t.parents=[{id:e}]),gapi.client.drive.files.insert(t).then(function(e){var t=e.result.id;a._follow_path(t,n,o,i,!0)},function(e){a._analyse_error(e,TX.tx("Create folder"),i)})}():i.call(a,AbstractStore.NODATA)},function(e){a._analyse_error(e,TX.tx("Follow path"),i)})}else o.call(a,e)},GoogleDriveStore.prototype._putfile=function(e,t,o,i,r,a){"use strict";var n=this,l="/upload/drive/v2/files",s="POST",p={title:t,mimeType:"application/octet-stream"};void 0!==e&&(p.parents=[{id:e}]),void 0!==a&&(l+="/"+a,s="PUT");var c=DELIMITER+"Content-Type: application/json\r\n\r\n"+JSON.stringify(p)+DELIMITER+"Content-Type: application/octet-stream\r\nContent-Transfer-Encoding: base64\r\n\r\n"+Utils.ArrayBufferToBase64(o)+RETIMILED;gapi.client.request({path:l,method:s,params:{uploadType:"multipart",visibility:"PRIVATE"},headers:{"Content-Type":'multipart/related; boundary="'+BOUNDARY+'"'},body:c}).then(function(e){i.call(n,e.result)},function(e){n._analyse_error(e,TX.tx("Put"),r)})},GoogleDriveStore.prototype.options=function(){"use strict";return $.extend(AbstractStore.prototype.options(),{needs_path:!0,identifier:"Google Drive"})},GoogleDriveStore.prototype.write=function(e,t,o,i){"use strict";var r=this,a=e.split("/"),n=a.pop();this._follow_path("root",a,function(e){var a="title='"+n+"' and '"+e+"' in parents and trashed=false";gapi.client.drive.files.list({q:a}).then(function(a){var l,s=a.result.items;s.length>0&&(l=s[0].id),r._putfile(e,n,t,o,i,l)},function(e){r._analyse_error(e,TX.tx("Write"),i)})},i,!0)},GoogleDriveStore.prototype.read=function(e,t,o){"use strict";var i=e.split("/"),r=i.pop(),a=this;this._follow_path("root",i,function(e){var i="title='"+r+"' and '"+e+"' in parents and trashed=false";gapi.client.drive.files.list({q:i}).then(function(e){var i=e.result.items;if(i.length>0){var r=i[0].downloadUrl;a._getfile(r,t,o)}else o.call(a,AbstractStore.NODATA)},function(e){a._analyse_error(e,TX.tx("Read"),o)})},o,!1)};