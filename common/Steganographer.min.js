/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
function Steganographer(image,maxChunk){"use strict";this.maxChunk=maxChunk||3,"string"==typeof image?(this.image=new Image,this.image.src=image):this.image=image}Steganographer.prototype.adjustToFit=function(size){"use strict";var bits=8*size,slots=3*this.image.naturalWidth*this.image.naturalHeight-6,chunkSize=bits/slots+1>>0;if(DEBUG&&console.debug("Storage required "+bits+" bits, "+size+" bytes Max image capacity "+this.maxChunk*slots+" bits, "+this.maxChunk*slots/8+" bytes"),chunkSize>this.maxChunk)throw DEBUG&&console.debug("Steg: Computed chunk size "+chunkSize+" is > "+this.maxChunk+", oversized by "+-slots*(this.maxChunk-chunkSize)+" bits"),slots*(chunkSize-this.maxChunk)+" bits too many to hide in this image";return DEBUG&&console.debug("Steg: Computed chunk size "+chunkSize+" ("+slots+" slots)"),chunkSize},Steganographer.prototype.inject=function(message){var a8=new Uint8Array(message);DEBUG&&console.debug("Steg: Embedding "+a8.length+" bytes ("+8*a8.length+" bits)");var shadowCanvas=document.createElement("canvas");shadowCanvas.style.display="none",shadowCanvas.width=this.image.naturalWidth,shadowCanvas.height=this.image.naturalHeight;var shadowCtx=shadowCanvas.getContext("2d");shadowCtx.drawImage(this.image,0,0);for(var imageData=shadowCtx.getImageData(0,0,shadowCanvas.width,shadowCanvas.height),iData=imageData.data,i=3;i<iData.length;i+=4)iData[i]=255;var a8_i,a8_iM1,bits,a8_len=a8.length,chunkSize=this.adjustToFit(a8_len),byte_i=24,chunkMask=(1<<chunkSize)-1,iChunkMask=~chunkMask,numChunks=0,addChunk=function(c){iData[byte_i]=iData[byte_i]&iChunkMask|c,byte_i++,byte_i%4===3&&byte_i++,numChunks++},pending=0;for(i=0;a8_len>i;i++){for(a8_i=a8[i],bits=8,pending>0&&(addChunk(a8_iM1&chunkMask>>chunkSize-pending|(a8_i&chunkMask>>pending)<<pending),a8_i>>=chunkSize-pending,bits-=chunkSize-pending);bits>=chunkSize;)addChunk(a8_i&chunkMask),a8_i>>=chunkSize,bits-=chunkSize;pending=bits,a8_iM1=a8_i}pending>0&&addChunk(a8_iM1),byte_i=0;for(var shift=30;shift>=0;)for(var channel=0;3>channel&&shift>=0;channel++)iData[byte_i]=252&iData[byte_i]|numChunks>>shift&3,shift-=2,byte_i++,byte_i%4===3&&byte_i++;return iData[byte_i]=252&iData[byte_i]|chunkSize>>2&3,byte_i++,iData[byte_i]=252&iData[byte_i]|3&chunkSize,byte_i+=2,DEBUG&&console.debug("Steg: Embedded "+numChunks+" chunks of "+chunkSize+" bits, "+numChunks*chunkSize+" bits / "+numChunks*chunkSize/8+" bytes of data"),imageData.data=iData,shadowCtx.putImageData(imageData,0,0),shadowCanvas},Steganographer.prototype.extract=function(){"use strict";var shadowCanvas=document.createElement("canvas");shadowCanvas.style.display="none",shadowCanvas.width=this.image.naturalWidth,shadowCanvas.height=this.image.naturalHeight;var shadowCtx=shadowCanvas.getContext("2d");shadowCtx.drawImage(this.image,0,0);for(var imageData=shadowCtx.getImageData(0,0,shadowCanvas.width,shadowCanvas.height),iData=imageData.data,numChunks=0,byte_i=0,i=0;32>i;i+=2)numChunks=numChunks<<2|3&iData[byte_i],byte_i++,byte_i%4===3&&byte_i++;var chunkSize=(3&iData[byte_i++])<<2;if(chunkSize|=3&iData[byte_i],byte_i+=2,0>numChunks||numChunks>iData.length||0>=chunkSize||chunkSize>8)throw"No message embedded";var message=new Uint8Array(numChunks*chunkSize>>3);DEBUG&&console.debug("Steg: Extracting "+numChunks+" chunks of "+chunkSize+" bits, "+numChunks*chunkSize+" bits / "+numChunks*chunkSize/8+" bytes of data");var charCode=0,bitCount=0,mi=0,chunkMask=(1<<chunkSize)-1;for(i=0;numChunks>i;i++){var mmi=iData[byte_i++]&chunkMask;byte_i%4===3&&byte_i++,charCode|=mmi<<bitCount,bitCount+=chunkSize,bitCount>=8&&(message[mi++]=255&charCode,bitCount%=8,charCode=mmi>>chunkSize-bitCount)}return numChunks*chunkSize>>3>mi&&(message[mi++]=255&charCode),DEBUG&&console.debug("Steg: Extracted "+message.length+" bytes"),message.buffer};
//# sourceMappingURL=Steganographer.map