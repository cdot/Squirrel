function Hoard(data){"use strict";data?(this.last_sync=data.last_sync,this.actions=data.actions,this.cache=data.cache,this.options=data.options):(this.last_sync=null,this.clear_actions(),this.cache=null),"undefined"==typeof this.options&&(this.options={autosave:!1,store_path:null})}Hoard.stringify_action=function(action){"use strict";return action.type+":"+action.path.join("/")+("undefined"!=typeof action.data?" '"+action.data+"'":"")+" @"+new Date(action.time).toLocaleString()},Hoard.prototype.clear_actions=function(){"use strict";this.actions=[]},Hoard.prototype.record_action=function(e,listener,no_push){"use strict";var parent,name,i,c;for(("undefined"==typeof e.time||null===e.time)&&(e.time=Date.now()),no_push||this.actions.push({type:e.type,path:e.path.slice(),time:e.time,data:e.data}),parent=this.cache,i=0;i<e.path.length-1;i++)if(name=e.path[i],parent&&"string"==typeof parent.data);else{if(!parent||!parent.data[name])return{conflict:e,message:"'"+e.path.slice(0,i+1).join("/")+"' "+TX.tx("does not exist")};parent=parent.data[name]}switch(name=e.path[i],parent||(parent=this.cache={data:{}}),c=function(mess){return{conflict:e,message:mess}},e.type){case"N":if(parent.data[name])return c(TX.tx("Cannot create, '$1' already exists",e.path.join("/")));parent.time=e.time,parent.data[name]={time:e.time,data:"string"==typeof e.data?e.data:{}};break;case"D":if(!parent.data[name])return c(TX.tx("Cannot delete, '$1' does not exist",e.path.join("/")));delete parent.data[name];break;case"R":if(!parent.data[name])return c(TX.tx("Cannot rename, '$1' does not exist",e.path.join("/")));if(parent.data[e.data])return c(TX.tx("Cannot rename '$1', '$2' already exists",e.path.join("/"),e.data));parent.data[e.data]=parent.data[name],delete parent.data[name];break;case"E":if(!parent.data[name])return c(TX.tx("Cannot change value, '$1' does not exist",e.path.join("/")));parent.data[name].data=e.data;break;case"A":if(!parent.data[name])return c(TX.tx("Cannot set reminder, '$1' does not exist",e.path.join("/")));parent.data[name].alarm=e.data;break;case"C":if(!parent.data[name])return c(TX.tx("Cannot cancel reminder, '$1' does not exist",e.path.join("/")));delete parent.data[name].alarm}return listener&&listener.call(this,e),null},Hoard.prototype.simplify=function(chain){"use strict";if(this.cache=null,this.actions)for(var i=0;i<this.actions.length;i++){this.record_action(this.actions[i],!1,!0)}this.actions=[],this.cache?(this._reconstruct_actions(this.cache.data,[],function(e){this.actions.push({type:e.type,time:e.time,data:e.data,path:e.path.slice()})},chain),this.cache=null):chain&&chain()},Hoard.prototype._reconstruct_actions=function(data,path,listener,chain){"use strict";var self=this,queue=[],handle_node=function(node,p,ready){var time="undefined"!=typeof node.time?node.time:Date.now();return"string"==typeof node.data?void listener.call(self,{type:"N",path:p,time:time,data:node.data},function(){node.alarm&&listener.call(self,{type:"A",path:p.slice(),time:time,data:node.alarm}),ready()}):void("undefined"!=typeof node.data&&(p.length>0?listener.call(self,{type:"N",time:time,path:p},ready):ready()))},list_nodes=function(q,node,pat){var key,p;if(q.push(function(ready){handle_node(node,pat,ready)}),"object"==typeof node.data)for(key in node.data)p=pat.slice(),p.push(key),list_nodes(q,node.data[key],p)};list_nodes(queue,data,path.slice()),queue.push(chain),Utils.execute_queue(queue)},Hoard.prototype.actions_from_hierarchy=function(data,listener,chain){"use strict";this._reconstruct_actions(data,[],listener,chain)},Hoard.prototype.reconstruct_actions=function(listener,chain){"use strict";this.cache?this.actions_from_hierarchy(this.cache,listener,chain):chain()},Hoard.prototype.merge_from_cloud=function(cloud,listener,chain){"use strict";var i,c,local_actions=this.actions,conflicts=[];for(this.actions=[],i=0;i<cloud.actions.length;i++)cloud.actions[i].time>this.last_sync&&(c=this.record_action(cloud.actions[i],listener,!0),null!==c&&conflicts.push(c));this.actions=local_actions,this.last_sync=Date.now(),chain&&chain(conflicts)},Hoard.prototype.get_node=function(path){"use strict";var i,node=this.cache;for(i=0;i<path.length;i++){if("string"==typeof node.data)return null;node=node.data[path[i]]}return node};const MSDAY=864e5;Hoard.prototype.each_alarm=function(){"use strict";for(var self=this,alarum=function(){self.each_alarm()};this.check&&this.check.queue.length>0;){var name,item=this.check.queue.pop(),node=item.node;if("object"==typeof node.data)for(name in node.data){var snode=node.data[name];this.check.queue.push({node:snode,path:item.path.slice().concat([name])})}if("undefined"!=typeof node.alarm&&Date.now()-node.time>=node.alarm*MSDAY)return void this.check.alarm(item.path,new Date(node.time+node.alarm*MSDAY),alarum)}delete this.check},Hoard.prototype.check_alarms=function(callback){"use strict";this.cache&&(this.check={queue:[{path:[],node:this.cache}],alarm:callback},this.each_alarm())};
//# sourceMappingURL=Hoard.map