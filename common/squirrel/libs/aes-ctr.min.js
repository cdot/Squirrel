"use strict";if("undefined"!=typeof module&&module.exports)var Aes=require("./aes");Aes.Ctr={},Aes.Ctr.encrypt=function(plaintext,password,nBits){var blockSize=16;if(128!=nBits&&192!=nBits&&256!=nBits)return"";plaintext=String(plaintext).utf8Encode(),password=String(password).utf8Encode();for(var nBytes=nBits/8,pwBytes=new Array(nBytes),i=0;nBytes>i;i++)pwBytes[i]=isNaN(password.charCodeAt(i))?0:password.charCodeAt(i);var key=Aes.cipher(pwBytes,Aes.keyExpansion(pwBytes));key=key.concat(key.slice(0,nBytes-16));for(var counterBlock=new Array(blockSize),nonce=(new Date).getTime(),nonceMs=nonce%1e3,nonceSec=Math.floor(nonce/1e3),nonceRnd=Math.floor(65535*Math.random()),i=0;2>i;i++)counterBlock[i]=nonceMs>>>8*i&255;for(var i=0;2>i;i++)counterBlock[i+2]=nonceRnd>>>8*i&255;for(var i=0;4>i;i++)counterBlock[i+4]=nonceSec>>>8*i&255;for(var ctrTxt="",i=0;8>i;i++)ctrTxt+=String.fromCharCode(counterBlock[i]);for(var keySchedule=Aes.keyExpansion(key),blockCount=Math.ceil(plaintext.length/blockSize),ciphertxt=new Array(blockCount),b=0;blockCount>b;b++){for(var c=0;4>c;c++)counterBlock[15-c]=b>>>8*c&255;for(var c=0;4>c;c++)counterBlock[15-c-4]=b/4294967296>>>8*c;for(var cipherCntr=Aes.cipher(counterBlock,keySchedule),blockLength=blockCount-1>b?blockSize:(plaintext.length-1)%blockSize+1,cipherChar=new Array(blockLength),i=0;blockLength>i;i++)cipherChar[i]=cipherCntr[i]^plaintext.charCodeAt(b*blockSize+i),cipherChar[i]=String.fromCharCode(cipherChar[i]);ciphertxt[b]=cipherChar.join("")}var ciphertext=ctrTxt+ciphertxt.join("");return ciphertext=ciphertext.base64Encode()},Aes.Ctr.decrypt=function(ciphertext,password,nBits){var blockSize=16;if(128!=nBits&&192!=nBits&&256!=nBits)return"";ciphertext=String(ciphertext).base64Decode(),password=String(password).utf8Encode();for(var nBytes=nBits/8,pwBytes=new Array(nBytes),i=0;nBytes>i;i++)pwBytes[i]=isNaN(password.charCodeAt(i))?0:password.charCodeAt(i);var key=Aes.cipher(pwBytes,Aes.keyExpansion(pwBytes));key=key.concat(key.slice(0,nBytes-16));for(var counterBlock=new Array(8),ctrTxt=ciphertext.slice(0,8),i=0;8>i;i++)counterBlock[i]=ctrTxt.charCodeAt(i);for(var keySchedule=Aes.keyExpansion(key),nBlocks=Math.ceil((ciphertext.length-8)/blockSize),ct=new Array(nBlocks),b=0;nBlocks>b;b++)ct[b]=ciphertext.slice(8+b*blockSize,8+b*blockSize+blockSize);ciphertext=ct;for(var plaintxt=new Array(ciphertext.length),b=0;nBlocks>b;b++){for(var c=0;4>c;c++)counterBlock[15-c]=b>>>8*c&255;for(var c=0;4>c;c++)counterBlock[15-c-4]=(b+1)/4294967296-1>>>8*c&255;for(var cipherCntr=Aes.cipher(counterBlock,keySchedule),plaintxtByte=new Array(ciphertext[b].length),i=0;i<ciphertext[b].length;i++)plaintxtByte[i]=cipherCntr[i]^ciphertext[b].charCodeAt(i),plaintxtByte[i]=String.fromCharCode(plaintxtByte[i]);plaintxt[b]=plaintxtByte.join("")}var plaintext=plaintxt.join("");return plaintext=plaintext.utf8Decode()},"undefined"==typeof String.prototype.utf8Encode&&(String.prototype.utf8Encode=function(){return unescape(encodeURIComponent(this))}),"undefined"==typeof String.prototype.utf8Decode&&(String.prototype.utf8Decode=function(){try{return decodeURIComponent(escape(this))}catch(e){return this}}),"undefined"==typeof String.prototype.base64Encode&&(String.prototype.base64Encode=function(){if("undefined"!=typeof btoa)return btoa(this);if("undefined"!=typeof Buffer)return new Buffer(this,"utf8").toString("base64");throw new Error("No Base64 Encode")}),"undefined"==typeof String.prototype.base64Decode&&(String.prototype.base64Decode=function(){if("undefined"!=typeof atob)return atob(this);if("undefined"!=typeof Buffer)return new Buffer(this,"base64").toString("utf8");throw new Error("No Base64 Decode")}),"undefined"!=typeof module&&module.exports&&(module.exports=Aes.Ctr),"function"==typeof define&&define.amd&&define(["Aes"],function(){return Aes.Ctr});