/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
!function($,S){"use strict";var SD=S.Dialog,ST=S.Tree;SD.squeak_more=function(p){$(".squeak-while").remove(),"string"==typeof p&&(p={message:p,severity:"notice"}),p.severity||(p.severity="notice"),$("#squeak_message").append($("<div class='squeak-"+p.severity+"'></div>").append(p.message))},SD.play_action=function(action){var res=S.client.hoard.record_action(action,function(e){S.Tree.action(e,function(){Utils.sometime("update_save")},!0)});null!==res&&SD.squeak({title:TX.error(),severity:"error",message:res.message})},SD.login=function(options){var $dlg=$("#login");$("#login_uReq").toggle(options.user_required),$("#login_pReq").toggle(options.pass_required);var $user=$("#login_user"),$pass=$("#login_pass"),$signin=$("#login_signin"),sign_in=function(){return SD.close_dialog($dlg),$signin.off(SD.click),$user.off("change"),$pass.off("change"),options.on_signin.call(options.store,$user.val(),$pass.val()),!0};$signin.off(SD.click).click("p",sign_in),$user.off("change").val(options.store.user()),$pass.off("change").val(options.store.pass()),options.user_required&&($user.attr("autofocus","autofocus"),options.pass_required?$user.off("change").on("change",function(){$pass.focus()}):$user.off("change").on("change",sign_in)),options.pass_required&&($("#login_foruser").toggle(null!==options.store.user()).text(options.store.user()||""),$pass.attr("autofocus","autofocus"),options.user_required?$pass.on("change",function(){$signin.focus()}):$pass.on("change",sign_in)),$dlg.hasClass("hidden")&&SD.init_dialog($dlg),SD.open_dialog($dlg)},SD.delete_node=function($node){var $dlg=$("#delete_node");$dlg.data("node",$node),$dlg.hasClass("hidden")&&($("#delete_node_ok").click(function(){SD.close_dialog($dlg);var res=S.client.hoard.record_action({type:"D",path:$dlg.data("node").treenode("get_path")},function(e){ST.action(e,function(){Utils.sometime("update_save")},!0)});return null!==res?(SD.squeak({title:TX.error(),severity:"error",message:res.message}),!1):!0}),$("#delete_node_cancel").click(function(){return SD.close_dialog($dlg),!1}),SD.init_dialog($dlg)),$("#delete_node_path").text($node.treenode("get_path").join("/")),$("#delete_node_coll").toggle(!$node.hasClass("treenode-leaf")),SD.open_dialog($dlg)},SD.about=function(){var $dlg=$("#about");$dlg.hasClass("hidden")&&SD.init_dialog($dlg),SD.open_dialog($dlg)},SD.pick=function($node){var $dlg=$("#pick");$dlg.hasClass("hidden")&&($("#pick_clear").click(function(){$dlg.find(".picked").removeClass("picked")}),$dlg.removeClass("hidden").popup({history:!1}));var i,$f,val=$node.find(".value:first").text(),$which=$("#pick_which"),$from=$("#pick_from");$("#pick").find(".pick_cell").remove();var item_clicked=function(){var ii=$(this).data("i");$dlg.find("td.i"+ii).addClass("picked")};for(i=0;i<val.length;i++)$f=$from.children("td.i"+i),0===$f.length&&($("<td></td>").data("i",i).addClass("pick_cell i"+i).text(i+1).click(item_clicked).appendTo($which),$f=$("<td></td>").data("i",i).addClass("pick_cell i"+i).click(item_clicked).appendTo($from)),$f.text(val.charAt(i));for(;i<$from.children("td").length;)$from.children("td").last().remove(),i++;$dlg.find(".picked").removeClass("picked"),SD.open_dialog($dlg)},SD.randomise=function($node){var $dlg=$("#randomise");$dlg.data("node",$node),$dlg.hasClass("hidden")&&($("#randomise_again").click(function(){return $("#randomise_idea").text(Utils.generate_password({length:$("#randomise_len").val(),charset:$("#randomise_chs").val()})),!1}),$("#randomise_use").click(function(){return SD.close_dialog($dlg),SD.play_action({type:"E",path:$dlg.data("node").treenode("get_path"),data:$("#randomise_idea").text()}),!0}),SD.init_dialog($dlg));var path=$node.treenode("get_path");$("#randomise_path").text(path.join("/")),$("#randomise_key").text($node.find(".key:first").text()),$("#randomise_again").trigger("click"),SD.open_dialog($dlg)},SD.search=function(){var $dlg=$("#search");$dlg.hasClass("hidden")&&($("#search_ok").click(function(){SD.close_dialog($dlg),S.search($("#search_string").val())}),$("#search_string").on("change",function(){$("#search_ok").trigger(SD.click)}),SD.init_dialog($dlg)),SD.open_dialog($dlg)};var unit_names=["y","m","w","d"],units_days={y:365,m:30,w:7,d:1},ms_in_day=864e5;SD.alarm=function($node){var $dlg=$("#alarm");$dlg.hasClass("hidden")&&($dlg.data("update_next",function(){var numb=$("#alarm_number").val();numb*=units_days[$("#alarm_units").val()];var elapsed=Math.round((Date.now()-$dlg.data("node").data("last-time"))/ms_in_day);numb>elapsed&&(numb-=elapsed),$dlg.find(".alarm_next").hide();for(var uns="d",ui=0;ui<unit_names.length;ui++){var un=units_days[unit_names[ui]];if(numb%un===0){numb/=un,uns=unit_names[ui];break}}$("#alarm_next").text(numb),$dlg.find(".alarm_next."+uns).show()}),$("#alarm_units").on("change",function(){$dlg.data("update_next").call()}),$("#alarm_number").on("change",function(){$dlg.data("update_next").call()}),$("#alarm_set").click(function(){SD.close_dialog($dlg);var numb=$("#alarm_number").val()*units_days[$("#alarm_units").val()];return SD.play_action({type:"A",path:$dlg.data("node").treenode("get_path"),data:numb}),!1}),$("#alarm_clear").click(function(){return SD.play_action({type:"C",path:$dlg.data("node").treenode("get_path")}),SD.close_dialog($dlg),!1}),SD.init_dialog($dlg));var number=6,units="m";if("undefined"!=typeof $node.data("alarm")){number=$node.data("alarm"),units="d";for(var i=0;i<unit_names.length;i++){var n=units_days[unit_names[i]];if(number%n===0){number/=n,units=unit_names[i];break}}}$("#alarm_path").text($node.treenode("get_path").join("/")),$("#alarm_number").val(number),$("#alarm_units option[value='"+units+"']").attr("selected","selected"),$dlg.data("node",$node),$dlg.data("update_next").call(),SD.open_dialog($dlg)},SD.ss_change_image=function(){var fail=function(e){$("#store_settings_message").text(TX.tx("Cannot use this image because of this error: $1",e))},file=$(this)[0].files[0];Utils.read_file(file,function(data){data="data:"+file.type+";base64,"+Utils.ArrayBufferToBase64(data),data!==$("#stegamage").attr("src",data)&&$("#stegamage").attr("src",data).off("load").on("load",function(){$(this).off("load");var steg=new Steganographer(this);try{steg.inject("tada")}catch(e){return DEBUG&&console.debug("Caught "+e),void fail(e)}$("#store_settings #ok").attr("disabled",!1);var h=this.naturalHeight,w=this.naturalWidth;this.height=100,$("#store_settings_message").html("<br>"+w+" x "+h),S.client.status===S.IS_LOADED&&(S.client.status=S.NEW_SETTINGS),S.cloud.status===S.IS_LOADED&&(S.cloud.status=S.NEW_SETTINGS),Utils.sometime("update_save")})},fail,"arraybuffer")},SD.store_settings=function(chain){var $dlg=$("#store_settings");$dlg.hasClass("hidden")&&($("#store_settings_file").hide().click(function(){SD.ss_change_image()}),$("#store_settings_choose_image").click(function(e){$("#store_settings_file").trigger("change",e)}),$("#store_settings_storepath").on("keyup",function(){return""===$("#store_settings_storepath").val()?($("#store_settings_message").text(TX.tx("Store path may not be empty")),!1):(S.client.hoard.options.store_path!==$("#store_settings_storepath").val()&&(S.client.hoard.options.store_path=$("#store_settings_storepath").val(),S.client.status===S.IS_LOADED&&(S.client.status=S.NEW_SETTINGS),Utils.sometime("update_save")),!0)}),$("#store_settings_ok").click(function(){if(""===$("#store_settings_storepath").val())return $("#store_settings_message").text(TX.tx("Store path may not be empty")),!1;SD.close_dialog($dlg);var cb=$dlg.data("callback");"function"==typeof cb&&cb()}),SD.init_dialog($dlg)),$("#store_settings_message").empty(),$dlg.data("callback",chain),$("#store_settings_storepath").val(S.client.hoard.options.store_path),SD.open_dialog($dlg)},SD.chpw=function(){var $dlg=$("#chpw");$dlg.hasClass("hidden")&&($("#chpw_show").on("change",function(){$("#chpw_show").prop("checked")?($("#chpw_pass").attr("type","text"),$("#chpw_conf").attr("type","text")):($("#chpw_pass").attr("type","password"),$("#chpw_conf").attr("type","password"))}),$dlg.data("validate",function(){var p=$("#chpw_pass").val(),c=$("#chpw_conf").val();return $("#chpw_nomatch").toggle(p!==c),p===c}),$("#chpw_conf").on("change",function(){$dlg.data("validate").call()}),SD.init_dialog($dlg)),$dlg.data("validate").call(),$("#chpw_set").click(function(){if(!$dlg.data("validate").call())return!1;SD.close_dialog($dlg);var p=$("#chpw_pass").val();return S.client.store.pass(p),S.client.status=S.NEW_SETTINGS,S.cloud.store.pass(p),S.cloud.status=S.NEW_SETTINGS,Utils.sometime("update_save"),!0}),SD.open_dialog($dlg)},SD.json=function(){var $dlg=$("#json");$dlg.hasClass("hidden")&&($("#json_text").on("input",function(){$("#json_ok").prop("disabled",!1)}),$("#json_ok").click(function(){SD.close_dialog($dlg);var datum;try{datum=JSON.parse($("#json_text").val())}catch(e){return SD.squeak({title:TX.tx("JSON could not be parsed"),severity:"error",message:e}),!1}return $("#json_ok").prop("disabled",!0),DEBUG&&console.debug("Importing..."),S.insert_data([],datum),!0}),$("#json_close").click(function(){SD.close_dialog($dlg)}),SD.init_dialog($dlg));var data=S.client.hoard.JSON();$("#json_text").text(data).select(),$("#json_ok").prop("disabled",!0),SD.open_dialog($dlg)},SD.extras=function(){var $dlg=$("#extras");$dlg.hasClass("hidden")&&($("#extras_autosave").on("change",function(){S.client.hoard.options.autosave="on"===$("#extras_autosave").val(),Utils.sometime("update_save")}),$("#extras_chpw").click(function(){SD.close_dialog($dlg),SD.chpw()}),$("#extras_chss").click(function(){SD.close_dialog($dlg),SD.store_settings()}),$("#extras_json").click(function(){SD.close_dialog($dlg),SD.json()}),$("#extras_about").click(function(){SD.close_dialog($dlg),SD.about()}),SD.init_dialog($dlg)),S.USE_STEGANOGRAPHY||S.cloud.store&&S.cloud.store.options().needs_path||$("#extras_chss").hide(),$("#extras_autosave").val(S.client.hoard.options.autosave?"on":"off"),SD.open_dialog($dlg)}}(jQuery,Squirrel);
//# sourceMappingURL=Dialogs.map