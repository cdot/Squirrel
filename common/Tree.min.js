/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
!function($,S){"use strict";var ST=S.Tree,SD=S.Dialog;ST.cache={},ST.undos=[],$.widget("squirrel.treenode",{_create:function(){var parent,$parent,$node=$(this.element),is_leaf=!1,is_root=!this.options.path,key="";if(is_root||(parent=this.options.path,key=parent.pop(),$parent=ST.get_node(parent),$node.data("key",key)),$node.addClass("treenode"),is_root)ST.cache[""]=$node,$node.addClass("treenode-root");else if("undefined"!=typeof this.options.value&&null!==this.options.value)$node.data("value",this.options.value).data("is_leaf",!0).addClass("treenode-leaf"),is_leaf=!0;else{var $control=$("<button></button>").addClass("open-close");$node.prepend($control).treenode("icon_button","create",$control,"closed",function(){return $node.treenode("toggle"),!1}).addClass("treenode-open")}if(!is_root){var $key=$("<span></span>").addClass("key").text(key),$div=$("<div></div>").addClass("treenode-info").appendTo($node).append($key);if(is_leaf){$("<span> : </span>").addClass("kv_separator").appendTo($div);{$("<span></span>").appendTo($div).addClass("value").text(this.options.value)}}}if(is_leaf||$node.addClass("treenode-collection").append("<ul class='treenode-subnodes'></ul>"),$node.treenode("toggle"),$parent){var inserted=!1,$container=$parent.find("ul").first();$container.children(".treenode").each(function(){return ST.compare($(this).data("key"),key)>0?($node.insertBefore($(this)),inserted=!0,!1):void 0}),inserted||$container.append($node)}$node.treenode("attach_handlers"),"undefined"!=typeof this.options.time&&$node.treenode("set_modified",this.options.time),this.options.on_create&&this.options.on_create.call($node)},toggle:function(){var $node=$(this.element);return $node.treenode($node.hasClass("treenode-open")?"close":"open")},open:function(){var $node=$(this.element);return $node.hasClass("treenode-open")?$node:$node.addClass("treenode-open").treenode("icon_button","change",".open-close:first","open").children(".treenode-subnodes").scroll_into_view().show()},close:function(){var $node=$(this.element);return $node.hasClass("treenode-open")?$node.removeClass("treenode-open").treenode("icon_button","change",".open-close:first","closed").children(".treenode-subnodes").hide():$node},icon_button:function(){throw"Expected icon_button to be subclassed"},attach_handlers:function(){throw"Expected attach_handlers to be subclassed"},edit:function(what){var $node=$(this.element),$span=$node.find("."+what).first(),w=$("#sites-node").width();$span.parents().each(function(){w-=$(this).position().left}),$span.edit_in_place({width:w,changed:function(s){var e=S.client.hoard.record_action({type:"key"===what?"R":"E",path:$node.treenode("get_path"),data:s},function(ea){ST.action(ea,function(){Utils.sometime("update_save")},!0)});null!==e&&SD.squeak(e.message)}})},refresh:function(){},set_alarm:function(data){var $node=$(this.element);if("undefined"==typeof $node.data("alarm")){var $button=$("<button></button>").addClass("alarm");$node.find(".key").first().before($button),$node.treenode("icon_button","create",$button,"alarm",function(){return SD.alarm($node),!1})}$node.data("alarm",data)},cancel_alarm:function(){return $(this.element).removeData("alarm").treenode("icon_button","destroy",".alarm:first")},ring_alarm:function(){return $(this.element).find(".alarm").addClass("expired").find(".ui-icon-squirrel-alarm").removeClass("ui-icon-squirrel-alarm").addClass("ui-icon-squirrel-rang")},set_modified:function(time){var d=new Date(time);return $(this.element).addClass("modified").data("last-time",time).data("last-mod",d.toLocaleString())},get_path:function(){var $node=$(this.element);$node.hasClass("treenode")||($node=$node.closest(".treenode"));var path,ps=$node.data("path");return"undefined"!=typeof ps&&null!==ps?ps.split(S.PATHSEP):("undefined"!=typeof $node.data("key")?(path=$node.parent().closest(".treenode").treenode("get_path"),path.push($node.data("key")),ps=path.join(S.PATHSEP),$node.data("path",ps),ST.cache[ps]=$node):path=[],path)}}),ST.get_node=function(path){var $node=ST.cache[path.join(S.PATHSEP)];return $node},ST.compare=function(a,b){return a=a.toLowerCase(),b=b.toLowerCase(),"user"===a?"user"===b?0:-1:"user"===b?1:"pass"===a?"pass"===b?0:-1:"pass"===b?1:a===b?0:b>a?-1:1},ST.action_N=function(action,undoable,follow){$("<li></li>").treenode({path:action.path,value:action.data,time:action.time,on_create:function(){var path=$(this).treenode("get_path");undoable&&ST.undos.push({type:"D",path:path}),follow.call(this)}})},ST.action_E=function(action,undoable,follow){var $node=ST.get_node(action.path);undoable&&ST.undos.push({type:"E",path:action.path.slice(),data:$node.find(".value").first().text()}),$node.find(".value").first().text(action.data),$node.treenode("set_modified",action.time),follow.call($node)},ST.action_D=function(action,undoable,follow){var $node=ST.get_node(action.path);ST.demap($node),undoable&&ST.undos.push({type:"N",path:action.path.slice(),data:$node.find(".value").first().text()});var $parent=$node.parent().closest(".treenode");$parent.treenode("set_modified",action.time),$node.remove(),follow.call($node)},ST.action_A=function(action,undoable,follow){var $node=ST.get_node(action.path),alarm=$node.data("alarm");"undefined"!=typeof alarm?alarm!==action.data&&(undoable&&ST.undos.push({type:"A",path:action.path.slice(),data:$node.data("alarm")}),$node.treenode("set_modified",action.time)):($node.treenode("set_modified",action.time),undoable&&ST.undos.push({type:"C",path:action.path.slice()})),$node.treenode("set_alarm",action.data),follow.call($node)},ST.action_C=function(action,undoable,follow){var $node=ST.get_node(action.path),alarm=$node.data("alarm");"undefined"!=typeof alarm&&(undoable&&ST.undos.push({type:"A",path:action.path.slice(),data:alarm}),$node.treenode("cancel_alarm"),$node.treenode("set_modified",action.time)),follow.call($node)},ST.action_R=function(action,undoable,follow){var $node=ST.get_node(action.path),key=action.path[action.path.length-1],$container=$node.closest("ul");ST.demap($node),$node.detach().data("key",action.data).find(".key").first().text(action.data);var inserted=!1;$container.children(".treenode").each(function(){return ST.compare($(this).data("key"),action.data)>0?($node.insertBefore($(this)),inserted=!0,!1):void 0}),inserted||$container.append($node),$node.find(".treenode").each(function(){$(this).treenode("get_path")});var p=$node.treenode("get_path");$node.scroll_into_view(),$node.treenode("set_modified",action.time),undoable&&ST.undos.push({type:"R",path:p,data:key}),follow.call($node)},ST.action=function(action,chain,undoable){ST["action_"+action.type](action,undoable,function(){var $node=this;Utils.sometime("update_save"),"undefined"!=typeof chain&&Utils.soon(function(){chain($node)})})},ST.demap=function($node){$node.hasClass("treenode")||($node=$node.closest(".treenode")),delete ST.cache[$node.data("path")],$node.data("path",null).find(".treenode").each(function(){var $s=$(this);delete ST.cache[$s.data("path")],$s.data("path",null)})},ST.can_undo=function(){return 0!==ST.undos.length},ST.undo=function(){var a=ST.undos.pop();a.time=Date.now();var res=S.client.hoard.record_action(a,function(e){ST.action(e,function(){0===ST.length&&$(".modified").removeClass("modified"),Utils.sometime("update_save")})});null!==res&&SD.squeak({title:TX.error(),severity:"error",message:res.message})}}(jQuery,Squirrel);
//# sourceMappingURL=Tree.map