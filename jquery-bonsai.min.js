(function(a){a.fn.bonsai=function(d){var c=arguments;return this.each(function(){var e=a(this).data("bonsai");if(!e){e=new b(this,d);a(this).data("bonsai",e)}if(typeof d=="string"){var f=d;return e[f].apply(e,[].slice.call(c,1))}})};a.bonsai={};a.bonsai.defaults={expandAll:false,expand:null,collapse:null,addExpandAll:false,addSelectAll:false,selectAllExclude:null,checkboxes:false,createCheckboxes:false,handleDuplicateCheckboxes:false};var b=function(e,d){var c=this;d=d||{};this.options=a.extend({},a.bonsai.defaults,d);this.el=a(e).addClass("bonsai").data("bonsai",this);this.guid=Math.round(Math.random()*100000000);this.generatedIdPrefix="bonsai-generated-"+this.guid+"-";this.specifiedIdPrefix="bonsai-specified-"+this.guid+"-";this.update();if(this.isRootNode()){if(this.options.handleDuplicateCheckboxes){this.handleDuplicates()}if(this.options.checkboxes){this.el.qubit(this.options)}if(this.options.addExpandAll){this.addExpandAllLink()}if(this.options.addSelectAll){this.addSelectAllLink()}this.el.on("click",".thumb",function(f){c.toggle(a(f.currentTarget).closest("li"))})}if(this.options.expandAll){this.expandAll()}};b.prototype={isRootNode:function(){return this.options.scope==this.el},toggle:function(c){if(!a(c).hasClass("expanded")){this.expand(c)}else{this.collapse(c)}},expand:function(c){this.setExpanded(c,true)},collapse:function(c){this.setExpanded(c,false)},setExpanded:function(e,d){e=a(e);if(e.length>1){var c=this;e.each(function(){c.setExpanded(this,d)});return}if(d){if(!e.data("subList")){return}e=a(e).addClass("expanded").removeClass("collapsed");a(e.data("subList")).css("height","auto")}else{e=a(e).addClass("collapsed").removeClass("expanded");a(e.data("subList")).height(0)}},expandAll:function(){this.expand(this.el.find("li"))},collapseAll:function(){this.collapse(this.el.find("li"))},update:function(){var c=this;if(!this.options.scope){this.options.scope=this.el}this.el.children().each(function(){var f=a(this);if(c.options.createCheckboxes){c.insertCheckbox(f)}if(f.children().filter(".thumb").length==0){var e=a('<div class="thumb"></div>');f.prepend(e)}var d=f.children().filter("ol, ul");f.toggleClass("has-children",d.find("li").length>0);d.each(function(){if(a("li",this).length==0){return}f.data("subList",this);if(f.hasClass("expanded")){c.expand(f)}else{c.collapse(f)}var g=!!a(this).data("bonsai");a(this).bonsai(g?"update":c.options)})});this.expand=this.options.expand||this.expand;this.collapse=this.options.collapse||this.collapse;this.el.find("li").toArray().forEach(function(d){c.liId(a(d))})},serialize:function(){var c=this;return this.el.find("li").toArray().reduce(function(f,d){var g=a(d);var e=g.hasClass("expanded")?"expanded":g.hasClass("collapsed")?"collapsed":null;f[c.liId(g)]=e;return f},{})},restore:function(d){var c=this;Object.keys(d).forEach(function(e){var f=c.el.find("#"+e);if(d[e]==="expanded"){c.expand(f)}else{if(d[e]==="collapsed"){c.collapse(f)}}})},insertCheckbox:function(d){if(d.find("> input[type=checkbox]").length){return}var g=this.checkboxId(d),e=a('<input type="checkbox" name="'+this.getCheckboxName(d)+'" id="'+g+'" /> '),c=d.children(),f=d.contents().filter(function(){return this.nodeType==3}).first();e.val(d.data("value"));e.prop("checked",d.data("checked"));c.remove();d.append(e).append(a('<label for="'+g+'">').append(f?f:c.first())).append(f?c:c.slice(1))},handleDuplicates:function(){var c=this;c.el.on("change","input[type=checkbox]",function(e){var f=a(e.target);if(!f.val()){return}var d='input[type=checkbox][value="'+f.val()+'"][name="'+f.attr("name")+'"]'+(f.prop("checked")?":not(:checked)":":checked");c.el.find(d).prop({checked:f.prop("checked"),indeterminate:f.prop("indeterminate")}).trigger("change")})},checkboxPrefix:"checkbox-",liId:function(d){var e=d.attr("id");var c=d.attr("data-bonsai-id");if(e){}else{if(c){e=this.specifiedIdPrefix+c}else{do{e=this.generatedIdPrefix+b.uniqueId++}while(a("#"+e).length>0)}}d.attr("id",e);return e},checkboxId:function(c){return this.checkboxPrefix+this.liId(c)},getCheckboxName:function(c){return c.data("name")||c.parents().filter("[data-name]").data("name")},addExpandAllLink:function(){var c=this;a('<div class="expand-all">').append(a('<a class="all">Expand all</a>').on("click",function(){c.expandAll()})).append('<i class="separator"></i>').append(a('<a class="none">Collapse all</a>').on("click",function(){c.collapseAll()})).insertBefore(this.el)},addSelectAllLink:function(){var e=this.options.scope,d=this;function c(){return e.find("li").filter(d.options.selectAllExclude||function(){return a(this).css("display")!="none"}).find("> input[type=checkbox]")}a('<div class="check-all">').append(a('<a class="all">Select all</a>').css("cursor","pointer").on("click",function(){c().prop({checked:true,indeterminate:false})})).append('<i class="separator"></i>').append(a('<a class="none">Select none</a>').css("cursor","pointer").on("click",function(){c().prop({checked:false,indeterminate:false})})).insertAfter(this.el)},setCheckedValues:function(c){var d=this.options.scope.find("input[type=checkbox]");a.each(c,function(e,f){d.filter('[value="'+f+'"]').prop("checked",true).trigger("change")})}};a.extend(b,{uniqueId:0})}(jQuery));