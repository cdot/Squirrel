var Squirrel={PATHSEP:String.fromCharCode(1)};Squirrel.update_tree=function(){"use strict";$("#bonsai-root").bonsai("update"),$("#bonsai-root").bonsai("expand",$("#sites-node"))},Squirrel.close_menus=function(){"use strict";$("#bonsai-root").contextmenu("close"),$("#extras_menu").hide()},Squirrel.check_alarms=function(){"use strict";Squirrel.client.hoard.check_alarms(function(path,expired,next){var $node=Squirrel.Tree.node(path);$node.find(".alarm").addClass("expired").find(".squirrel-icon-alarm").removeClass("squirrel-icon-alarm").addClass("squirrel-icon-rung"),Squirrel.Dialog.squeak($("<p></p>").append($("<span></span>").addClass("ui-icon squirrel-icon-rung")).append(TX.tx("Reminder on '$1' was due on $2",path.join("/"),expired.toLocaleDateString())),function(){next()})})},Squirrel.edit_node=function($node,what){"use strict";var $span=$node.children(".node_div").children("."+what),w=$("#bonsai-root").width();$span.parents().each(function(){w-=$(this).position().left}),$span.edit_in_place({width:w,changed:function(s){var e=Squirrel.client.hoard.record_action({type:"key"===what?"R":"E",path:Squirrel.Tree.path($node),data:s},function(ea){Squirrel.Tree.action(ea,function(){Utils.sometime("update_save"),Utils.sometime("update_tree")},!0)});null!==e&&Squirrel.Dialog.squeak(e.message)}})},Squirrel.attach_alarm_handlers=function($node){"use strict";$node.children(".alarm").on("click",function(){Squirrel.close_menus(),Squirrel.Dialog.alarm($node)})},Squirrel.attach_node_handlers=function($node){"use strict";var $div=$node.children(".node_div");$div.linger(),$div.hover(function(){Squirrel.close_menus(),$(this).addClass("hover"),$("<div class='lastmod'></div>").text($node.data("last-mod")).appendTo($(this))},function(){$(this).removeClass("hover").find(".lastmod").remove()}),$div.children(".key,.value").on("click",function(){var $span=$(this);return Squirrel.close_menus(),$span.data("click_timer",window.setTimeout(function(){null!==$span.data("click_timer")&&($span.data("click_timer",null),Squirrel.close_menus(),$("#bonsai-root").bonsai($node.hasClass("expanded")?"collapse":"expand",$node))},250)),!1}),$div.children(".key").on("dblclick",function(){$(this).data("click_timer",null),Squirrel.edit_node($node,"key")}),$div.children(".value").on("dblclick",function(){$(this).data("click_timer",null),Squirrel.edit_node($node,"value")}),$div.filter(".treecollection").on("click",function(){return Squirrel.close_menus(),$("#bonsai-root").bonsai($node.hasClass("expanded")?"collapse":"expand",$node),!1})},Squirrel.add_child_node=function($node,title,value){"use strict";var sval,p=Squirrel.Tree.path($node);"string"==typeof value&&(sval=value),p.push(title);var res=Squirrel.client.hoard.record_action({type:"N",path:p,data:sval},function(e){Squirrel.Tree.action(e,function($newnode){$newnode.addClass("expanded").scroll_into_view().parents("ul").bonsai("expand",$node),"string"!=typeof value&&"undefined"!=typeof value&&Squirrel.insert_data(p,value),Squirrel.edit_node($newnode,"key")},!0)});null!==res&&Squirrel.Dialog.squeak(res.message)},Squirrel.insert_data=function(path,data){"use strict";var load_log=[];$("#dlg_loading").dialog({modal:!0}),Squirrel.client.hoard.actions_from_hierarchy({data:data},function(act,next){act.path=path.slice().concat(act.path);var res=Squirrel.client.hoard.record_action(act,function(sact){Squirrel.Tree.action(sact,next)});null!==res&&load_log.push(res.message),next&&next()},function(){Utils.sometime("update_save"),Utils.sometime("update_tree"),$("#dlg_loading").dialog("close"),Squirrel.Dialog.squeak(TX.tx("JSON has been loaded")+"<br />"+load_log.join("<br />"))})},Squirrel.search=function(s){"use strict";$(".node .expanded").each(function(){$("#bonsai-root").bonsai("collapse",$(this))});var re=new RegExp(s,"i"),hits=0;$(".key,.value").each(function(){$(this).text().match(re)&&(hits++,$(this).parents(".node").each(function(){$("#bonsai-root").bonsai("expand",$(this))}))}),$("#search_hits").text(TX.tx("$1 found",hits))},Squirrel.update_save=function(){"use strict";$("#undo_button").toggle(Squirrel.Tree.can_undo()),$("#menu_disas").toggle(Squirrel.client.hoard.options.autosave),$("#menu_enass").toggle(!Squirrel.client.hoard.options.autosave);var us=Squirrel.unsaved_changes(3);null!==us?Squirrel.client.hoard.options.autosave?Squirrel.save_hoards():($("#save_button").attr("title",TX.tx("Save is required because: ")+us),$("#save_button").show()):$("#save_button").hide()},Squirrel.get_updates_from_cloud=function(cloard,chain){"use strict";Squirrel.client.hoard.merge_from_cloud(cloard,Squirrel.Tree.action,function(conflicts){if(conflicts.length>0){var $dlg=$("#dlg_conflicts"),$msg=$("#dlg_conflicts_message");$msg.empty(),$.each(conflicts,function(i,c){var e=c.conflict;$("<div></div>").text(Hoard.stringify_action(e)+": "+c.message).appendTo($msg)}),$dlg.dialog({width:"auto"})}Squirrel.cloud.status="is loaded",chain()})},Squirrel.unsaved_changes=function(max_changes){"use strict";var message=[];if($(".node.modified").each(function(){message.push(TX.tx("$1 has changed",$(this).data("path").replace(Squirrel.PATHSEP,"/")))}),message.length>max_changes){var l=message.length;message=message.slice(0,max_changes),message.push(TX.tx("... and $1 more changes",l-5))}return"is loaded"!==Squirrel.cloud.status&&message.unshift(TX.tx("The $1 hoard $2",Squirrel.cloud.store?Squirrel.cloud.store.identifier():TX.tx("Cloud"),TX.tx(Squirrel.cloud.status))),"is loaded"!==Squirrel.client.status&&message.unshift(TX.tx("The $1 hoard $2",Squirrel.client.store.identifier(),TX.tx(Squirrel.client.status))),0===message.length?null:message.join("\n")},Squirrel.save_hoards=function(){"use strict";var $messy=$("#dlg_saving_message"),$dlg=$("#dlg_saving"),client_ok=!0,cloud_ok=!0;$messy.empty(),$dlg.dialog({modal:!0});var finished=function(){Utils.sometime("update_save"),$messy.append(TX.tx(client_ok&&cloud_ok?"Save complete":"Save encountered errors")),client_ok&&cloud_ok?Squirrel.client.hoard.options.autosave&&$dlg.dialog("close"):Squirrel.client.hoard.options.autosave=!1},save_client=function(){return"is loaded"===Squirrel.client.status&&0===$(".modified").length?void finished():void Squirrel.client.store.writes("Squirrel."+Squirrel.client.store.user(),JSON.stringify(Squirrel.client.hoard),function(){$(".modified").removeClass("modified"),Squirrel.client.status="is loaded",$messy.append("<div class='notice'>"+TX.tx("Saved in $1",this.identifier())+"</div>"),finished()},function(e){$messy.append("<div class='error'>"+TX.tx("Failed to save in $1: $2",this.identifier(),e)+"</div>"),client_ok=!1,finished()})},update_cloud_store=function(cloard){cloard.actions=cloard.actions.concat(Squirrel.client.hoard.actions),Squirrel.cloud.store?Squirrel.cloud.store.writes(Squirrel.client.hoard.options.store_path,JSON.stringify(cloard),function(){Squirrel.client.hoard.actions=[],Squirrel.client.hoard.last_sync=Date.now(),$messy.append("<div class='notice'>"+TX.tx("Saved in $1",this.identifier())+"</div>"),Squirrel.cloud.status="is loaded",Utils.soon(save_client)},function(e){$messy.append("<div class='error'>"+TX.tx("Failed to save in $1: $2",this.identifier(),e)+"</div>"),cloud_ok=!1,Utils.soon(save_client)}):save_client()},construct_new_cloud=function(){var cloard=new Hoard;Squirrel.client.hoard.reconstruct_actions(function(a,next){cloard.actions.push({type:a.type,time:a.time,data:a.data,path:a.path.slice()}),next&&next()},function(){update_cloud_store(cloard)})},cloud_store_read_ok=function(data){var cloard;try{cloard=new Hoard(JSON.parse(data)),Squirrel.cloud.status="is loaded"}catch(e){return $messy.append("<div class='error'>"+TX.tx("$1 hoard can't be read for update",this.identifier())+"</div>"),Squirrel.cloud.status="is corrupt",cloud_ok=!1,void construct_new_cloud()}"is loaded"===Squirrel.cloud.status&&Squirrel.client.hoard.merge_from_cloud(cloard,Squirrel.Tree.action),"is loaded"!==Squirrel.cloud.status||0!==Squirrel.client.hoard.actions.length?update_cloud_store(cloard):Utils.soon(save_client)},cloud_store_read_failed=function(e){e===AbstractStore.NODATA?(Squirrel.cloud.status="is empty",construct_new_cloud()):($messy.append("<div class='error'>"+"<br>"*TX.tx("Failed to refresh from $1",this.identifier())+e+"</div>"),cloud_ok=!1,Utils.soon(save_client))};"has new password"===Squirrel.cloud.status||"is empty"===Squirrel.cloud.status?construct_new_cloud():Squirrel.cloud.store.reads(Squirrel.client.hoard.options.store_path,cloud_store_read_ok,cloud_store_read_failed)},Squirrel.hoards_loaded=function(){"use strict";$(window).on("beforeunload",function(){var us=Squirrel.unsaved_changes(10);return null!==us?us=TX.tx("You have unsaved changes")+"\n"+us+"\n"+TX.tx("Are you really sure?"):void 0}),Utils.sometime("update_tree"),Utils.sometime("update_save"),Utils.sometime("check_alarms"),Utils.sometime_is_now(),$(".unauthenticated").hide(),$(".authenticated").show()},Squirrel.load_cloud_hoard=function(){"use strict";Squirrel.cloud.store?Squirrel.cloud.store.reads(Squirrel.client.hoard.options.store_path,function(data){var hoard;try{hoard=JSON.parse(data)}catch(e){return Squirrel.Dialog.squeak(TX.tx("$1 hoard exists, but can't be read.",this.identifier())+TX.tx("Check that you have the correct password.")),Squirrel.cloud.status="is corrupt",void Utils.soon(Squirrel.hoards_loaded)}Squirrel.get_updates_from_cloud(new Hoard(hoard),Squirrel.hoards_loaded)},function(e){e===AbstractStore.NODATA?Squirrel.cloud.status="is empty":Squirrel.Dialog.squeak(TX.tx("Could not load cloud hoard; do you have the correct password? Error was: $1 store error: $2",this.identifier(),e)),Utils.soon(Squirrel.hoards_loaded)}):Squirrel.hoards_loaded()},Squirrel.init_client_hoard=function(){"use strict";Squirrel.client.hoard=new Hoard,Squirrel.client.status="is empty",Squirrel.Dialog.store_settings(function(){Utils.soon(Squirrel.load_cloud_hoard)})},Squirrel.load_client_hoard=function(){"use strict";var rebuild_hoard=function(){Squirrel.client.hoard.reconstruct_actions(function(a,next){Squirrel.Tree.action(a),next&&next()},function(){$(".modified").removeClass("modified");var i,p,$node,as=Squirrel.client.hoard.actions;for(i=0;i<as.length;i++)for(p=as[i].path.slice();p.length>0;){if($node=Squirrel.Tree.node(p)){$node.addClass("modified");break}p.pop()}Utils.soon(Squirrel.load_cloud_hoard)})};$("#whoami").text(Squirrel.client.store.user()),Squirrel.client.store.reads("Squirrel."+Squirrel.client.store.user(),function(data){try{Squirrel.client.hoard=new Hoard(JSON.parse(data)),Squirrel.client.status="is loaded"}catch(e){return void Squirrel.Dialog.squeak(TX.tx("$1 hoard exists, but can't be read. Check that you have the correct password.",this.identifier()),Squirrel.init_application)}Squirrel.client.hoard.options.store_path?rebuild_hoard():Squirrel.Dialog.store_settings(function(){rebuild_hoard()})},function(e){e===AbstractStore.NODATA?Squirrel.init_client_hoard():Squirrel.Dialog.squeak(TX.tx("$1 store error: $2",this.identifier(),e),Squirrel.init_application)})},Squirrel.identify_user=function(){"use strict";var uReq=!0,pReq=!0;Squirrel.cloud.store&&"undefined"!=typeof Squirrel.cloud.store.user()?(Squirrel.client.store.user(Squirrel.cloud.store.user()),uReq=!1):Squirrel.client.store&&"undefined"!=typeof Squirrel.cloud.store.user()&&(Squirrel.cloud.store&&Squirrel.cloud.store.user(Squirrel.client.store.user()),uReq=!1),Squirrel.cloud.store&&"undefined"!=typeof Squirrel.cloud.store.pass()?(Squirrel.client.store.pass(Squirrel.cloud.store.pass()),pReq=!1):Squirrel.client.store&&"undefined"!=typeof Squirrel.cloud.store.pass()&&(Squirrel.cloud.store&&Squirrel.cloud.store.pass(Squirrel.client.store.pass()),pReq=!1),uReq||pReq?Squirrel.Dialog.login(Squirrel.client.store,function(user,pass){Squirrel.client.store.user(user),Squirrel.client.store.pass(pass),Squirrel.cloud.store&&(Squirrel.cloud.store.user(user),Squirrel.cloud.store.pass(pass)),Utils.soon(Squirrel.load_client_hoard)},function(e){Squirrel.Dialog.squeak(e)},uReq,pReq):Utils.soon(Squirrel.load_client_hoard)},Squirrel.init_client_store=function(){"use strict";new EncryptedStore({understore:function(params){return new LocalStorageStore(params)},ok:function(){Squirrel.client.store=this,$(".unauthenticated").text(TX.tx("Loading...")),Utils.soon(Squirrel.identify_user)},fail:function(e){Squirrel.Dialog.squeak(TX.tx("Failed ")+e)}})},Squirrel.init_cloud_store=function(){"use strict";var p={ok:function(){Squirrel.cloud.store=this,Utils.soon(Squirrel.init_client_store)},fail:function(e){Squirrel.Dialog.squeak(TX.tx("Could not open cloud store: $1",e)+"<p>"+TX.tx("Do you want to continue (only the client store will be available)?"),Squirrel.init_client_store,function(){$(".unauthenticated").hide(),$(".authfailed").show()})}};return p.understore=function(pp){return pp.understore=function(ppp){return new SQUIRREL_STORE(ppp)},new StegaStore(pp)},new EncryptedStore(p)},Squirrel.init_ui=function(){"use strict";$(".help").each(function(){var $this=$(this);$this.hide();var $help=$("<button></button>"),$close=$("<button></button>");$help.addClass("info-button").button({icons:{primary:"ui-icon-info"},text:!1}).on("click",function(){$this.show(),$help.hide()}).insertBefore(this),$close.addClass("help-close").button({icons:{primary:"ui-icon-circle-close"},text:!1}).on("click",function(){$this.hide(),$help.show()}).prependTo($this)}),Squirrel.Tree.set_root($("#sites-node")),$("#save_button").button({icons:{primary:"squirrel-icon-save"},text:!1}).hide().on("click",function(){return Squirrel.close_menus(),Squirrel.save_hoards(),!1}),$("#undo_button").button({icons:{primary:"squirrel-icon-undo"},text:!1}).hide().on("click",function(){return Squirrel.close_menus(),Squirrel.Tree.undo(Squirrel.squeak),!1});var zc=new ZeroClipboard($("#extras_menu > li[data-command='copydb']")).on("copy",function(event){event.clipboardData.setData("text/plain",JSON.stringify(Squirrel.client.hoard))});$("#extras_menu").menu({focus:function(){Squirrel.close_menus(),$(this).show()},select:function(evt,ui){switch($(this).hide(),ui.item.data("command")){case"enass":Squirrel.client.hoard.options.autosave=!0,Utils.sometime("update_save");break;case"disas":Squirrel.client.hoard.options.autosave=!1,Utils.sometime("update_save");break;case"chpw":Squirrel.Dialog.change_password();break;case"chss":Squirrel.Dialog.store_settings();break;case"copydb":break;case"readfile":$("#dlg_load_file").trigger("click");break;case"about":$("#dlg_about").dialog({modal:!0})}},blur:function(){$(this).hide()}}).data("ZC",zc),$("#dlg_load_file").change(function(evt){var file=evt.target.files[0];file&&Utils.read_file(file,function(str){var data;try{data=JSON.parse(str)}catch(e){return void Squirrel.Dialog.squeak(TX.tx("JSON could not be parsed")+": "+e)}"object"==typeof data.cache&&void 0!==typeof data.actions&&"object"==typeof data.cache.data?Squirrel.insert_data([],data.cache.data):Squirrel.insert_data([],data)},Squirrel.Dialog.squeak)}),$("#extras_button").button({icons:{primary:"squirrel-icon-gear"},text:!1}).on("click",function(){return $("#bonsai-root").contextmenu("close"),$("#extras_menu").show().position({my:"left top",at:"left bottom",of:this}),!1}),$("#bonsai-root").bonsai(),$("#search").on("click",Squirrel.close_menus).on("change",function(){Squirrel.close_menus(),$("#search_hits").text(TX.tx("Searching...")),Squirrel.search($(this).val())}),Squirrel.ContextMenu.init($("#bonsai-root")),$(document).on("check_alarms",Squirrel.check_alarms).on("update_save",Squirrel.update_save).on("update_tree",Squirrel.update_tree)},Squirrel.init_application=function(){"use strict";Squirrel.init_ui(),Squirrel.client={store:null,hoard:null,status:"is empty"},Squirrel.cloud={store:null,status:"is empty"},Squirrel.clipboard=null,Squirrel.init_cloud_store()},function($){"use strict";$(document).ready(function(){$.ajaxSetup({cache:!0}),TX.init(Squirrel.init_application)})}(jQuery);