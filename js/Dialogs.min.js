/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
!function($,S){"use strict";function validate_unique($node,$input){var $ul=$node.find("ul:first"),enabled=!0,val=$input.val();/\S/.test(val)?$ul.children(".tree-node").each(function(){if(0==ST.compare($(this).data("key"),val))return enabled=!1,!1}):enabled=!1,enabled?($(id+"_ok").button("enable"),$(id+"_key").removeClass("dlg-disabled").attr("title",TX.tx("Enter new name"))):($(id+"_ok").button("disable"),$(id+"_key").addClass("dlg-disabled").attr("title",TX.tx("Name is already in use")))}var SD=S.Dialog,ST=S.Tree;SD.squeak_more=function(p){$(".dlg-while").remove(),"string"==typeof p&&(p={message:p,severity:"notice"}),p.severity||(p.severity="notice"),$("#squeak_message").append($("<div class='dlg-"+p.severity+"'></div>").append(p.message))},SD.play_action=function(action,more){var res=S.client.hoard.record_action(action,function(e){ST.action(e,!0,function($node){more&&more($node),Utils.sometime("update_save")})});null!==res&&SD.squeak({title:TX.error(),severity:"error",message:res.message})},SD.login=function(options){var $dlg=$("#login");$("#login_uReq").toggle(options.user_required),$("#login_pReq").toggle(options.pass_required);var $user=$("#login_user"),$pass=$("#login_pass"),$signin=$("#login_signin"),sign_in=function(){return SD.close_dialog($dlg),$signin.off($.getTapEvent()),$user.off("change"),$pass.off("change"),options.on_signin.call(options.store,$user.val(),$pass.val()),!0};$signin.off($.getTapEvent()).on($.getTapEvent(),"p",sign_in),$user.off("change").val(options.store.user()),$pass.off("change").val(options.store.pass()),options.user_required&&($user.attr("autofocus","autofocus"),options.pass_required?$user.off("change").on("change",function(){$pass.focus()}):$user.off("change").on("change",sign_in)),options.pass_required&&($("#login_foruser").toggle(null!==options.store.user()).text(options.store.user()||""),$pass.attr("autofocus","autofocus"),options.user_required?$pass.on("change",function(){$signin.focus()}):$pass.on("change",sign_in)),SD.init_dialog($dlg),SD.open_dialog($dlg)},SD.delete_node=function($node){var $dlg=$("#delete_node");$dlg.data("node",$node),SD.init_dialog($dlg,function($dlg,id){$(id+"ok").on($.getTapEvent(),function(){SD.close_dialog($dlg);var res=S.client.hoard.record_action({type:"D",path:ST.get_path($dlg.data("node"))},function(e){ST.action(e,!0,function(){Utils.sometime("update_save")})});return null===res||(SD.squeak({title:TX.error(),severity:"error",message:res.message}),!1)}),$("#delete_node_cancel").on($.getTapEvent(),function(){return SD.close_dialog($dlg),!1})}),$("#delete_node_path").text(ST.get_path($node).join("/")),$("#delete_node_coll").toggle(!$node.hasClass("tree-leaf")),SD.open_dialog($dlg)},SD.about=function(){var $dlg=$("#about");SD.init_dialog($dlg),SD.open_dialog($dlg)},SD.pick=function($node){var $dlg=$("#pick");SD.init_dialog($dlg,function($dlg,id){$(id+"clear").on($.getTapEvent(),function(){$dlg.find(".dlg-picked").removeClass("dlg-picked")})});var i,$f,val=$node.find(".tree-value:first").text(),$which=$("#pick_which"),$from=$("#pick_from");$("#pick").find(".dlg-pick-cell").remove();var item_clicked=function(){var ii=$(this).data("i");$dlg.find("td.i"+ii).addClass("dlg-picked")};for(i=0;i<val.length;i++)$f=$from.children("td.i"+i),0===$f.length&&($("<td></td>").data("i",i).addClass("dlg-pick-cell i"+i).text(i+1).on($.getTapEvent(),item_clicked).appendTo($which),$f=$("<td></td>").data("i",i).addClass("dlg-pick-cell i"+i).on($.getTapEvent(),item_clicked).appendTo($from)),$f.text(val.charAt(i));for(;i<$from.children("td").length;)$from.children("td").last().remove(),i++;$dlg.find(".dlg-picked").removeClass("dlg-picked"),SD.open_dialog($dlg)},SD.randomise=function($node){var id="#randomise",$dlg=$(id);SD.init_dialog($dlg,function($dlg,id){$(id+"_again").on($.getTapEvent(),function(){return $(id+"_idea").text(Utils.generate_password({length:$(id+"_len").val(),charset:$(id+"_chs").val()})),!1}),$(id+"_use").on($.getTapEvent(),function(){return SD.close_dialog($dlg),SD.play_action({type:"E",path:ST.get_path($dlg.data("node")),data:$(id+"_idea").text()}),!0}),$(id+"_remember").on($.getTapEvent(),function(){var constraints=$(id+"_len").val()+TX.tx(" characters from ")+"["+$(id+"_chs").val()+"]",$ibling=$dlg.data("constraints");if($ibling)constraints!=$ibling.data("value")&&SD.play_action({type:"E",path:ST.get_path($ibling),data:constraints},function(){$ibling.data("value",constraints)});else{var $node=$dlg.data("node"),p=ST.get_path($node).slice(),k=TX.tx("$1 constraints",p.pop());p.push(k),SD.play_action({type:"N",path:p,data:constraints},function($new){$dlg.data("constraints",$new)})}})});var my_key=$node.data("key");$dlg.data("node",$node);var constraints_key=TX.tx("$1 constraints",$node.data("key")),vre=new RegExp("(\\d+)"+TX.tx(" characters from ").replace(/[-\/\\^$*+?.()|\[\]\{\}]/g,"\\$&")+"\\[(.*)\\]");$dlg.removeData("constraints"),$node.parent().children(".tree-leaf").each(function(){var $ibling=$(this);if($ibling.data("key")==constraints_key){var v=$ibling.data("value"),m=vre.exec(v);m&&($dlg.data("constraints",$ibling),$(id+"_len").val(m[1]),$(id+"_chs").val(m[2]))}});var path=ST.get_path($node);$(id+"_path").text(path.join("/")),$(id+"_key").text(my_key),$(id+"_again").trigger("click"),SD.open_dialog($dlg)},SD.search=function(){var $dlg=$("#search");SD.init_dialog($dlg,function($dlg,id){$(id+"_ok").on($.getTapEvent(),function(){SD.close_dialog($dlg),S.search($("#search_string").val())}),$(id+"_string").on("change",function(){$("#search_ok").trigger($.getTapEvent())})}),SD.open_dialog($dlg)},SD.alarm=function($node){var $dlg=$("#alarm");SD.init_dialog($dlg,function($dlg,id){$dlg.data("update_next",function(){var numb=$(id+"_number").val();numb*=Utils.TIMEUNITS[$(id+"_units").val()].days;var last_time=$dlg.data("node").data("last-time"),alarmd=new Date(last_time+numb*Utils.MSPERDAY);$("#alarm_when").text(alarmd.toLocaleDateString()),$(id+"_next").text(Utils.deltaTimeString(alarmd))}),$(id+"_units").on("change",function(){$dlg.data("update_next").call()}),$(id+"_number").on("change",function(){$dlg.data("update_next").call()}),$(id+"_set").on($.getTapEvent(),function(){SD.close_dialog($dlg);var numb=$(id+"_number").val()*Utils.TIMEUNITS[$(id+"_units").val()].days;return SD.play_action({type:"A",path:ST.get_path($dlg.data("node")),data:numb}),!1}),$(id+"_clear").on($.getTapEvent(),function(){return SD.play_action({type:"C",path:ST.get_path($dlg.data("node"))}),SD.close_dialog($dlg),!1})}),$("#alarm_path").text(ST.get_path($node).join("/")),$dlg.data("node",$node),$dlg.data("update_next").call(),SD.open_dialog($dlg)},SD.ss_change_image=function(){var fail=function(e){$("#store_settings_message").text(TX.tx("Cannot use this image because of this error: $1",e))},file=$(this)[0].files[0];Utils.read_file(file,function(data){(data="data:"+file.type+";base64,"+Utils.ArrayBufferToBase64(data))!==$("#stegamage").attr("src",data)&&$("#stegamage").attr("src",data).off("load").on("load",function(){$(this).off("load");var steg=new Steganographer(this);try{steg.inject("tada")}catch(e){return DEBUG&&console.debug("Caught "+e),void fail(e)}$("#store_settings #ok").attr("disabled",!1);var h=this.naturalHeight,w=this.naturalWidth;this.height=100,$("#store_settings_message").html("<br>"+w+" x "+h),S.client.status===S.IS_LOADED&&(S.client.status=S.NEW_SETTINGS),S.cloud.status===S.IS_LOADED&&(S.cloud.status=S.NEW_SETTINGS),Utils.sometime("update_save")})},fail,"arraybuffer")},SD.store_settings=function(chain){var $dlg=$("#store_settings");SD.init_dialog($dlg,function($dlg,id){$(id+"_file").hide().on($.getTapEvent(),function(){SD.ss_change_image()}),$(id+"_image").on($.getTapEvent(),function(e){$("#store_settings_file").trigger("change",e)}),$(id+"_storepath").on("keyup",function(){return""===$("#store_settings_storepath").val()?($("#store_settings_message").text(TX.tx("Store path may not be empty")),!1):(S.client.hoard.options.store_path!==$("#store_settings_storepath").val()&&(S.client.hoard.options.store_path=$("#store_settings_storepath").val(),S.client.status===S.IS_LOADED&&(S.client.status=S.NEW_SETTINGS),Utils.sometime("update_save")),!0)}),$(id+"_ok").on($.getTapEvent(),function(){if(""===$("#store_settings_storepath").val())return $("#store_settings_message").text(TX.tx("Store path may not be empty")),!1;SD.close_dialog($dlg);var cb=$dlg.data("callback");"function"==typeof cb&&cb()})}),$("#store_settings_message").empty(),$dlg.data("callback",chain),$("#store_settings_storepath").val(S.client.hoard.options.store_path),SD.open_dialog($dlg)},SD.chpw=function(){var $dlg=$("#chpw");SD.init_dialog($dlg,function($dlg,id){$(id+"_show").on("change",function(){$("#chpw_show").prop("checked")?($("#chpw_pass").attr("type","text"),$("#chpw_conf").attr("type","text")):($("#chpw_pass").attr("type","password"),$("#chpw_conf").attr("type","password"))}),$dlg.data("validate",function(){var p=$("#chpw_pass").val(),c=$("#chpw_conf").val();return $("#chpw_nomatch").toggle(p!==c),p===c}),$(id+"_conf").on("change",function(){$dlg.data("validate").call()}),$(id+"_set").on($.getTapEvent(),function(){if(!$dlg.data("validate").call())return!1;SD.close_dialog($dlg);var p=$("#chpw_pass").val();return S.client.store.pass(p),S.client.status=S.NEW_SETTINGS,S.cloud.store.pass(p),S.cloud.status=S.NEW_SETTINGS,Utils.sometime("update_save"),!0})}),$dlg.data("validate").call(),SD.open_dialog($dlg)},SD.json=function(){var $dlg=$("#json");SD.init_dialog($dlg,function($dlg,id){$(id+"_text").on("input",function(){$("#json_ok").prop("disabled",!1)}),$(id+"_ok").on($.getTapEvent(),function(){SD.close_dialog($dlg);var datum;try{datum=JSON.parse($("#json_text").val())}catch(e){return SD.squeak({title:TX.tx("JSON could not be parsed"),severity:"error",message:e}),!1}return $("#json_ok").prop("disabled",!0),DEBUG&&console.debug("Importing..."),S.insert_data([],datum),!0})});var data=S.client.hoard.JSON();$("#json_text").text(data).select(),$("#json_ok").prop("disabled",!0),SD.open_dialog($dlg)},SD.theme=function(){var $dlg=$("#theme");SD.init_dialog($dlg,function($dlg,id){$(id+"_select").on("change",function(){var theme=$(this).val();$("link").filter(function(){return this.href&&this.href.indexOf("/themes/")>0}).each(function(){this.href=this.href.replace(/\/themes\/[^\/]+/,"/themes/"+theme),$(this).replaceWith($(this)),Utils.sometime("reset_styling")})})}),SD.open_dialog($dlg)},SD.extras=function(){var $dlg=$("#extras");SD.init_dialog($dlg,function($dlg,id){$(id+"_autosave").on("change",function(){S.client.hoard.options.autosave="on"===$("#extras_autosave").val(),Utils.sometime("update_save")}),$(id+"_chpw").on($.getTapEvent(),function(){SD.close_dialog($dlg),SD.chpw()}),$(id+"_chss").on($.getTapEvent(),function(){SD.close_dialog($dlg),SD.store_settings()}),$(id+"_theme").on($.getTapEvent(),function(){SD.close_dialog($dlg),SD.theme()}),$(id+"_json").on($.getTapEvent(),function(){SD.close_dialog($dlg),SD.json()}),$(id+"_about").on($.getTapEvent(),function(){SD.close_dialog($dlg),SD.about()})}),S.USE_STEGANOGRAPHY||S.cloud.store&&S.cloud.store.options().needs_path||$("#extras_chss").hide(),$("#extras_autosave").val(S.client.hoard.options.autosave?"on":"off"),SD.open_dialog($dlg)},SD.insert=function($parent,data){var id="#insert",$dlg=$(id);SD.init_dialog($dlg,function($dlg,id){$(id+"_key").on("input",function(){validate_unique($dlg.data("parent"),$(this))}),$(id+"_ok").button().on($.getTapEvent(),function(){$dlg.dialog("close"),S.add_child_node($dlg.data("parent"),$(id+"_key").val(),data.data)})}),DEBUG&&console.debug("Pasting"),$dlg.data("parent",$parent);var base=TX.tx("A copy"),name=new RegExp("^"+base+" ?(\\d*)$"),i=-1;$parent.find("ul:first").children(".tree-node").each(function(){var m=name.exec($(this).data("key"));m&&(i=Math.max(i,m[1]?parseInt(m[1]):0))}),$(id+"_key").val(base+(i>=0?" "+(i+1):"")),SD.open_dialog($dlg)},SD.add=function($parent,is_value){var id="#add",$dlg=$(id);$dlg.data("parent",$parent),$dlg.data("adding_value",is_value);$parent.find("ul:first");SD.init_dialog($dlg,function($dlg,id){$(id+"_key").on("input",function(){validate_unique($parent,$(this))}).autocomplete({source:[TX.tx("User"),TX.tx("Pass")]}),$(id+"_ok").button().on($.getTapEvent(),function(){$dlg.dialog("close");var $parent=$dlg.data("parent");return S.add_child_node($parent,$(id+"_key").val(),$dlg.data("adding_value")?$(id+"_value").val():void 0),!1})}),$(id+"_path").text(ST.get_path($parent).join(" > ")+" > "),is_value?($dlg.attr("title",TX.tx("Add value")),$(id+"_help").text(TX.tx("Enter the name and value for the new entry")),$(id+"_value_parts").show(),$(id+"_key").autocomplete("enable")):($dlg.attr("title",TX.tx("Add folder")),$(id+"_help").text(TX.tx("Enter the name for the new folder")),$(id+"_value_parts").hide(),$(id+"_key").autocomplete("disable")),validate_unique($parent,$(id+"_key")),SD.open_dialog($dlg)},SD.init_dialog=function($dlg,extra){if(!$dlg.hasClass("dlg-initialised")){$dlg.addClass("dlg-initialised");var id="#"+$dlg.attr("id");$(id+"_cancel").button().on($.getTapEvent(),function(){return $dlg.dialog("close"),!1}),extra&&extra($dlg,id)}},SD.open_dialog=function($dlg,opts){var options={modal:!0,width:"auto",closeOnEscape:!1};$.isTouchCapable()&&(options.position={my:"left top",at:"left top",of:$("body")}),opts&&$.extend(options,opts),$dlg.dialog(options)},SD.close_dialog=function($dlg){$dlg.dialog("close")},SD.squeak=function(p){var $dlg=$("#squeak");"string"==typeof p&&(p={message:p,severity:"notice"}),$dlg.data("after_close",p.after_close);SD.init_dialog($dlg,function($dlg,id){$(id+"_close").button().on($.getTapEvent(),function(){var ac=$dlg.data("after_close");return $dlg.removeData("after_close"),$dlg.dialog("close"),"function"==typeof ac&&ac(),!1})}),$("#squeak_message").empty(),SD.squeak_more(p);var options={close:function(){"function"==typeof p.after_close&&p.after_close()}};p.title&&(options.title=p.title),SD.open_dialog($dlg,options)}}(jQuery,Squirrel);
//# sourceMappingURL=Dialogs.map