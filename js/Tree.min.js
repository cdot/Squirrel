/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
!function($,S){"use strict";var ST=S.Tree,SD=S.Dialog;ST.cache={},ST.undos=[],$.widget("squirrel.tree",{_create:function(){ST.create($(this.element),this.options)}}),ST.create=function($node,options){var parent,$parent,is_leaf=!1,is_root=!options.path,key="";if(is_root||(parent=options.path,key=parent.pop(),$parent=ST.get_node(parent),$node.data("key",key)),$node.addClass("tree-node"),is_root)ST.cache[""]=$node,$node.addClass("tree-root"),$node.data("path","");else if(void 0!==options.value&&null!==options.value)$node.data("value",options.value).data("is_leaf",!0).addClass("tree-leaf"),is_leaf=!0;else{var $control=$("<button></button>").addClass("tree-open-close");$node.prepend($control).addClass("tree-open"),ST.icon_button($node,"create",$control,"folder-closed",function(){return ST.toggle($node),!1})}if(!is_root){var $info=$("<div></div>").addClass("tree-info noselect").appendTo($node);$("<span></span>").appendTo($info).addClass("tree-key").text(key).on($.isTouchCapable()?"doubletap":"dblclick",function(e){e.preventDefault(),ST.edit($node,".tree-key","R")}),is_leaf&&($("<span> : </span>").addClass("tree-separator").appendTo($info),$("<span></span>").appendTo($info).addClass("tree-value").text(options.value).on($.isTouchCapable()?"doubletap":"dblclick",function(e){e.preventDefault(),ST.edit($node,".tree-value","E")})),$info.hover(function(){if(0===$(this).find(".in_place_editor").length){var $status=$("<div></div>");$status.addClass("tree-lastmod"),$(this).addClass("tree-hover").append($status);var mod=new Date($node.data("last-time")).toLocaleString();return $status.append("<span>"+mod+" </span"),void 0!==$node.data("alarm")&&($status.append('<div class="inline-icon ui-icon-squirrel-alarm"></div>'),$status.append('<div class="tree-info">'+Utils.deltaTimeString(new Date($node.data("last-time")+$node.data("alarm")*Utils.MSPERDAY))+"</div>")),!1}},function(){$(this).removeClass("tree-hover").find(".tree-lastmod").remove()})}is_leaf||$node.addClass("tree-collection").append("<ul class='sortable tree-subnodes'></ul>"),ST.toggle($node),is_root||ST.makeDraggable($node),$parent&&ST.relocate($node,$parent),void 0!==options.time&&ST.set_modified($node,options.time),options.on_create&&options.on_create.call($node)},ST.icon_button=function($node,action,selector,icon,on_click){var $control="string"==typeof selector?$node.find(selector):selector;switch(action){case"create":var $button=$control.button({icons:{primary:"ui-icon-squirrel-"+icon},classes:{"ui-button-icon":"squirrel-icon"},text:!1});on_click&&$button.on($.getTapEvent(),on_click);break;case"change":$control.length>0&&$control.button("option","icons",{primary:"ui-icon-squirrel-"+icon});break;case"destroy":$control.remove()}return $node},ST.edit=function($node,selector,action){var $span="string"==typeof selector?$node.find(selector).first():selector,w=$("#sites-node").width();$span.parents().each(function(){w-=$(this).position().left}),$span.edit_in_place({width:w/2,changed:function(s){var e=S.client.hoard.record_action({type:action,path:ST.get_path($node),data:s},function(ea){ST.action(ea,!0,function(){Utils.sometime("update_save")})});null!==e&&S.Dialog.squeak(e.message)}})},ST.set_alarm=function($node,data){if(void 0===$node.data("alarm")){var $button=$("<button></button>").addClass("tree-alarm");$node.find(".tree-key").first().before($button),ST.icon_button($node,"create",$button,"alarm",function(){return SD.alarm($node),!1}),$node.parents(".tree-node").each(function($n){var c=$(this).data("alarm-count")||0;$(this).data("alarm-count",c+1),$(this).addClass("tree-has-alarms")})}$node.data("alarm",data)},ST.cancel_alarm=function($node){return $node.parents(".tree-node").each(function($n){var c=$(this).data("alarm-count")||0;c-=1,$(this).data("alarm-count",c),0===c&&$(this).removeClass("tree-has-alarms")}),ST.icon_button($node,"destroy",".tree-alarm:first"),$node.removeData("alarm")},ST.ring_alarm=function($node){$node.find(".tree-alarm").addClass("tree-expired").find(".ui-icon-squirrel-alarm").removeClass("ui-icon-squirrel-alarm").addClass("ui-icon-squirrel-rang")},ST.makeDraggable=function($node){function handleDrag(event,ui){var $within=$(".tree-collection").not(".ui-draggable-dragging").filter(function(){if($(this).is($node.parent().closest(".tree-node")))return!1;var box=$(this).offset();return!(event.pageX<box.left||event.pageY<box.top)&&!(event.pageX>box.left+$(this).outerWidth(!0)||event.pageY>box.top+$(this).outerHeight(!0))});$(".drop-target").removeClass("drop-target"),$within.length>0&&($within=$within.last(),$within.addClass("drop-target"),console.log("drop on "+$within.data("key")))}function handleStop(event,ui){var $target=$(".drop-target");$target.length,$target.each(function(){var $new_parent=$(this);$new_parent.removeClass("drop-target");var oldpath=ST.get_path($node),newpath=ST.get_path($new_parent),e=S.client.hoard.record_action({type:"M",path:oldpath,data:newpath},function(ea){ST.action(ea,!0,function(){Utils.sometime("update_save")})});null!==e&&S.Dialog.squeak(e.message)})}$node.draggable({axis:"y",containment:".tree-collection",cursor:"pointer",revert:!0,revertDuration:1,drag:handleDrag,stop:handleStop})},ST.get_node=function(path){var $node=ST.cache[path.join(S.PATHSEP)];return DEBUG&&$node&&$node.length,$node},ST.get_path=function($node){if($node.hasClass("tree-root"))return[];$node.hasClass("tree-node");var ps=$node.data("path");return ps||(ST.addToCaches($node),(ps=$node.data("path"))||(ps="")),ps.split(S.PATHSEP)},ST.sort_prio=[TX.tx("A new folder"),TX.tx("A new value"),TX.tx("User"),TX.tx("Pass")],ST.compare=function(a,b){if(a==b)return 0;for(var i=0;i<ST.sort_prio.length;i++){if(a==ST.sort_prio[i])return-1;if(b==ST.sort_prio[i])return 1}return a<b?-1:1},ST.relocate=function($node,$parent){ST.removeFromCaches($node),$node.detach();var key=$node.data("key"),inserted=!1,$ul=$parent.find("ul:first");$ul.children(".tree-node").each(function(){if(ST.compare($(this).data("key"),key)>0)return $node.insertBefore($(this)),inserted=!0,!1}),inserted||$ul.append($node)},ST.set_modified=function($node,time){new Date(time);return $node.addClass("tree-modified").data("last-time",time)},ST.open=function($node){return $node.hasClass("tree-open")?$node:(ST.icon_button($node,"change",".tree-open-close:first","folder-open"),$node.addClass("tree-open").children(".tree-subnodes").scroll_into_view().show())},ST.close=function($node){return $node.hasClass("tree-open")?(ST.icon_button($node,"change",".tree-open-close:first","folder-closed"),$node.removeClass("tree-open").children(".tree-subnodes").hide()):$node},ST.toggle=function($node){return $node.hasClass("tree-open")?ST.close($node):ST.open($node)},ST.action_N=function(action,undoable,follow){$("<li></li>").tree({path:action.path,value:action.data,time:action.time,on_create:function(){var path=ST.get_path(this);undoable&&ST.undos.push({type:"D",path:path}),follow.call(this)}})},ST.action_E=function(action,undoable,follow){var $node=ST.get_node(action.path);undoable&&ST.undos.push({type:"E",path:action.path.slice(),data:$node.find(".tree-value").first().text()}),$node.find(".tree-value").first().text(action.data),ST.set_modified($node,action.time),follow.call($node)},ST.action_D=function(action,undoable,follow){var $node=ST.get_node(action.path);ST.removeFromCaches($node),undoable&&ST.undos.push({type:"N",path:action.path.slice(),data:$node.find(".tree-value").first().text()});var $parent=$node.parent().closest(".tree-node");ST.set_modified($parent,action.time),$node.remove(),follow.call($node)},ST.action_A=function(action,undoable,follow){var $node=ST.get_node(action.path),alarm=$node.data("alarm");void 0!==alarm?alarm!==action.data&&(undoable&&ST.undos.push({type:"A",path:action.path.slice(),data:$node.data("alarm")}),ST.set_modified($node,action.time)):(ST.set_modified($node,action.time),undoable&&ST.undos.push({type:"C",path:action.path.slice()})),ST.set_alarm($node,action.data),follow.call($node)},ST.action_C=function(action,undoable,follow){var $node=ST.get_node(action.path),alarm=$node.data("alarm");void 0!==alarm&&(undoable&&ST.undos.push({type:"A",path:action.path.slice(),data:alarm}),ST.cancel_alarm($node),ST.set_modified($node,action.time)),follow.call($node)},ST.action_M=function(action,undoable,follow){var oldpath=action.path.slice(),newpath=action.data.slice(),$node=ST.get_node(oldpath),$new_parent=ST.get_node(newpath);ST.relocate($node,$new_parent);ST.get_path($node);$node.scroll_into_view(),ST.set_modified($node,action.time),newpath.push(oldpath.pop()),undoable&&ST.undos.push({type:"M",path:newpath,data:oldpath}),follow.call($node)},ST.action_R=function(action,undoable,follow){var $node=ST.get_node(action.path),key=action.path[action.path.length-1];$node.data("key",action.data).find(".tree-key").first().text(action.data),ST.relocate($node,$node.parent().closest(".tree-collection"));var p=ST.get_path($node);$node.scroll_into_view(),ST.set_modified($node,action.time),undoable&&ST.undos.push({type:"R",path:p,data:key}),follow.call($node)},ST.action=function(action,undoable,chain){ST["action_"+action.type](action,undoable,function(){var $node=this;Utils.sometime("update_save"),void 0!==chain&&Utils.soon(function(){chain($node)})})},ST.addToCaches=function($node,path){path||(path=ST.get_path($node.parent().closest(".tree-node"))),path.push($node.data("key"));var ps=path.join(S.PATHSEP);$node.data("path",ps),ST.cache[ps]=$node},ST.removeFromCaches=function($node){$node.hasClass("tree-node")||($node=$node.closest(".tree-node")),delete ST.cache[$node.data("path")],$node.removeData("path").find(".tree-node").each(function(){var $s=$(this);delete ST.cache[$s.data("path")],$s.data("path",null)})},ST.can_undo=function(){return 0!==ST.undos.length},ST.undo=function(){DEBUG&&ST.undos.length;var a=ST.undos.pop();a.time=Date.now(),DEBUG&&console.debug("Undo "+Hoard.stringify_action(a));var res=S.client.hoard.record_action(a,function(e){ST.action(e,!1,function(){0===ST.length&&$(".tree-modified").removeClass("tree-modified"),Utils.sometime("update_save")})});null!==res&&SD.squeak({title:TX.error(),severity:"error",message:res.message})}}(jQuery,Squirrel);
//# sourceMappingURL=Tree.map