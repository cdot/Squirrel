/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
function GoogleDriveStore(params){"use strict";if(gapi_is_loaded)DEBUG&&console.debug("gapi is already loaded"),this._init(params);else{var self=this;gapi_loader=function(){DEBUG&&console.debug("Loading GoogleDriveStore"),self._init(params)},$.getScript("https://apis.google.com/js/client.js?onload=gapi_on_load").fail(function(jqxhr,settings,exception){params.fail.call(self,TX.tx("Failed to load Google APIs: $1 $2",exception,jqxhr.status))})}}function gapi_on_load(){"use strict";DEBUG&&console.debug("gapi is loaded"),gapi_is_loaded=!0,gapi_loader&&gapi_loader()}var CLIENT_ID="985219699584-mt1do7j28ifm2vt821d498emarmdukbt.apps.googleusercontent.com",SCOPE="https://www.googleapis.com/auth/drive",gapi_is_loaded=!1,gapi_loader;GoogleDriveStore.prototype=Object.create(AbstractStore.prototype),SQUIRREL_STORE=GoogleDriveStore,GoogleDriveStore.prototype._analyse_error=function(r,context,fail){"use strict";var mess=context+TX.tx(" failed: ");401===r.status?mess+=TX.tx("Your access token has expired, or you are not logged in. Please refresh the page in order to save in Google Drive"):r.result?mess+=r.result.error.message:mess+=r.body,fail.call(this,mess)},GoogleDriveStore.prototype._init=function(params){"use strict";var self=this,tid=window.setTimeout(function(){window.clearTimeout(tid),params.fail.call(self,TX.tx("Timeout trying to authorise access to Google Drive. Are popups blocked in your browser?"))},2e4),handleClientLoad=function(){DEBUG&&console.debug("GoogleDriveStore: drive/v2 loaded"),gapi.client.drive.about.get("name").then(function(result){200===result.status?self.user(result.result.user.displayName):self._analyse_error(result,TX.tx("Google Drive load"),params.fail),AbstractStore.call(self,params)},function(r){self._analyse_error(r,TX.tx("Google Drive load"),params.fail)})},handleAuthResult=function(authResult){var message;window.clearTimeout(tid),authResult&&!authResult.fail?(DEBUG&&console.debug("GoogleDriveStore: auth OK"),gapi.client.load("drive","v2",handleClientLoad)):(message=null===authResult?TX.tx("Could not authorise access to Google Drive"):authResult.fail,params.fail.call(self,message))};DEBUG&&console.debug("GoogleDriveStore: authorising"),gapi.auth.authorize({client_id:CLIENT_ID,scope:SCOPE},handleAuthResult)};var BOUNDARY="-------314159265358979323846",DELIMITER="\r\n--"+BOUNDARY+"\r\n",RETIMILED="\r\n--"+BOUNDARY+"--";GoogleDriveStore.prototype._getfile=function(url,ok,fail){"use strict";var self=this,oauthToken=gapi.auth.getToken();DEBUG&&console.debug("GoogleDriveStore: GET "+url),$.ajax({url:url,method:"GET",dataType:"binary",responseType:"arraybuffer",beforeSend:function(jqXHR){jqXHR.setRequestHeader("Authorization","Bearer "+oauthToken.access_token)},success:function(data,textStatus,jqXHR){DEBUG&&console.debug("GoogleDriveStore: _getfile OK"),ok.call(self,data)},error:function(jqXHR,textStatus,errorThrown){var reason=textStatus+" "+errorThrown;DEBUG&&console.debug("_getfile failed",reason),fail.call(self,reason)}})},GoogleDriveStore.prototype._follow_path=function(parentid,path,ok,fail,create){"use strict";var self=this;if(0===path.length)return void ok.call(self,parentid);var p=path.slice(),pathel=p.shift(),create_folder=function(reason){var metadata={title:pathel,mimeType:"application/vnd.google-apps.folder"};"root"!==parentid&&(metadata.parents=[{id:parentid}]),DEBUG&&console.debug("Creating folder "+pathel+" under "+parentid),gapi.client.drive.files.insert(metadata).then(function(response){var id=response.result.id;self._follow_path(id,p,ok,fail,!0)},function(r){self._analyse_error(r,TX.tx("Create folder"),fail)})},query="title='"+pathel+"' and '"+parentid+"' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false";gapi.client.drive.files.list({q:query}).then(function(response){var items=response.result.items;if(items.length>0){var id=items[0].id;DEBUG&&console.debug("GoogleDriveStore: found "+query+" at "+id),self._follow_path(id,p,ok,fail,create)}else DEBUG&&console.debug("GoogleDriveStore: could not find "+query),create?create_folder():fail.call(self,AbstractStore.NODATA)},function(r){self._analyse_error(r,TX.tx("Follow path"),fail)})},GoogleDriveStore.prototype._putfile=function(parentid,name,data,ok,fail,id){"use strict";var self=this,url="/upload/drive/v2/files",method="POST",params={uploadType:"multipart",visibility:"PRIVATE"},metadata={title:name,mimeType:"application/octet-stream"};void 0!==parentid&&(metadata.parents=[{id:parentid}]),void 0!==id&&(url+="/"+id,method="PUT");var multipartRequestBody=DELIMITER+"Content-Type: application/json\r\n\r\n"+JSON.stringify(metadata)+DELIMITER+"Content-Type: application/octet-stream\r\nContent-Transfer-Encoding: base64\r\n\r\n"+Utils.ArrayBufferToBase64(data)+RETIMILED;gapi.client.request({path:url,method:method,params:params,headers:{"Content-Type":'multipart/related; boundary="'+BOUNDARY+'"'},body:multipartRequestBody}).then(function(response){ok.call(self,response.result)},function(r){self._analyse_error(r,TX.tx("Put"),fail)})},GoogleDriveStore.prototype.options=function(){"use strict";return $.extend(AbstractStore.prototype.options(),{needs_path:!0,identifier:"Google Drive"})},GoogleDriveStore.prototype.write=function(path,data,ok,fail){"use strict";var self=this,p=path.split("/"),name=p.pop(),create_file=function(parentid){var query="title='"+name+"' and '"+parentid+"' in parents and trashed=false";DEBUG&&console.debug("GoogleDriveStore: checking existance of "+name),gapi.client.drive.files.list({q:query}).then(function(response){var id,items=response.result.items;items.length>0?(id=items[0].id,DEBUG&&console.debug("GoogleDriveStore: updating "+name+" id "+id)):DEBUG&&console.debug("GoogleDriveStore: creating "+name+" in "+parentid),self._putfile(parentid,name,data,ok,fail,id)},function(r){self._analyse_error(r,TX.tx("Write"),fail)})};DEBUG&&console.debug("GoogleDriveStore: following "+path),this._follow_path("root",p,create_file,fail,!0)},GoogleDriveStore.prototype.read=function(path,ok,fail){"use strict";DEBUG&&console.debug("GoogleDriveStore: read "+path);var p=path.split("/"),name=p.pop(),self=this,get_file=function(parentid){var query="title='"+name+"' and '"+parentid+"' in parents and trashed=false";gapi.client.drive.files.list({q:query}).then(function(response){var items=response.result.items;if(items.length>0){var url=items[0].downloadUrl;DEBUG&&console.debug("GoogleDriveStore: download found "+name+" at "+url),self._getfile(url,ok,fail)}else DEBUG&&console.debug("GoogleDriveStore: could not find "+name),fail.call(self,AbstractStore.NODATA)},function(r){self._analyse_error(r,TX.tx("Read"),fail)})};this._follow_path("root",p,get_file,fail,!1)};
//# sourceMappingURL=GoogleDriveStore.map