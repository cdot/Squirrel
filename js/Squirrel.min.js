/*@preserve Copyright (C) 2015 Crawford Currie http://c-dot.co.uk license MIT*/
var Squirrel={PATHSEP:String.fromCharCode(1),NEW_SETTINGS:"has new settings",IS_LOADED:"is loaded",IS_PENDING_SAVE:"needs to be saved",IS_CORRUPT:"is corrupt",IS_EMPTY:"is empty",USE_STEGANOGRAPHY:!1,Dialog:{},Tree:{}};!function($,S){"use strict";var SD=S.Dialog,ST=S.Tree;$.isTouchCapable()&&window.addEventListener("load",function(){window.scrollTo(0,0)}),S.init_ui=function(){$("#authenticated_save").hide().on($.getTapEvent(),function(){return S.save_hoards(),!1}),$("#authenticated_undo").hide().on($.getTapEvent(),function(){return ST.undo(function(mess){SD.squeak({title:"Undo",message:mess})}),!1}),$("#authenticated_extras").on($.getTapEvent(),function(){SD.extras()}),$("#search").on("change",function(){$("#search_hits").text(TX.tx("Searching...")),S.search($(this).val())}),$("#search_button").on($.getTapEvent(),function(){$("#search_hits").text(TX.tx("Searching...")),S.search($("#search").val())}),$("#authenticated_search").on($.getTapEvent(),function(){SD.search()}),$(".help").each(function(){var $this=$(this);$this.hide();var $help=$("<button></button>"),$close=$("<button></button>");$help.addClass("info-button").button({icons:{primary:"ui-icon-info"},text:!1}).on($.getTapEvent(),function(){$this.show(),$help.hide()}).insertBefore(this),$close.addClass("help-close").button({icons:{primary:"ui-icon-circle-close"},text:!1}).on($.getTapEvent(),function(){$this.hide(),$help.show()}).prependTo($this)}),$("button").each(function(){var opts,$this=$(this);void 0!==$this.data("icon")&&(opts={icons:{primary:$this.data("icon")},classes:{"ui-button-icon":"squirrel-icon"},text:!1}),$this.button(opts)}),$("#sites-node").tree({is_root:!0}),init_menus(),S.clipboard=null,$(document).on("init_application",S.init_application).on("check_alarms",S.check_alarms).on("update_save",S.update_save).on("reset_styling",S.resetStyling),S.resetStyling(),Utils.sometime_is_now()},S.resetStyling=function(){var $body=$("body"),$el=$("<div></div>").addClass("ui-widget").addClass("ui-widget-content").addClass("dlg-hidden");$body.append($el);var bgcol=$el.css("background-color"),style="body {";for(var attr in{font:0,color:0,"background-color":0}){style+=attr+": "+$el.css(attr)+";"}style+="}",$el.remove();var want_bright=bgcol&&"transparent"!=bgcol&&new RGBA(bgcol).luma()<.65;if(S.bright&&!want_bright||!S.bright&&want_bright){for(var i=0;i<document.styleSheets.length;i++){var sheet=document.styleSheets[i];if(sheet){var rules=sheet.rules||sheet.cssRules;if(rules)for(var j=0;j<rules.length;j++){var rule=rules[j];if(/\.[-:a-z0-9]*$/i.test(rule.selectorText)){var s="";if(rule.style.color)try{var a=new RGBA(rule.style.color);s+="color: "+a.inverse().toString()+";"}catch(e){}if(rule.style.backgroundColor)try{var a=new RGBA(rule.style.backgroundColor);s+="background-color: "+a.inverse().toString()+";"}catch(e){}s.length>0&&(style+=rule.selectorText+"{"+s+"}")}}}}S.bright=want_bright}$("#computed-styles").remove(),style="<style id='computed-styles'>"+style+"</style>",$body.append(style)},S.init_application=function(){S.client={store:null,hoard:null,status:S.IS_EMPTY},S.cloud={store:null,status:S.IS_EMPTY},S.init_cloud_store()},S.check_alarms=function(){S.client.hoard.check_alarms(function(path,expired,next){var $node=ST.get_node(path);ST.ring_alarm($node),SD.squeak({severity:"warning",message:"<div class='ui-icon ui-icon-squirrel-rang'></div>"+TX.tx("Reminder on '$1' was due on $2",path.join("/"),expired.toLocaleDateString()),after_close:next})})},S.add_child_node=function($node,title,value){var sval,p=ST.get_path($node);"string"==typeof value&&(sval=value),p.push(title);var res=S.client.hoard.record_action({type:"N",path:p,data:sval},function(e){ST.action(e,!0,function($newnode){DEBUG,ST.open($newnode),"string"!=typeof value&&void 0!==value&&S.insert_data(p,value),Utils.sometime("update_save")})});null!==res&&SD.squeak(res.message)},S.get_updates_from_cloud=function(cloard,chain){DEBUG&&console.debug("Merging from cloud hoard"),S.client.hoard.merge_from_cloud(cloard,ST.action,function(conflicts){conflicts.length>0&&(SD.squeak({title:TX.warning(),severity:"warning",message:TX.tx("Conflicts were detected while merging actions from the Cloud. Please review these rejected actions before saving.")}),$.each(conflicts,function(i,c){var e=c.conflict;SD.squeak_more({severity:"warning",message:Hoard.stringify_action(e)+": "+c.message})})),S.cloud.status=S.IS_LOADED,chain()})},S.unsaved_changes=function(max_changes){var message=[];if($(".tree-node .tree-modified").each(function(){DEBUG&&!$(this).data("path")&&$(this).hasClass("tree-root");var path=$(this).data("path")||"node";message.push(TX.tx("$1 has changed",path.replace(S.PATHSEP,"/")))}),message.length>max_changes){var l=message.length;message=message.slice(0,max_changes),message.push(TX.tx("... and $1 more change$?($1!=1,s,)",l-5))}return S.cloud.status!==S.IS_LOADED&&message.unshift(TX.tx("The $1 hoard $2",S.cloud.store?S.cloud.store.options().identifier:TX.tx("Cloud"),TX.tx(S.cloud.status))),S.client.status!==S.IS_LOADED&&message.unshift(TX.tx("The $1 hoard $2",S.client.store.options().identifier,TX.tx(S.client.status))),0===message.length?null:message.join("\n")},S.insert_data=function(path,data){SD.squeak({title:"Loading"}),S.client.hoard.actions_from_hierarchy({data:data},function(act,next){act.path=path.slice().concat(act.path);var res=S.client.hoard.record_action(act,function(sact){ST.action(sact,!1,next)});null!==res&&SD.squeak_more(res.message),next&&next()},function(){Utils.sometime("update_save"),SD.squeak_more(TX.tx("JSON has been loaded"))})},S.save_hoards=function(){SD.squeak({title:TX.tx("Saving")});var client_ok=!0,cloud_ok=!0,finished=function(){DEBUG&&console.debug("...save finished"),Utils.sometime("update_save"),client_ok&&cloud_ok?S.client.hoard.options.autosave?SD.close_dialog($("#squeak")):SD.squeak_more(TX.tx("Save complete")):(SD.squeak_more({severity:"error",message:TX.tx("Save encountered errors")}),S.client.hoard.options.autosave=!1)},write_client_store=function(){S.client.store.writes("S."+S.client.store.user(),JSON.stringify(S.client.hoard),function(){DEBUG&&console.debug("...client save OK"),$(".tree-modified").removeClass("tree-modified"),S.client.status=S.IS_LOADED,SD.squeak_more(TX.tx("Saved in $1",this.options().identifier)),finished()},function(e){DEBUG&&console.debug("...client save failed "+e),SD.squeak_more({severity:"error",message:TX.tx("Failed to save in $1: $2",this.options().identifier,e)}),client_ok=!1,finished()})},save_client=function(){if(DEBUG&&console.debug("...save to client"),S.client.status===S.IS_LOADED&&0===$(".tree-modified").length)return void finished();S.client.status=S.PENDING_SAVE,SD.squeak_more({severity:"while",message:TX.tx("Saving in $1",S.client.store.options().identifier)}),Utils.soon(write_client_store)},write_cloud_store=function(cloard){S.cloud.store.writes(S.client.hoard.options.store_path,JSON.stringify(cloard),function(){DEBUG&&console.debug("...cloud save OK"),S.client.hoard.actions=[],S.client.hoard.last_sync=Date.now(),SD.squeak_more(TX.tx("Saved in $1",this.options().identifier)),S.cloud.status=S.IS_LOADED,save_client()},function(e){DEBUG&&console.debug("...cloud save failed "+e),SD.squeak_more({severity:"error",message:TX.tx("Failed to save in $1: $2",this.options().identifier,e)}),cloud_ok=!1,save_client()})},update_cloud_store=function(cloard){cloard.actions=cloard.actions.concat(S.client.hoard.actions),S.cloud.store?(DEBUG&&console.debug("...save to cloud"),SD.squeak_more({severity:"while",message:TX.tx("Saving in $1",S.cloud.store.options().identifier)}),S.cloud.status=S.PENDING_SAVE,Utils.soon(function(){write_cloud_store(cloard)})):(DEBUG&&console.debug("...no cloud store"),save_client())},construct_new_cloud=function(){DEBUG&&console.debug("...construct cloud ");var cloard=new Hoard;S.client.hoard.reconstruct_actions(function(a,next){cloard.actions.push({type:a.type,time:a.time,data:a.data,path:a.path.slice()}),next&&next()},function(){update_cloud_store(cloard)})},cloud_store_read_ok=function(data){var cloard;DEBUG&&console.debug("...cloud read OK ");try{cloard=new Hoard(JSON.parse(data)),S.cloud.status=S.IS_LOADED}catch(e){return DEBUG&&console.debug("Cloud hoard JSON parse failed: "+e),SD.squeak_more({severity:"error",message:TX.tx("$1 hoard can't be read for update",this.options().identifier)}),S.cloud.status=S.IS_CORRUPT,cloud_ok=!1,void construct_new_cloud()}S.cloud.status===S.IS_LOADED&&(DEBUG&&console.debug("...merge cloud "),S.client.hoard.merge_from_cloud(cloard,ST.action)),S.cloud.status!==S.IS_LOADED||0!==S.client.hoard.actions.length?(DEBUG&&console.debug("...update from cloud "),update_cloud_store(cloard)):Utils.soon(save_client)},cloud_store_read_failed=function(e){DEBUG&&console.debug("...cloud read failed "+e),e===AbstractStore.NODATA?(DEBUG&&console.debug(this.options().identifier+" contains NODATA"),S.cloud.status=S.IS_EMPTY,construct_new_cloud()):(SD.squeak_more({severity:"error",message:TX.tx("Failed to refresh from $1: $2",this.options().identifier,e)}),cloud_ok=!1,Utils.soon(save_client))};DEBUG&&console.debug("Saving; client "+S.client.status+"; cloud "+S.cloud.status),S.cloud.status===S.NEW_SETTINGS||S.cloud.status===S.IS_EMPTY?(DEBUG&&console.debug("...constructing new cloud because settings"),construct_new_cloud()):(DEBUG&&console.debug("...reloading cloud"),S.cloud.store.reads(S.client.hoard.options.store_path,cloud_store_read_ok,cloud_store_read_failed))},S.update_save=function(){$("#authenticated_undo").toggle(ST.can_undo()),$("#extras_autosave").val(S.client.hoard.options.autosave?"on":"off");var us=S.unsaved_changes(3),$sb=$("#authenticated_save");null!==us?S.client.hoard.options.autosave?S.save_hoards():($sb.attr("title",TX.tx("Save is required because: ")+us),$sb.show()):$("#authenticated_save").hide()},S.hoards_loaded=function(){S.authenticated(),$(window).on("beforeunload",function(){var us=S.unsaved_changes(10);if(null!==us)return us=TX.tx("You have unsaved changes")+"\n"+us+"\n"+TX.tx("Are you really sure?")}),Utils.sometime("update_save"),Utils.sometime("check_alarms"),Utils.sometime_is_now()},S.load_cloud_hoard=function(){S.cloud.store?(DEBUG&&console.debug("Reading cloud "+S.cloud.store.options().identifier),S.cloud.store.reads(S.client.hoard.options.store_path,function(data){var hoard;DEBUG&&console.debug(this.options().identifier+" is ready");try{hoard=JSON.parse(data)}catch(e){return DEBUG&&console.debug("Client hoard JSON parse failed: "+e),SD.squeak({title:TX.error(),severity:"error",message:TX.tx("$1 hoard exists, but can't be read.",this.options().identifier)+" "+TX.tx("Check that you have the correct password.")}),S.cloud.status=S.IS_CORRUPT,void Utils.soon(S.hoards_loaded)}S.get_updates_from_cloud(new Hoard(hoard),S.hoards_loaded)},function(e){e===AbstractStore.NODATA?(DEBUG&&console.debug(this.options().identifier+" contains NODATA"),S.cloud.status=S.IS_EMPTY):(DEBUG&&console.debug(this.options().identifier+" has NODATA: "+e),SD.squeak({title:TX.error(),severity:"error",message:TX.tx("Could not load cloud hoard.")}),SD.squeak_more(TX.tx("Check that you have the correct password."))),Utils.soon(S.hoards_loaded)})):S.hoards_loaded()},S.init_client_hoard=function(){DEBUG&&console.debug("Setting up client hoard"),S.client.hoard=new Hoard,S.client.status=S.IS_EMPTY,S.cloud.store&&S.cloud.store.options().needs_path?SD.store_settings(S.load_cloud_hoard):S.load_cloud_hoard()},S.load_client_hoard=function(){var rebuild_hoard=function(){DEBUG&&console.debug("Reconstructing UI tree from cache"),S.client.hoard.reconstruct_actions(function(a,next){ST.action(a,!1,next)},function(){$(".tree-modified").removeClass("tree-modified");var i,p,$node,as=S.client.hoard.actions;for(i=0;i<as.length;i++)for(p=as[i].path.slice();p.length>0;){if($node=ST.get_node(p)){$node.addClass("tree-modified");break}p.pop()}Utils.soon(S.load_cloud_hoard)})};DEBUG&&console.debug("Load client store"),S.client.store.reads("S."+S.client.store.user(),function(data){try{S.client.hoard=new Hoard(JSON.parse(data)),S.client.status=S.IS_LOADED}catch(e){return DEBUG&&console.debug("Caught "+e),SD.squeak({title:TX.error(),severity:"error",message:TX.tx("$1 hoard exists, but can't be read.",this.options().identifier),after_close:function(){Utils.sometime("init_application")}}),void SD.squeak_more(TX.tx("Check that you have the correct password."))}(S.client.store&&S.client.store.options().needs_path||S.cloud.store&&S.cloud.store.options().needs_path)&&!S.client.hoard.options.store_path?SD.store_settings(rebuild_hoard):rebuild_hoard()},function(e){e===AbstractStore.NODATA?(DEBUG&&console.debug(this.options().identifier+" contains NODATA"),Utils.soon(S.init_client_hoard)):SD.squeak({title:TX.error(),severity:"error",message:TX.tx("$1 store error: $2",this.options().identifier,e),after_close:function(){Utils.sometime("init_application")}})})},S.identify_user=function(){var uReq=!0,pReq=!0;S.cloud.store&&void 0!==S.cloud.store.user()?(DEBUG&&console.debug("Cloud user is preferred: "+S.cloud.store.user()),S.client.store.user(S.cloud.store.user()),uReq=!1):S.client.store&&void 0!==S.client.store.user()&&(DEBUG&&console.debug("Client user is available: "+S.client.store.user()),S.cloud.store&&S.cloud.store.user(S.client.store.user()),uReq=!1),S.cloud.store&&void 0!==S.cloud.store.pass()?(DEBUG&&console.debug("Cloud pass is preferred"),S.client.store&&S.client.store.pass(S.cloud.store.pass()),pReq=!1):S.client.store&&void 0!==S.client.store.pass()&&(DEBUG&&console.debug("Client pass is available"),S.cloud.store&&S.cloud.store.pass(S.client.store.pass()),pReq=!1),uReq||pReq?SD.login({store:S.client.store,on_signin:function(user,pass){DEBUG&&console.debug("Login prompt said user was "+user),S.client.store.user(user),S.client.store.pass(pass),S.cloud.store&&(S.cloud.store.user(user),S.cloud.store.pass(pass)),S.load_client_hoard()},user_required:uReq,pass_required:pReq}):S.load_client_hoard()},S.init_client_store=function(){new EncryptedStore({understore:function(params){return new LocalStorageStore(params)},ok:function(){DEBUG&&console.debug(this.options().identifier+" store is ready"),S.client.store=this,$("#authmessage").text(TX.tx("Loading...")),Utils.soon(S.identify_user)},fail:function(e){SD.squeak({title:TX.error(),severity:"error",message:TX.tx("Encryption error: $1",e)})}})},S.init_cloud_store=function(){var p={ok:function(){S.cloud.store=this,Utils.soon(S.init_client_store)},fail:function(e){SD.squeak({title:TX.warning(),severity:"warning",message:TX.tx("Could not open cloud store: $1",e),after_close:function(){S.init_client_store()}}),SD.squeak_more({severity:"warning",message:TX.tx("If you continue, only the client store will be available")})}};return p.understore=function(pp){return S.USE_STEGANOGRAPHY?(pp.understore=function(ppp){return new SQUIRREL_STORE(ppp)},new StegaStore(pp)):new SQUIRREL_STORE(pp)},new EncryptedStore(p)},S.search=function(s){var re;try{re=new RegExp(s,"i")}catch(e){SD.squeak({message:TX.tx("Error in search expression '$1': ",s)+e})}var hits=[];$(".tree-key,.tree-value").each(function(){$(this).text().match(re)&&hits.push(this)}),$("#search_hits").text(TX.tx("$1 found",hits.length)),0===hits.length?SD.squeak({message:TX.tx("'$1' not found",s)}):($(".tree-open").each(function(){ST.close($(this))}),$.each(hits,function(n,v){$(v).parents(".tree-collection").each(function(){ST.open($(this))})}))},$(document).ready(function(){var qs=Utils.query_string(),unco=!/\.min\.html/.test(document.location.href);qs.debug&&(DEBUG=!0),DEBUG||$.ajaxSetup({cache:!0});var store=qs.store||"TestStore";void 0!==qs.steg&&(S.USE_STEGANOGRAPHY=!0);var store_bits=["js/"+store+".min.js"];S.USE_STEGANOGRAPHY?(store_bits.push("js/Steganographer.min.js"),store_bits.push("js/StegaStore.min.js")):$(".using_steganography").remove(),Utils.load(store_bits,unco,function(){TX.init(function(){S.init_ui(),S.init_application()})})}),S.authenticated=function(){$("#whoami").text(S.client.store.user()),$("#unauthenticated").hide(),$("#authenticated").show()};var before_open=function(e,ui){var $node=ui.target.is(".tree-node")?ui.target:ui.target.parents(".tree-node").first(),$val=$node.find(".value").first(),has_alarm=void 0!==$node.data("alarm"),is_leaf=$node.hasClass("tree-leaf"),is_root=ui.target.closest(".tree-node").is("#sites-node"),is_open=$node.hasClass("tree-open"),$root=$("body");if($root.contextmenu("showEntry","rename",!is_root).contextmenu("showEntry","copy_value",is_leaf).contextmenu("showEntry","pick_from",is_leaf).contextmenu("showEntry","make_copy",!is_root).contextmenu("showEntry","delete",!is_root).contextmenu("showEntry","add_alarm",!has_alarm&&!is_root).contextmenu("showEntry","edit",is_leaf).contextmenu("showEntry","randomise",is_leaf).contextmenu("showEntry","add_subtree",!is_leaf).contextmenu("enableEntry","add_subtree",is_open).contextmenu("showEntry","add_value",!is_leaf&&!is_root).contextmenu("enableEntry","add_value",is_open).contextmenu("showEntry","insert_copy",!is_leaf&&null!==S.clipboard),"undefined"!=typeof ZeroClipboard){var zc;$root.data("zc_copy")||(DEBUG&&console.debug("Attaching ZC copy"),zc=new ZeroClipboard(ui.menu.children("li[data-command='copy_value']")),zc.on("copy",function(event){DEBUG&&console.debug("Copying to clipboard"),event.clipboardData.setData("text/plain",$root.data("zc_copy").text())}),$root.data("ZC",zc)),$root.data("zc_copy",$val),$root.data("zc_cut")||(DEBUG&&console.debug("Attaching ZC cut"),zc=new ZeroClipboard(ui.menu.children("li[data-command='make_copy']")),zc.on("copy",function(event){DEBUG&&console.debug("Copying JSON to clipboard");var pa=$root.data("zc_cut"),p=ST.get_path(pa),n=S.client.hoard.get_node(p),json=JSON.stringify(n);S.clipboard=json,event.clipboardData.setData("text/plain",json)}),$root.data("ZC",zc)),$root.data("zc_cut",$node.closest(".tree-node"))}},handle_menu_choice=function(e,ui){var $node=ui.target.closest(".tree-node");if(!$node)throw"No node for contextmenu";switch(ui.cmd){case"copy_value":case"make_copy":break;case"insert_copy":if(DEBUG&&console.debug("Pasting"),S.clipboard){var data=JSON.parse(S.clipboard);S.add_child_node($node,TX.tx("A copy"),data.data)}break;case"rename":DEBUG&&console.debug("Renaming"),ST.edit($node,".tree-key");break;case"edit":DEBUG&&console.debug("Editing"),ST.edit($node,".tree-value");break;case"add_value":SD.add($node,!0);break;case"add_subtree":SD.add($node,!1);break;case"randomise":DEBUG&&console.debug("Randomising"),S.Dialog.randomise($node);break;case"add_alarm":DEBUG&&console.debug("Adding reminder"),S.Dialog.alarm($node);break;case"delete":DEBUG&&console.debug("Deleting"),S.Dialog.delete_node($node);break;case"pick_from":DEBUG&&console.debug("Picking"),S.Dialog.pick($node);break;default:DEBUG}},init_menus=function(){var menu={delegate:".tree-info",menu:[{title:TX.tx("Copy value"),cmd:"copy_value",uiIcon:"ui-icon-squirrel-copy"},{title:TX.tx("Pick characters"),cmd:"pick_from",uiIcon:"ui-icon-squirrel-pick"},{title:TX.tx("Rename"),cmd:"rename",uiIcon:"ui-icon-squirrel-edit"},{title:TX.tx("Edit value"),cmd:"edit",uiIcon:"ui-icon-squirrel-edit"},{title:TX.tx("Add reminder"),cmd:"add_alarm",uiIcon:"ui-icon-squirrel-alarm"},{title:TX.tx("Generate new random value"),cmd:"randomise",uiIcon:"ui-icon-squirrel-key"},{title:TX.tx("Add new value"),cmd:"add_value",uiIcon:"ui-icon-squirrel-add-value"},{title:TX.tx("Add new folder"),cmd:"add_subtree",uiIcon:"ui-icon-squirrel-add-folder"},{title:TX.tx("Copy folder"),cmd:"make_copy",uiIcon:"ui-icon-squirrel-copy"},{title:TX.tx("Insert copy"),cmd:"insert_copy",uiIcon:"ui-icon-squirrel-paste"},{title:TX.tx("Delete"),cmd:"delete",uiIcon:"ui-icon-squirrel-delete"}],preventContextMenuForPopup:!0,preventSelect:!0,taphold:!0,beforeOpen:before_open,select:handle_menu_choice};$("body").contextmenu(menu)}}(jQuery,Squirrel);
//# sourceMappingURL=Squirrel.map