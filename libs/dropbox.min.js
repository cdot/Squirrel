(function(){var DbxClient,DbxEnvGlobal,DbxEnvRequire,DbxXhrArrayBufferView,DbxXhrCanSendForms,DbxXhrDoesPreflight,DbxXhrIeMode,DbxXhrRequest,DbxXhrSendArrayBufferView,DbxXhrWrapBlob,Dropbox,__hasProp={}.hasOwnProperty,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1},__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};if(Dropbox=function(){function Dropbox(){throw new Error("Not implemented. Did you mean to use Dropbox.Client?")}return Dropbox}(),Dropbox.Util=function(){function Util(){}return Util}(),Dropbox.Http=function(){function Http(){}return Http}(),Dropbox.File=function(){function File(){}return File}(),"undefined"!=typeof global&&"undefined"!=typeof module&&"exports"in module)DbxEnvGlobal=global,DbxEnvRequire=module.require.bind(module),module.exports=Dropbox;else if("undefined"!=typeof window&&"undefined"!=typeof navigator)DbxEnvGlobal=window,DbxEnvRequire=null,window.Dropbox&&function(){var name,value,_ref,_results;_ref=window.Dropbox,_results=[];for(name in _ref)__hasProp.call(_ref,name)&&(value=_ref[name],_results.push(Dropbox[name]=value))}(),window.Dropbox=Dropbox;else{if("undefined"==typeof self||"undefined"==typeof navigator)throw new Error("dropbox.js loaded in an unsupported JavaScript environment.");DbxEnvGlobal=self,DbxEnvRequire=self.importScripts.bind(self),self.Dropbox=Dropbox}if(Dropbox.Env=function(){function Env(){}return Env.global=DbxEnvGlobal,Env.require=DbxEnvRequire,Env}(),Dropbox.Util.EventSource=function(){function EventSource(options){this._cancelable=options&&options.cancelable,this._listeners=[]}return EventSource.prototype.addListener=function(listener){if("function"!=typeof listener)throw new TypeError("Invalid listener type; expected function");return __indexOf.call(this._listeners,listener)<0&&this._listeners.push(listener),this},EventSource.prototype.removeListener=function(listener){var i,index,_i,_len,_ref;if(this._listeners.indexOf)-1!==(index=this._listeners.indexOf(listener))&&this._listeners.splice(index,1);else for(_ref=this._listeners,i=_i=0,_len=_ref.length;_i<_len;i=++_i)if(_ref[i]===listener){this._listeners.splice(i,1);break}return this},EventSource.prototype.dispatch=function(event){var listener,returnValue,_i,_len,_ref;for(_ref=this._listeners,_i=0,_len=_ref.length;_i<_len;_i++)if(listener=_ref[_i],returnValue=listener(event),this._cancelable&&!1===returnValue)return!1;return!0},EventSource}(),Dropbox.AccountInfo=function(){function AccountInfo(accountInfo){var lastIndex;this._json=accountInfo,this.name=accountInfo.display_name,this.email=accountInfo.email,this.countryCode=accountInfo.country||null,this.uid=accountInfo.uid.toString(),accountInfo.public_app_url?(this.publicAppUrl=accountInfo.public_app_url,(lastIndex=this.publicAppUrl.length-1)>=0&&"/"===this.publicAppUrl.substring(lastIndex)&&(this.publicAppUrl=this.publicAppUrl.substring(0,lastIndex))):this.publicAppUrl=null,this.referralUrl=accountInfo.referral_link,this.quota=accountInfo.quota_info.quota,this.privateBytes=accountInfo.quota_info.normal||0,this.sharedBytes=accountInfo.quota_info.shared||0,this.usedQuota=this.privateBytes+this.sharedBytes}return AccountInfo.parse=function(accountInfo){return accountInfo&&"object"==typeof accountInfo?new Dropbox.AccountInfo(accountInfo):accountInfo},AccountInfo.prototype.name=null,AccountInfo.prototype.email=null,AccountInfo.prototype.countryCode=null,AccountInfo.prototype.uid=null,AccountInfo.prototype.referralUrl=null,AccountInfo.prototype.publicAppUrl=null,AccountInfo.prototype.quota=null,AccountInfo.prototype.usedQuota=null,AccountInfo.prototype.privateBytes=null,AccountInfo.prototype.sharedBytes=null,AccountInfo.prototype.json=function(){return this._json},AccountInfo}(),Dropbox.ApiError=function(){function ApiError(xhr,method,url){var text;if(this.method=method,this.url=url,this.status=xhr.status,xhr.responseType)try{text=xhr.response||xhr.responseText}catch(_error){_error;try{text=xhr.responseText}catch(_error){_error,text=null}}else try{text=xhr.responseText}catch(_error){_error,text=null}if(text)try{this.responseText=text.toString(),this.response=JSON.parse(text)}catch(_error){_error,this.response=null}else this.responseText="(no response)",this.response=null}return ApiError.prototype.status=null,ApiError.prototype.method=null,ApiError.prototype.url=null,ApiError.prototype.responseText=null,ApiError.prototype.response=null,ApiError.NETWORK_ERROR=0,ApiError.NO_CONTENT=304,ApiError.INVALID_PARAM=400,ApiError.INVALID_TOKEN=401,ApiError.OAUTH_ERROR=403,ApiError.NOT_FOUND=404,ApiError.INVALID_METHOD=405,ApiError.NOT_ACCEPTABLE=406,ApiError.CONFLICT=409,ApiError.RATE_LIMITED=429,ApiError.SERVER_ERROR=503,ApiError.OVER_QUOTA=507,ApiError.prototype.toString=function(){return"Dropbox API error "+this.status+" from "+this.method+" "+this.url+" :: "+this.responseText},ApiError.prototype.inspect=function(){return this.toString()},ApiError}(),Dropbox.AuthDriver=function(){function AuthDriver(){}return AuthDriver.prototype.authType=function(){return"code"},AuthDriver.prototype.url=function(){return"https://some.url"},AuthDriver.prototype.doAuthorize=function(authUrl,stateParam,client,callback){return callback({code:"access-code"})},AuthDriver.prototype.getStateParam=function(client,callback){return callback(Dropbox.Util.Oauth.randomAuthStateParam())},AuthDriver.prototype.resumeAuthorize=function(stateParam,client,callback){return callback({code:"access-code"})},AuthDriver.prototype.onAuthStateChange=function(client,callback){return callback()},AuthDriver.oauthQueryParams=["access_token","expires_in","scope","token_type","code","error","error_description","error_uri","mac_key","mac_algorithm"].sort(),AuthDriver}(),Dropbox.AuthDriver.autoConfigure=function(client){if("undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.id)return void(chrome.tabs&&chrome.tabs.create?client.authDriver(new Dropbox.AuthDriver.ChromeExtension):client.authDriver(new Dropbox.AuthDriver.ChromeApp));if("undefined"!=typeof window){if(window.cordova)return void client.authDriver(new Dropbox.AuthDriver.Cordova);window&&window.navigator&&client.authDriver(new Dropbox.AuthDriver.Redirect)}},Dropbox.AuthDriver.BrowserBase=function(){function BrowserBase(options){options?(this.rememberUser=!("rememberUser"in options)||options.rememberUser,this.scope=options.scope||"default"):(this.rememberUser=!0,this.scope="default"),this.storageKey=null,this.storage=Dropbox.AuthDriver.BrowserBase.localStorage(),this.stateRe=/^[^#]+\#(.*&)?state=([^&]+)(&|$)/}return BrowserBase.prototype.authType=function(){return"token"},BrowserBase.prototype.onAuthStepChange=function(client,callback){var _this=this;switch(this.setStorageKey(client),client.authStep){case Dropbox.Client.RESET:return this.loadCredentials(function(credentials){return credentials?(client.setCredentials(credentials),client.authStep!==Dropbox.Client.DONE?callback():_this.rememberUser?(client.setCredentials(credentials),callback()):_this.forgetCredentials(callback)):callback()});case Dropbox.Client.DONE:return this.rememberUser?this.storeCredentials(client.credentials(),callback):this.forgetCredentials(callback);case Dropbox.Client.SIGNED_OUT:case Dropbox.Client.ERROR:return this.forgetCredentials(callback);default:return callback(),this}},BrowserBase.prototype.setStorageKey=function(client){return this.storageKey="dropbox-auth:"+this.scope+":"+client.appHash(),this},BrowserBase.prototype.storeCredentials=function(credentials,callback){var jsonString,name,value;jsonString=JSON.stringify(credentials);try{this.storage.setItem(this.storageKey,jsonString)}catch(_error){_error,name=encodeURIComponent(this.storageKey),value=encodeURIComponent(jsonString),document.cookie=name+"="+value+"; path=/"}return callback(),this},BrowserBase.prototype.loadCredentials=function(callback){var cookieRegexp,jsonString,match,name;try{jsonString=this.storage.getItem(this.storageKey)}catch(_error){_error,jsonString=null}if(null===jsonString&&(name=encodeURIComponent(this.storageKey),name.replace(/[.*+()]/g,"\\$&"),cookieRegexp=new RegExp("(^|(;\\s*))"+name+"=([^;]*)(;|$)"),(match=cookieRegexp.exec(document.cookie))&&(jsonString=decodeURIComponent(match[3]))),!jsonString)return callback(null),this;try{callback(JSON.parse(jsonString))}catch(_error){_error,callback(null)}return this},BrowserBase.prototype.forgetCredentials=function(callback){var expires,name;try{this.storage.removeItem(this.storageKey)}catch(_error){_error,name=encodeURIComponent(this.storageKey),expires=new Date(0).toGMTString(),document.cookie=name+"={}; expires="+expires+"; path=/"}return callback(),this},BrowserBase.prototype.locationStateParam=function(url){var location,match;return location=url||Dropbox.AuthDriver.BrowserBase.currentLocation(),match=this.stateRe.exec(location),match?decodeURIComponent(match[2]):null},BrowserBase.prototype.replaceUrlBasename=function(url,basename){var fragments,hashIndex,queryIndex;return hashIndex=url.indexOf("#"),-1!==hashIndex&&(url=url.substring(0,hashIndex)),queryIndex=url.indexOf("?"),-1!==queryIndex&&(url=url.substring(0,queryIndex)),fragments=url.split("/"),fragments[fragments.length-1]=basename,fragments.join("/")},BrowserBase.localStorage=function(){return"undefined"!=typeof window?window.localStorage:null},BrowserBase.currentLocation=function(){return window.location.href},BrowserBase.cleanupLocation=function(){var hashIndex,pageUrl;window.history&&window.history.replaceState?(pageUrl=this.currentLocation(),hashIndex=pageUrl.indexOf("#"),window.history.replaceState({},document.title,pageUrl.substring(0,hashIndex))):window.location.hash=""},BrowserBase}(),Dropbox.AuthDriver.Redirect=function(_super){function Redirect(options){Redirect.__super__.constructor.call(this,options),this.receiverUrl=this.baseUrl(options)}return __extends(Redirect,_super),Redirect.prototype.baseUrl=function(options){var hashIndex,url;if(url=Dropbox.AuthDriver.BrowserBase.currentLocation(),options){if(options.redirectUrl)return options.redirectUrl;if(options.redirectFile)return this.replaceUrlBasename(url,options.redirectFile)}return hashIndex=url.indexOf("#"),-1!==hashIndex&&(url=url.substring(0,hashIndex)),url},Redirect.prototype.url=function(){return this.receiverUrl},Redirect.prototype.doAuthorize=function(authUrl,stateParam,client){return this.storeCredentials(client.credentials(),function(){return window.location.assign(authUrl)})},Redirect.prototype.resumeAuthorize=function(stateParam,client,callback){var pageUrl;return this.locationStateParam()===stateParam?(pageUrl=Dropbox.AuthDriver.BrowserBase.currentLocation(),Dropbox.AuthDriver.BrowserBase.cleanupLocation(),callback(Dropbox.Util.Oauth.queryParamsFromUrl(pageUrl))):this.forgetCredentials(function(){return callback({error:"Authorization error"})})},Redirect}(Dropbox.AuthDriver.BrowserBase),Dropbox.AuthDriver.Popup=function(_super){function Popup(options){Popup.__super__.constructor.call(this,options),this.receiverUrl=this.baseUrl(options)}return __extends(Popup,_super),Popup.prototype.url=function(){return this.receiverUrl},Popup.prototype.doAuthorize=function(authUrl,stateParam,client,callback){return this.listenForMessage(stateParam,callback),this.openWindow(authUrl)},Popup.prototype.baseUrl=function(options){var url;if(url=Dropbox.AuthDriver.BrowserBase.currentLocation(),options){if(options.receiverUrl)return options.receiverUrl;if(options.receiverFile)return this.replaceUrlBasename(url,options.receiverFile)}return url},Popup.prototype.openWindow=function(url){return window.open(url,"_dropboxOauthSigninWindow",this.popupWindowSpec(980,700))},Popup.prototype.popupWindowSpec=function(popupWidth,popupHeight){var height,popupLeft,popupTop,width,x0,y0,_ref,_ref1,_ref2,_ref3;return x0=null!=(_ref=window.screenX)?_ref:window.screenLeft,y0=null!=(_ref1=window.screenY)?_ref1:window.screenTop,width=null!=(_ref2=window.outerWidth)?_ref2:document.documentElement.clientWidth,height=null!=(_ref3=window.outerHeight)?_ref3:document.documentElement.clientHeight,popupLeft=Math.round(x0+(width-popupWidth)/2),popupTop=Math.round(y0+(height-popupHeight)/2.5),popupLeft<x0&&(popupLeft=x0),popupTop<y0&&(popupTop=y0),"width="+popupWidth+",height="+popupHeight+",left="+popupLeft+",top="+popupTop+"dialog=yes,dependent=yes,scrollbars=yes,location=yes"},Popup.prototype.listenForMessage=function(stateParam,callback){var listener,_this=this;return listener=function(event){var data,oauthInfo;data=event.data?event.data:event;try{oauthInfo=JSON.parse(data)._dropboxjs_oauth_info}catch(_error){return void _error}if(oauthInfo)return _this.locationStateParam(oauthInfo)===stateParam?(stateParam=!1,window.removeEventListener("message",listener),Dropbox.AuthDriver.Popup.onMessage.removeListener(listener),callback(Dropbox.Util.Oauth.queryParamsFromUrl(data))):void 0},window.addEventListener("message",listener,!1),Dropbox.AuthDriver.Popup.onMessage.addListener(listener)},Popup.locationOrigin=function(location){var match;return(match=/^(file:\/\/[^\?\#]*)(\?|\#|$)/.exec(location))?match[1]:(match=/^([^\:]+\:\/\/[^\/\?\#]*)(\/|\?|\#|$)/.exec(location),match?match[1]:location)},Popup.oauthReceiver=function(){window.addEventListener("load",function(){var message,opener,pageOrigin,pageUrl;if(pageUrl=window.location.href,message=JSON.stringify({_dropboxjs_oauth_info:pageUrl}),Dropbox.AuthDriver.BrowserBase.cleanupLocation(),opener=window.opener,window.parent!==window.top&&(opener||(opener=window.parent)),opener){try{pageOrigin=window.location.origin||locationOrigin(pageUrl),opener.postMessage(message,pageOrigin),window.close()}catch(_error){_error}try{return opener.Dropbox.AuthDriver.Popup.onMessage.dispatch(message),window.close()}catch(_error){_error}}})},Popup.onMessage=new Dropbox.Util.EventSource,Popup}(Dropbox.AuthDriver.BrowserBase),Dropbox.AuthDriver.ChromeBase=function(_super){function ChromeBase(options){ChromeBase.__super__.constructor.call(this,options),this.storageKey="dropbox_js_"+this.scope+"_credentials"}return __extends(ChromeBase,_super),ChromeBase.prototype.onAuthStepChange=function(client,callback){switch(client.authStep){case Dropbox.Client.RESET:return this.loadCredentials(function(credentials){return credentials&&client.setCredentials(credentials),callback()});case Dropbox.Client.DONE:return this.storeCredentials(client.credentials(),callback);case Dropbox.Client.SIGNED_OUT:case Dropbox.Client.ERROR:return this.forgetCredentials(callback);default:return callback()}},ChromeBase.prototype.url=function(){return this.receiverUrl},ChromeBase.prototype.storeCredentials=function(credentials,callback){var items;return items={},items[this.storageKey]=credentials,chrome.storage.local.set(items,callback),this},ChromeBase.prototype.loadCredentials=function(callback){var _this=this;return chrome.storage.local.get(this.storageKey,function(items){return callback(items[_this.storageKey]||null)}),this},ChromeBase.prototype.forgetCredentials=function(callback){return chrome.storage.local.remove(this.storageKey,callback),this},ChromeBase}(Dropbox.AuthDriver.BrowserBase),Dropbox.AuthDriver.ChromeApp=function(_super){function ChromeApp(options){ChromeApp.__super__.constructor.call(this,options),this.receiverUrl="https://"+chrome.runtime.id+".chromiumapp.org/"}return __extends(ChromeApp,_super),ChromeApp.prototype.doAuthorize=function(authUrl,stateParam,client,callback){var _this=this;return chrome.identity.launchWebAuthFlow({url:authUrl,interactive:!0},function(redirectUrl){if(_this.locationStateParam(redirectUrl)===stateParam)return stateParam=!1,callback(Dropbox.Util.Oauth.queryParamsFromUrl(redirectUrl))})},ChromeApp}(Dropbox.AuthDriver.ChromeBase),Dropbox.AuthDriver.ChromeExtension=function(_super){function ChromeExtension(options){var receiverPath;ChromeExtension.__super__.constructor.call(this,options),receiverPath=options&&options.receiverPath||"chrome_oauth_receiver.html",this.receiverUrl=chrome.runtime.getURL(receiverPath)}return __extends(ChromeExtension,_super),ChromeExtension.prototype.doAuthorize=function(authUrl,stateParam,client,callback){var listener,oauthTab,_this=this;return oauthTab=null,listener=function(message,sender){var receiverHref;if((!sender||!sender.tab||sender.tab.url.substring(0,_this.receiverUrl.length)===_this.receiverUrl)&&message.dropbox_oauth_receiver_href)return receiverHref=message.dropbox_oauth_receiver_href,_this.locationStateParam(receiverHref)===stateParam?(stateParam=!1,oauthTab&&chrome.tabs.remove(oauthTab.id),chrome.runtime.onMessage.removeListener(listener),callback(Dropbox.Util.Oauth.queryParamsFromUrl(receiverHref))):void 0},chrome.runtime.onMessage.addListener(listener),chrome.tabs.create({url:authUrl,active:!0,pinned:!1},function(tab){return oauthTab=tab})},ChromeExtension.oauthReceiver=function(){return window.addEventListener("load",function(){var pageUrl;if(pageUrl=window.location.href,window.location.hash="",chrome.runtime.sendMessage({dropbox_oauth_receiver_href:pageUrl}),window.close)return window.close()})},ChromeExtension}(Dropbox.AuthDriver.ChromeBase),Dropbox.AuthDriver.Cordova=function(_super){function Cordova(options){Cordova.__super__.constructor.call(this,options)}return __extends(Cordova,_super),Cordova.prototype.url=function(){return"https://www.dropbox.com/1/oauth2/redirect_receiver"},Cordova.prototype.doAuthorize=function(authUrl,stateParam,client,callback){var browser,onEvent,removed,_this=this;return browser=window.open(authUrl,"_blank","location=yes,closebuttoncaption=Cancel"),!1,/^[^\/]*\/\/[^\/]*\//.exec(authUrl)[0],removed=!1,onEvent=function(event){if(event.url&&_this.locationStateParam(event.url)===stateParam){if(removed)return;return browser.removeEventListener("loadstart",onEvent),browser.removeEventListener("loaderror",onEvent),browser.removeEventListener("loadstop",onEvent),browser.removeEventListener("exit",onEvent),removed=!0,window.setTimeout(function(){return browser.close()},10),void callback(Dropbox.Util.Oauth.queryParamsFromUrl(event.url))}if("exit"===event.type){if(removed)return;browser.removeEventListener("loadstart",onEvent),browser.removeEventListener("loaderror",onEvent),browser.removeEventListener("loadstop",onEvent),browser.removeEventListener("exit",onEvent),removed=!0,callback(new AuthError("error=access_denied&error_description=User+closed+browser+window"))}},browser.addEventListener("loadstart",onEvent),browser.addEventListener("loaderror",onEvent),browser.addEventListener("loadstop",onEvent),browser.addEventListener("exit",onEvent)},Cordova}(Dropbox.AuthDriver.BrowserBase),Dropbox.AuthDriver.NodeServer=function(){function NodeServer(options){this._port=(null!=options?options.port:void 0)||8912,(null!=options?options.tls:void 0)?(this._tlsOptions=options.tls,("string"==typeof this._tlsOptions||this._tlsOptions instanceof Buffer)&&(this._tlsOptions={key:this._tlsOptions,cert:this._tlsOptions})):this._tlsOptions=null,this._fs=Dropbox.Env.require("fs"),this._http=Dropbox.Env.require("http"),this._https=Dropbox.Env.require("https"),this._open=Dropbox.Env.require("open"),this._callbacks={},this._nodeUrl=Dropbox.Env.require("url"),this.createApp()}return NodeServer.prototype.authType=function(){return"code"},NodeServer.prototype.url=function(){return(null===this._tlsOptions?"http":"https")+"://localhost:"+this._port+"/oauth_callback"},NodeServer.prototype.doAuthorize=function(authUrl,stateParam,client,callback){return this._callbacks[stateParam]=callback,this.openBrowser(authUrl)},NodeServer.prototype.openBrowser=function(url){if(!url.match(/^https?:\/\//))throw new Error("Not a http/https URL: "+url);return"BROWSER"in process.env?this._open(url,process.env.BROWSER):this._open(url)},NodeServer.prototype.createApp=function(){var _this=this;return this._tlsOptions?this._app=this._https.createServer(this._tlsOptions,function(request,response){return _this.doRequest(request,response)}):this._app=this._http.createServer(function(request,response){return _this.doRequest(request,response)}),this._app.listen(this._port)},NodeServer.prototype.closeServer=function(){return this._app.close()},NodeServer.prototype.doRequest=function(request,response){var data,stateParam,url,_this=this;return url=this._nodeUrl.parse(request.url,!0),"/oauth_callback"===url.pathname&&(stateParam=url.query.state,this._callbacks[stateParam]&&(this._callbacks[stateParam](url.query),delete this._callbacks[stateParam])),data="",request.on("data",function(dataFragment){return data+=dataFragment}),request.on("end",function(){return _this.closeBrowser(response)})},NodeServer.prototype.closeBrowser=function(response){var closeHtml;return closeHtml='<!doctype html>\n<script type="text/javascript">window.close();<\/script>\n<p>Please close this window.</p>',response.writeHead(200,{"Content-Length":closeHtml.length,"Content-Type":"text/html"}),response.write(closeHtml),response.end()},NodeServer}(),Dropbox.AuthError=function(){function AuthError(queryString){var root;if(!queryString.error)throw new Error("Not an OAuth 2.0 error: "+JSON.stringify(queryString));root="object"==typeof queryString.error&&queryString.error.error?queryString.error:queryString,this.code=root.error,this.description=root.error_description||null,this.uri=root.error_uri||null}return AuthError.prototype.code=null,AuthError.prototype.description=null,AuthError.prototype.uri=null,AuthError.ACCESS_DENIED="access_denied",AuthError.INVALID_REQUEST="invalid_request",AuthError.UNAUTHORIZED_CLIENT="unauthorized_client",AuthError.INVALID_GRANT="invalid_grant",AuthError.INVALID_SCOPE="invalid_scope",AuthError.UNSUPPORTED_GRANT_TYPE="unsupported_grant_type",AuthError.UNSUPPORTED_RESPONSE_TYPE="unsupported_response_type",AuthError.SERVER_ERROR="server_error",AuthError.TEMPORARILY_UNAVAILABLE="temporarily_unavailable",AuthError.prototype.toString=function(){return"Dropbox OAuth error "+this.code+" :: "+this.description},AuthError.prototype.inspect=function(){return this.toString()},AuthError}(),Dropbox.Client=function(){function Client(options){var _this=this;this._serverRoot=options.server||this._defaultServerRoot(),this._maxApiServer="maxApiServer"in options?options.maxApiServer:this._defaultMaxApiServer(),this._authServer=options.authServer||this._defaultAuthServer(),this._fileServer=options.fileServer||this._defaultFileServer(),this._downloadServer=options.downloadServer||this._defaultDownloadServer(),this._notifyServer=options.notifyServer||this._defaultNotifyServer(),this.onXhr=new Dropbox.Util.EventSource({cancelable:!0}),this.onError=new Dropbox.Util.EventSource,this.onAuthStepChange=new Dropbox.Util.EventSource,this._xhrOnErrorHandler=function(error,callback){return _this._handleXhrError(error,callback)},this._oauth=new Dropbox.Util.Oauth(options),this._uid=options.uid||null,this.authStep=this._oauth.step(),this._driver=null,this.authError=null,this._credentials=null,this.setupUrls()}return Client.prototype.onXhr=null,Client.prototype.onError=null,Client.prototype.onAuthStepChange=null,Client.prototype.authDriver=function(driver){return this._driver=driver,this},Client.prototype.dropboxUid=function(){return this._uid},Client.prototype.credentials=function(){return this._credentials||this._computeCredentials(),this._credentials},Client.prototype.authenticate=function(options,callback){var interactive,oldAuthStep,_fsmErrorStep,_fsmNextStep,_fsmStep,_this=this;if(callback||"function"!=typeof options||(callback=options,options=null),interactive=!(options&&"interactive"in options)||options.interactive,!this._driver&&this.authStep!==DbxClient.DONE&&(Dropbox.AuthDriver.autoConfigure(this),!this._driver))throw new Error("OAuth driver auto-configuration failed. Call authDriver.");if(this.authStep===DbxClient.ERROR)throw new Error("Client got in an error state. Call reset() to reuse it!");return _fsmNextStep=function(){return _this.authStep=_this._oauth.step(),_this.authStep===DbxClient.ERROR&&(_this.authError=_this._oauth.error()),_this._credentials=null,_this.onAuthStepChange.dispatch(_this),_fsmStep()},_fsmErrorStep=function(){return _this.authStep=DbxClient.ERROR,_this._credentials=null,_this.onAuthStepChange.dispatch(_this),_fsmStep()},oldAuthStep=null,_fsmStep=function(){var authUrl;if(oldAuthStep!==_this.authStep&&(oldAuthStep=_this.authStep,_this._driver&&_this._driver.onAuthStepChange))return void _this._driver.onAuthStepChange(_this,_fsmStep);switch(_this.authStep){case DbxClient.RESET:return interactive?(_this._driver.getStateParam&&_this._driver.getStateParam(function(stateParam){return _this.client.authStep===DbxClient.RESET&&_this._oauth.setAuthStateParam(stateParam),_fsmNextStep()}),_this._oauth.setAuthStateParam(Dropbox.Util.Oauth.randomAuthStateParam()),_fsmNextStep()):void(callback&&callback(null,_this));case DbxClient.PARAM_SET:return interactive?(authUrl=_this.authorizeUrl(),_this._driver.doAuthorize(authUrl,_this._oauth.authStateParam(),_this,function(queryParams){return _this._oauth.processRedirectParams(queryParams),queryParams.uid&&(_this._uid=queryParams.uid),_fsmNextStep()})):void(callback&&callback(null,_this));case DbxClient.PARAM_LOADED:return _this._driver.resumeAuthorize?_this._driver.resumeAuthorize(_this._oauth.authStateParam(),_this,function(queryParams){return _this._oauth.processRedirectParams(queryParams),queryParams.uid&&(_this._uid=queryParams.uid),_fsmNextStep()}):(_this._oauth.setAuthStateParam(_this._oauth.authStateParam()),void _fsmNextStep());case DbxClient.AUTHORIZED:return _this.getAccessToken(function(error,data){return error?(_this.authError=error,_fsmErrorStep()):(_this._oauth.processRedirectParams(data),_this._uid=data.uid,_fsmNextStep())});case DbxClient.DONE:callback&&callback(null,_this);break;case DbxClient.SIGNED_OUT:return _this.authStep=DbxClient.RESET,_this.reset(),_fsmStep();case DbxClient.ERROR:callback&&callback(_this.authError,_this)}},_fsmStep(),this},Client.prototype.isAuthenticated=function(){return this.authStep===DbxClient.DONE},Client.prototype.signOut=function(options,callback){var stopOnXhrError,xhr,_this=this;if(callback||"function"!=typeof options||(callback=options,options=null),stopOnXhrError=options&&options.mustInvalidate,this.authStep!==DbxClient.DONE)throw new Error("This client doesn't have a user's token");return xhr=new Dropbox.Util.Xhr("POST",this._urls.signOut),xhr.signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error){if(error)if(error.status===Dropbox.ApiError.INVALID_TOKEN)error=null;else if(stopOnXhrError)return void(callback&&callback(error));return _this.authStep=DbxClient.RESET,_this.reset(),_this.authStep=DbxClient.SIGNED_OUT,_this.onAuthStepChange.dispatch(_this),_this._driver&&_this._driver.onAuthStepChange?_this._driver.onAuthStepChange(_this,function(){if(callback)return callback(null)}):callback?callback(null):void 0})},Client.prototype.signOff=function(options,callback){return this.signOut(options,callback)},Client.prototype.getAccountInfo=function(options,callback){var httpCache,xhr;return callback||"function"!=typeof options||(callback=options,options=null),httpCache=!1,options&&options.httpCache&&(httpCache=!0),xhr=new Dropbox.Util.Xhr("GET",this._urls.accountInfo),xhr.signWithOauth(this._oauth,httpCache),this._dispatchXhr(xhr,function(error,accountData){return callback(error,Dropbox.AccountInfo.parse(accountData),accountData)})},Client.prototype.getUserInfo=function(options,callback){return this.getAccountInfo(options,callback)},Client.prototype.readFile=function(path,options,callback){var httpCache,params,rangeEnd,rangeHeader,rangeStart,responseType,xhr;return callback||"function"!=typeof options||(callback=options,options=null),params={},responseType="text",rangeHeader=null,httpCache=!1,options&&(options.versionTag?params.rev=options.versionTag:options.rev&&(params.rev=options.rev),options.arrayBuffer?responseType="arraybuffer":options.blob?responseType="blob":options.buffer?responseType="buffer":options.binary&&(responseType="b"),options.length?(null!=options.start?(rangeStart=options.start,rangeEnd=options.start+options.length-1):(rangeStart="",rangeEnd=options.length),rangeHeader="bytes="+rangeStart+"-"+rangeEnd):null!=options.start&&(rangeHeader="bytes="+options.start+"-"),options.httpCache&&(httpCache=!0)),xhr=new Dropbox.Util.Xhr("GET",this._urls.getFile+"/"+this._urlEncodePath(path)),xhr.setParams(params).signWithOauth(this._oauth,httpCache),xhr.setResponseType(responseType),rangeHeader&&(rangeHeader&&xhr.setHeader("Range",rangeHeader),xhr.reportResponseHeaders()),this._dispatchXhr(xhr,function(error,data,metadata,headers){var rangeInfo;return rangeInfo=headers?Dropbox.Http.RangeInfo.parse(headers["content-range"]):null,callback(error,data,Dropbox.File.Stat.parse(metadata),rangeInfo)})},Client.prototype.writeFile=function(path,data,options,callback){var useForm;return callback||"function"!=typeof options||(callback=options,options=null),useForm=Dropbox.Util.Xhr.canSendForms&&"object"==typeof data,useForm?this._writeFileUsingForm(path,data,options,callback):this._writeFileUsingPut(path,data,options,callback)},Client.prototype._writeFileUsingForm=function(path,data,options,callback){var fileName,params,slashIndex,xhr;return slashIndex=path.lastIndexOf("/"),-1===slashIndex?(fileName=path,path=""):(fileName=path.substring(slashIndex),path=path.substring(0,slashIndex)),params={file:fileName},options&&(options.noOverwrite&&(params.overwrite="false"),options.lastVersionTag?params.parent_rev=options.lastVersionTag:(options.parentRev||options.parent_rev)&&(params.parent_rev=options.parentRev||options.parent_rev)),xhr=new Dropbox.Util.Xhr("POST",this._urls.postFile+"/"+this._urlEncodePath(path)),xhr.setParams(params).signWithOauth(this._oauth).setFileField("file",fileName,data,"application/octet-stream"),delete params.file,this._dispatchXhr(xhr,function(error,metadata){if(callback)return callback(error,Dropbox.File.Stat.parse(metadata))})},Client.prototype._writeFileUsingPut=function(path,data,options,callback){var params,xhr;return params={},options&&(options.noOverwrite&&(params.overwrite="false"),options.lastVersionTag?params.parent_rev=options.lastVersionTag:(options.parentRev||options.parent_rev)&&(params.parent_rev=options.parentRev||options.parent_rev)),xhr=new Dropbox.Util.Xhr("POST",this._urls.putFile+"/"+this._urlEncodePath(path)),xhr.setBody(data).setParams(params).signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,metadata){if(callback)return callback(error,Dropbox.File.Stat.parse(metadata))})},Client.prototype.resumableUploadStep=function(data,cursor,callback){var params,xhr;return cursor?(params={offset:cursor.offset},cursor.tag&&(params.upload_id=cursor.tag)):params={offset:0},xhr=new Dropbox.Util.Xhr("POST",this._urls.chunkedUpload),xhr.setBody(data).setParams(params).signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,cursor){return error&&error.status===Dropbox.ApiError.INVALID_PARAM&&error.response&&error.response.upload_id&&error.response.offset?callback(null,Dropbox.Http.UploadCursor.parse(error.response)):callback(error,Dropbox.Http.UploadCursor.parse(cursor))})},Client.prototype.resumableUploadFinish=function(path,cursor,options,callback){var params,xhr;return callback||"function"!=typeof options||(callback=options,options=null),params={upload_id:cursor.tag},options&&(options.lastVersionTag?params.parent_rev=options.lastVersionTag:(options.parentRev||options.parent_rev)&&(params.parent_rev=options.parentRev||options.parent_rev),options.noOverwrite&&(params.overwrite="false")),xhr=new Dropbox.Util.Xhr("POST",this._urls.commitChunkedUpload+"/"+this._urlEncodePath(path)),xhr.setParams(params).signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,metadata){if(callback)return callback(error,Dropbox.File.Stat.parse(metadata))})},Client.prototype.stat=function(path,options,callback){var httpCache,params,xhr
;return callback||"function"!=typeof options||(callback=options,options=null),params={},httpCache=!1,options&&(options.versionTag?params.rev=options.versionTag:options.rev&&(params.rev=options.rev),options.contentHash?params.hash=options.contentHash:options.hash&&(params.hash=options.hash),(options.removed||options.deleted)&&(params.include_deleted="true"),options.readDir&&(params.list="true",!0!==options.readDir&&(params.file_limit=options.readDir.toString())),options.cacheHash&&(params.hash=options.cacheHash),options.httpCache&&(httpCache=!0)),params.include_deleted||(params.include_deleted="false"),params.list||(params.list="false"),xhr=new Dropbox.Util.Xhr("GET",this._urls.metadata+"/"+this._urlEncodePath(path)),xhr.setParams(params).signWithOauth(this._oauth,httpCache),this._dispatchXhr(xhr,function(error,metadata){var entries,entry,stat;return stat=Dropbox.File.Stat.parse(metadata),entries=(null!=metadata?metadata.contents:void 0)?function(){var _i,_len,_ref,_results;for(_ref=metadata.contents,_results=[],_i=0,_len=_ref.length;_i<_len;_i++)entry=_ref[_i],_results.push(Dropbox.File.Stat.parse(entry));return _results}():void 0,callback(error,stat,entries)})},Client.prototype.readdir=function(path,options,callback){var statOptions;return callback||"function"!=typeof options||(callback=options,options=null),statOptions={readDir:!0},options&&(null!=options.limit&&(statOptions.readDir=options.limit),options.versionTag?statOptions.versionTag=options.versionTag:options.rev&&(statOptions.versionTag=options.rev),options.contentHash?statOptions.contentHash=options.contentHash:options.hash&&(statOptions.contentHash=options.hash),(options.removed||options.deleted)&&(statOptions.removed=options.removed||options.deleted),options.httpCache&&(statOptions.httpCache=options.httpCache)),this.stat(path,statOptions,function(error,stat,entry_stats){var entries,entry_stat;return entries=entry_stats?function(){var _i,_len,_results;for(_results=[],_i=0,_len=entry_stats.length;_i<_len;_i++)entry_stat=entry_stats[_i],_results.push(entry_stat.name);return _results}():null,callback(error,entries,stat,entry_stats)})},Client.prototype.metadata=function(path,options,callback){return this.stat(path,options,callback)},Client.prototype.makeUrl=function(path,options,callback){var isDirect,params,url,useDownloadHack,xhr,_this=this;return callback||"function"!=typeof options||(callback=options,options=null),params=options&&(options.long||options.longUrl||options.downloadHack)?{short_url:"false"}:{},path=this._urlEncodePath(path),url=this._urls.shares+"/"+path,isDirect=!1,useDownloadHack=!1,options&&(options.downloadHack?(isDirect=!0,useDownloadHack=!0):options.download&&(isDirect=!0,url=this._urls.media+"/"+path)),xhr=new Dropbox.Util.Xhr("POST",url).setParams(params).signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,urlData){return useDownloadHack&&(null!=urlData?urlData.url:void 0)&&(urlData.url=urlData.url.replace(_this._authServer,_this._downloadServer)),callback(error,Dropbox.File.ShareUrl.parse(urlData,isDirect))})},Client.prototype.history=function(path,options,callback){var httpCache,params,xhr;return callback||"function"!=typeof options||(callback=options,options=null),params={},httpCache=!1,options&&(null!=options.limit&&(params.rev_limit=options.limit),options.httpCache&&(httpCache=!0)),xhr=new Dropbox.Util.Xhr("GET",this._urls.revisions+"/"+this._urlEncodePath(path)),xhr.setParams(params).signWithOauth(this._oauth,httpCache),this._dispatchXhr(xhr,function(error,versions){var metadata,stats;return stats=versions?function(){var _i,_len,_results;for(_results=[],_i=0,_len=versions.length;_i<_len;_i++)metadata=versions[_i],_results.push(Dropbox.File.Stat.parse(metadata));return _results}():void 0,callback(error,stats)})},Client.prototype.revisions=function(path,options,callback){return this.history(path,options,callback)},Client.prototype.thumbnailUrl=function(path,options){var xhr;return xhr=this.thumbnailXhr(path,options),xhr.paramsToUrl().url},Client.prototype.readThumbnail=function(path,options,callback){var responseType,xhr;return callback||"function"!=typeof options||(callback=options,options=null),responseType="b",options&&(options.blob&&(responseType="blob"),options.arrayBuffer&&(responseType="arraybuffer"),options.buffer&&(responseType="buffer")),xhr=this.thumbnailXhr(path,options),xhr.setResponseType(responseType),this._dispatchXhr(xhr,function(error,data,metadata){return callback(error,data,Dropbox.File.Stat.parse(metadata))})},Client.prototype.thumbnailXhr=function(path,options){var params,xhr;return params={},options&&(options.format?params.format=options.format:options.png&&(params.format="png"),options.size&&(params.size=options.size)),xhr=new Dropbox.Util.Xhr("GET",this._urls.thumbnails+"/"+this._urlEncodePath(path)),xhr.setParams(params).signWithOauth(this._oauth)},Client.prototype.revertFile=function(path,versionTag,callback){var xhr;return xhr=new Dropbox.Util.Xhr("POST",this._urls.restore+"/"+this._urlEncodePath(path)),xhr.setParams({rev:versionTag}).signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,metadata){if(callback)return callback(error,Dropbox.File.Stat.parse(metadata))})},Client.prototype.restore=function(path,versionTag,callback){return this.revertFile(path,versionTag,callback)},Client.prototype.findByName=function(path,namePattern,options,callback){var httpCache,params,xhr;return callback||"function"!=typeof options||(callback=options,options=null),params={query:namePattern},httpCache=!1,options&&(null!=options.limit&&(params.file_limit=options.limit),(options.removed||options.deleted)&&(params.include_deleted=!0),options.httpCache&&(httpCache=!0)),xhr=new Dropbox.Util.Xhr("GET",this._urls.search+"/"+this._urlEncodePath(path)),xhr.setParams(params).signWithOauth(this._oauth,httpCache),this._dispatchXhr(xhr,function(error,results){var metadata,stats;return stats=results?function(){var _i,_len,_results;for(_results=[],_i=0,_len=results.length;_i<_len;_i++)metadata=results[_i],_results.push(Dropbox.File.Stat.parse(metadata));return _results}():void 0,callback(error,stats)})},Client.prototype.search=function(path,namePattern,options,callback){return this.findByName(path,namePattern,options,callback)},Client.prototype.makeCopyReference=function(path,callback){var xhr;return xhr=new Dropbox.Util.Xhr("GET",this._urls.copyRef+"/"+this._urlEncodePath(path)),xhr.signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,refData){return callback(error,Dropbox.File.CopyReference.parse(refData))})},Client.prototype.copyRef=function(path,callback){return this.makeCopyReference(path,callback)},Client.prototype.pullChanges=function(cursor,callback){var params,xhr;return callback||"function"!=typeof cursor||(callback=cursor,cursor=null),params=cursor?cursor.cursorTag?{cursor:cursor.cursorTag}:{cursor:cursor}:{},xhr=new Dropbox.Util.Xhr("POST",this._urls.delta),xhr.setParams(params).signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,deltaInfo){return callback(error,Dropbox.Http.PulledChanges.parse(deltaInfo))})},Client.prototype.delta=function(cursor,callback){return this.pullChanges(cursor,callback)},Client.prototype.pollForChanges=function(cursor,options,callback){var params,xhr;return callback||"function"!=typeof options||(callback=options,options=null),params=cursor.cursorTag?{cursor:cursor.cursorTag}:{cursor:cursor},options&&"timeout"in options&&(params.timeout=options.timeout),xhr=new Dropbox.Util.Xhr("GET",this._urls.longpollDelta),xhr.setParams(params),this._dispatchXhr(xhr,function(error,response){if("string"==typeof response)try{response=JSON.parse(response)}catch(_error){_error,response=null}return callback(error,Dropbox.Http.PollResult.parse(response))})},Client.prototype.mkdir=function(path,callback){var xhr;return xhr=new Dropbox.Util.Xhr("POST",this._urls.fileopsCreateFolder),xhr.setParams({root:"auto",path:this._normalizePath(path)}).signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,metadata){if(callback)return callback(error,Dropbox.File.Stat.parse(metadata))})},Client.prototype.remove=function(path,callback){var xhr;return xhr=new Dropbox.Util.Xhr("POST",this._urls.fileopsDelete),xhr.setParams({root:"auto",path:this._normalizePath(path)}).signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,metadata){if(callback)return callback(error,Dropbox.File.Stat.parse(metadata))})},Client.prototype.unlink=function(path,callback){return this.remove(path,callback)},Client.prototype.delete=function(path,callback){return this.remove(path,callback)},Client.prototype.copy=function(from,toPath,callback){var options,params,xhr;return callback||"function"!=typeof options||(callback=options,options=null),params={root:"auto",to_path:this._normalizePath(toPath)},from instanceof Dropbox.File.CopyReference?params.from_copy_ref=from.tag:params.from_path=this._normalizePath(from),xhr=new Dropbox.Util.Xhr("POST",this._urls.fileopsCopy),xhr.setParams(params).signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,metadata){if(callback)return callback(error,Dropbox.File.Stat.parse(metadata))})},Client.prototype.move=function(fromPath,toPath,callback){var options,xhr;return callback||"function"!=typeof options||(callback=options,options=null),xhr=new Dropbox.Util.Xhr("POST",this._urls.fileopsMove),xhr.setParams({root:"auto",from_path:this._normalizePath(fromPath),to_path:this._normalizePath(toPath)}).signWithOauth(this._oauth),this._dispatchXhr(xhr,function(error,metadata){if(callback)return callback(error,Dropbox.File.Stat.parse(metadata))})},Client.prototype.appInfo=function(appKey,callback){var xhr;return callback||"function"!=typeof appKey||(callback=appKey,appKey=this._oauth.credentials().key),xhr=new Dropbox.Util.Xhr("GET",this._urls.appsInfo),xhr.setParams({app_key:appKey}),this._dispatchXhr(xhr,function(error,appInfo){return callback(error,Dropbox.Http.AppInfo.parse(appInfo,appKey))})},Client.prototype.isAppDeveloper=function(userId,appKey,callback){var xhr;return"object"==typeof userId&&"uid"in userId&&(userId=userId.uid),callback||"function"!=typeof appKey?"object"==typeof appKey&&"key"in appKey&&(appKey=appKey.key):(callback=appKey,appKey=this._oauth.credentials().key),xhr=new Dropbox.Util.Xhr("GET",this._urls.appsCheckDeveloper),xhr.setParams({app_key:appKey,uid:userId}),this._dispatchXhr(xhr,function(error,response){return response?callback(error,response.is_developer):callback(error)})},Client.prototype.hasOauthRedirectUri=function(redirectUri,appKey,callback){var xhr;return callback||"function"!=typeof appKey?"object"==typeof appKey&&"key"in appKey&&(appKey=appKey.key):(callback=appKey,appKey=this._oauth.credentials().key),xhr=new Dropbox.Util.Xhr("GET",this._urls.appsCheckRedirectUri),xhr.setParams({app_key:appKey,redirect_uri:redirectUri}),this._dispatchXhr(xhr,function(error,response){return response?callback(error,response.has_redirect_uri):callback(error)})},Client.prototype.reset=function(){var oldAuthStep;return this._uid=null,this._oauth.reset(),oldAuthStep=this.authStep,this.authStep=this._oauth.step(),oldAuthStep!==this.authStep&&this.onAuthStepChange.dispatch(this),this.authError=null,this._credentials=null,this},Client.prototype.setCredentials=function(credentials){var oldAuthStep;return oldAuthStep=this.authStep,this._oauth.setCredentials(credentials),this.authStep=this._oauth.step(),this._uid=credentials.uid||null,this.authError=null,this._credentials=null,oldAuthStep!==this.authStep&&this.onAuthStepChange.dispatch(this),this},Client.prototype.appHash=function(){return this._oauth.appHash()},Client.prototype.setupUrls=function(){return this._apiServer=this._chooseApiServer(),this._urls={authorize:this._authServer+"/1/oauth2/authorize",token:this._apiServer+"/1/oauth2/token",signOut:this._apiServer+"/1/unlink_access_token",accountInfo:this._apiServer+"/1/account/info",getFile:this._fileServer+"/1/files/auto",postFile:this._fileServer+"/1/files/auto",putFile:this._fileServer+"/1/files_put/auto",metadata:this._apiServer+"/1/metadata/auto",delta:this._apiServer+"/1/delta",longpollDelta:this._notifyServer+"/1/longpoll_delta",revisions:this._apiServer+"/1/revisions/auto",restore:this._apiServer+"/1/restore/auto",search:this._apiServer+"/1/search/auto",shares:this._apiServer+"/1/shares/auto",media:this._apiServer+"/1/media/auto",copyRef:this._apiServer+"/1/copy_ref/auto",thumbnails:this._fileServer+"/1/thumbnails/auto",chunkedUpload:this._fileServer+"/1/chunked_upload",commitChunkedUpload:this._fileServer+"/1/commit_chunked_upload/auto",fileopsCopy:this._apiServer+"/1/fileops/copy",fileopsCreateFolder:this._apiServer+"/1/fileops/create_folder",fileopsDelete:this._apiServer+"/1/fileops/delete",fileopsMove:this._apiServer+"/1/fileops/move",appsInfo:this._apiServer+"/1/apps/info",appsCheckDeveloper:this._apiServer+"/1/apps/check_developer",appsCheckRedirectUri:this._apiServer+"/1/apps/check_redirect_uri"}},Client.prototype._chooseApiServer=function(){var serverId,serverNumber;return serverNumber=Math.floor(Math.random()*(this._maxApiServer+1)),serverId=0===serverNumber?"":serverNumber.toString(),this._serverRoot.replace("$",serverId)},Client.prototype.authStep=null,Client.ERROR=0,Client.RESET=1,Client.PARAM_SET=2,Client.PARAM_LOADED=3,Client.AUTHORIZED=4,Client.DONE=5,Client.SIGNED_OUT=6,Client.prototype._urlEncodePath=function(path){return Dropbox.Util.Xhr.urlEncodeValue(this._normalizePath(path)).replace(/%2F/gi,"/")},Client.prototype._normalizePath=function(path){var i;if("/"===path.substring(0,1)){for(i=1;"/"===path.substring(i,i+1);)i+=1;return path.substring(i)}return path},Client.prototype.authorizeUrl=function(){var params;return params=this._oauth.authorizeUrlParams(this._driver.authType(),this._driver.url()),this._urls.authorize+"?"+Dropbox.Util.Xhr.urlEncode(params)},Client.prototype.getAccessToken=function(callback){var params,xhr;return params=this._oauth.accessTokenParams(this._driver.url()),xhr=new Dropbox.Util.Xhr("POST",this._urls.token).setParams(params).addOauthParams(this._oauth),this._dispatchXhr(xhr,function(error,data){return error&&error.status===Dropbox.ApiError.INVALID_PARAM&&error.response&&error.response.error&&(error=new Dropbox.AuthError(error.response)),callback(error,data)})},Client.prototype._dispatchXhr=function(xhr,callback){var nativeXhr;return xhr.setCallback(callback),xhr.onError=this._xhrOnErrorHandler,xhr.prepare(),nativeXhr=xhr.xhr,this.onXhr.dispatch(xhr)&&xhr.send(),nativeXhr},Client.prototype._handleXhrError=function(error,callback){var _this=this;if(error.status===Dropbox.ApiError.INVALID_TOKEN&&this.authStep===DbxClient.DONE&&(this.authError=error,this.authStep=DbxClient.ERROR,this.onAuthStepChange.dispatch(this),this._driver&&this._driver.onAuthStepChange))return this._driver.onAuthStepChange(this,function(){return _this.onError.dispatch(error),callback(error)}),null;this.onError.dispatch(error),callback(error)},Client.prototype._defaultServerRoot=function(){return"https://api$.dropbox.com"},Client.prototype._defaultAuthServer=function(){return this._serverRoot.replace("api$","www")},Client.prototype._defaultFileServer=function(){return this._serverRoot.replace("api$","api-content")},Client.prototype._defaultDownloadServer=function(){return"https://dl.dropboxusercontent.com"},Client.prototype._defaultNotifyServer=function(){return this._serverRoot.replace("api$","api-notify")},Client.prototype._defaultMaxApiServer=function(){return 30},Client.prototype._computeCredentials=function(){var value;value=this._oauth.credentials(),this._uid&&(value.uid=this._uid),this._serverRoot!==this._defaultServerRoot()&&(value.server=this._serverRoot),this._maxApiServer!==this._defaultMaxApiServer()&&(value.maxApiServer=this._maxApiServer),this._authServer!==this._defaultAuthServer()&&(value.authServer=this._authServer),this._fileServer!==this._defaultFileServer()&&(value.fileServer=this._fileServer),this._downloadServer!==this._defaultDownloadServer()&&(value.downloadServer=this._downloadServer),this._notifyServer!==this._defaultNotifyServer()&&(value.notifyServer=this._notifyServer),this._credentials=value},Client}(),DbxClient=Dropbox.Client,Dropbox.File.ShareUrl=function(){function ShareUrl(urlData,isDirect){this.url=urlData.url,this.expiresAt=Dropbox.Util.parseDate(urlData.expires),this.isDirect=!0===isDirect||!1!==isDirect&&("direct"in urlData?urlData.direct:Date.now()-this.expiresAt<=864e5),this.isPreview=!this.isDirect,this._json=null}return ShareUrl.parse=function(urlData,isDirect){return urlData&&"object"==typeof urlData?new Dropbox.File.ShareUrl(urlData,isDirect):urlData},ShareUrl.prototype.url=null,ShareUrl.prototype.expiresAt=null,ShareUrl.prototype.isDirect=null,ShareUrl.prototype.isPreview=null,ShareUrl.prototype.json=function(){return this._json||(this._json={url:this.url,expires:this.expiresAt.toUTCString(),direct:this.isDirect})},ShareUrl}(),Dropbox.File.CopyReference=function(){function CopyReference(refData){"object"==typeof refData?(this.tag=refData.copy_ref,this.expiresAt=Dropbox.Util.parseDate(refData.expires),this._json=refData):(this.tag=refData,this.expiresAt=new Date(1e3*Math.ceil(Date.now()/1e3)),this._json=null)}return CopyReference.parse=function(refData){return!refData||"object"!=typeof refData&&"string"!=typeof refData?refData:new Dropbox.File.CopyReference(refData)},CopyReference.prototype.tag=null,CopyReference.prototype.expiresAt=null,CopyReference.prototype.json=function(){return this._json||(this._json={copy_ref:this.tag,expires:this.expiresAt.toUTCString()})},CopyReference}(),Dropbox.File.Stat=function(){function Stat(metadata){var lastIndex,nameSlash,_ref,_ref1;switch(this._json=metadata,this.path=metadata.path,"/"!==this.path.substring(0,1)&&(this.path="/"+this.path),lastIndex=this.path.length-1,lastIndex>=0&&"/"===this.path.substring(lastIndex)&&(this.path=this.path.substring(0,lastIndex)),nameSlash=this.path.lastIndexOf("/"),this.name=this.path.substring(nameSlash+1),this.isFolder=metadata.is_dir||!1,this.isFile=!this.isFolder,this.isRemoved=metadata.is_deleted||!1,this.typeIcon=metadata.icon,(null!=(_ref=metadata.modified)?_ref.length:void 0)?this.modifiedAt=Dropbox.Util.parseDate(metadata.modified):this.modifiedAt=null,(null!=(_ref1=metadata.client_mtime)?_ref1.length:void 0)?this.clientModifiedAt=Dropbox.Util.parseDate(metadata.client_mtime):this.clientModifiedAt=null,metadata.root){case"dropbox":this.inAppFolder=!1;break;case"app_folder":this.inAppFolder=!0;break;default:this.inAppFolder=null}this.size=metadata.bytes||0,this.humanSize=metadata.size||"",this.hasThumbnail=metadata.thumb_exists||!1,this.versionTag=metadata.rev,this.contentHash=metadata.hash||null,this.isFolder?this.mimeType=metadata.mime_type||"inode/directory":this.mimeType=metadata.mime_type||"application/octet-stream"}return Stat.parse=function(metadata){return metadata&&"object"==typeof metadata?new Dropbox.File.Stat(metadata):metadata},Stat.prototype.path=null,Stat.prototype.name=null,Stat.prototype.inAppFolder=null,Stat.prototype.isFolder=null,Stat.prototype.isFile=null,Stat.prototype.isRemoved=null,Stat.prototype.typeIcon=null,Stat.prototype.versionTag=null,Stat.prototype.contentHash=null,Stat.prototype.mimeType=null,Stat.prototype.size=null,Stat.prototype.humanSize=null,Stat.prototype.hasThumbnail=null,Stat.prototype.modifiedAt=null,Stat.prototype.clientModifiedAt=null,Stat.prototype.json=function(){return this._json},Stat}(),Dropbox.Http.AppInfo=function(){function AppInfo(appInfo,appKey){var permissions;this.name=appInfo.name,this._icons=appInfo.icons,permissions=appInfo.permissions||{},this.canUseDatastores=!!permissions.datastores,this.canUseFiles=!!permissions.files,this.canUseFullDropbox="full_dropbox"===permissions.files,this.hasAppFolder="app_folder"===permissions.files,this.key=appKey||(appInfo.key||null)}return AppInfo.parse=function(appInfo,appKey){return appInfo?new Dropbox.Http.AppInfo(appInfo,appKey):appInfo},AppInfo.prototype.name=void 0,AppInfo.prototype.key=void 0,AppInfo.prototype.canUseDatastores=void 0,AppInfo.prototype.canUseFiles=void 0,AppInfo.prototype.hasAppFolder=void 0,AppInfo.prototype.canUseFullDropbox=void 0,AppInfo.prototype.icon=function(width,height){return height||(height=width),this._icons[width+"x"+height]||null},AppInfo.ICON_SMALL=64,AppInfo.ICON_LARGE=256,AppInfo}(),Dropbox.Http.PulledChanges=function(){function PulledChanges(deltaInfo){var entry;this.blankSlate=deltaInfo.reset||!1,this.cursorTag=deltaInfo.cursor,this.shouldPullAgain=deltaInfo.has_more,this.shouldBackOff=!this.shouldPullAgain,deltaInfo.cursor&&deltaInfo.cursor.length?this.changes=function(){var _i,_len,_ref,_results;for(_ref=deltaInfo.entries,_results=[],_i=0,_len=_ref.length;_i<_len;_i++)entry=_ref[_i],_results.push(Dropbox.Http.PulledChange.parse(entry));return _results}():this.changes=[]}return PulledChanges.parse=function(deltaInfo){return deltaInfo&&"object"==typeof deltaInfo?new Dropbox.Http.PulledChanges(deltaInfo):deltaInfo},PulledChanges.prototype.blankSlate=void 0,PulledChanges.prototype.cursorTag=void 0,PulledChanges.prototype.changes=void 0,PulledChanges.prototype.shouldPullAgain=void 0,PulledChanges.prototype.shouldBackOff=void 0,PulledChanges.prototype.cursor=function(){return this.cursorTag},PulledChanges}(),Dropbox.Http.PulledChange=function(){function PulledChange(entry){this.path=entry[0],this.stat=Dropbox.File.Stat.parse(entry[1]),this.stat?this.wasRemoved=!1:(this.stat=null,this.wasRemoved=!0)}return PulledChange.parse=function(entry){return entry&&"object"==typeof entry?new Dropbox.Http.PulledChange(entry):entry},PulledChange.prototype.path=void 0,PulledChange.prototype.wasRemoved=void 0,PulledChange.prototype.stat=void 0,PulledChange}(),Dropbox.Http.PollResult=function(){function PollResult(response){this.hasChanges=response.changes,this.retryAfter=response.backoff||0}return PollResult.parse=function(response){return response?new Dropbox.Http.PollResult(response):response},PollResult.prototype.hasChanges=void 0,PollResult.prototype.retryAfter=void 0,PollResult}(),Dropbox.Http.RangeInfo=function(){function RangeInfo(headerValue){var match;(match=/^bytes (\d*)-(\d*)\/(.*)$/.exec(headerValue))?(this.start=parseInt(match[1]),this.end=parseInt(match[2]),"*"===match[3]?this.size=null:this.size=parseInt(match[3])):(this.start=0,this.end=0,this.size=null)}return RangeInfo.parse=function(headerValue){return"string"==typeof headerValue?new Dropbox.Http.RangeInfo(headerValue):headerValue},RangeInfo.prototype.start=null,RangeInfo.prototype.size=null,RangeInfo.prototype.end=null,RangeInfo}(),Dropbox.Http.UploadCursor=function(){function UploadCursor(cursorData){this.replace(cursorData)}return UploadCursor.parse=function(cursorData){return!cursorData||"object"!=typeof cursorData&&"string"!=typeof cursorData?cursorData:new Dropbox.Http.UploadCursor(cursorData)},UploadCursor.prototype.tag=null,UploadCursor.prototype.offset=null,UploadCursor.prototype.expiresAt=null,UploadCursor.prototype.json=function(){return this._json||(this._json={upload_id:this.tag,offset:this.offset,expires:this.expiresAt.toUTCString()})},UploadCursor.prototype.replace=function(cursorData){return"object"==typeof cursorData?(this.tag=cursorData.upload_id||null,this.offset=cursorData.offset||0,this.expiresAt=Dropbox.Util.parseDate(cursorData.expires)||Date.now(),this._json=cursorData):(this.tag=cursorData||null,this.offset=0,this.expiresAt=new Date(1e3*Math.floor(Date.now()/1e3)),this._json=null),this},UploadCursor}(),"function"==typeof Dropbox.Env.global.atob&&"function"==typeof Dropbox.Env.global.btoa?(Dropbox.Util.atob=function(string){return Dropbox.Env.global.atob(string)},Dropbox.Util.btoa=function(base64){return Dropbox.Env.global.btoa(base64)}):Dropbox.Env.global.require&&Dropbox.Env.global.Buffer?(Dropbox.Util.atob=function(arg){var buffer,i;return buffer=new Buffer(arg,"base64"),function(){var _i,_ref,_results;for(_results=[],i=_i=0,_ref=buffer.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)_results.push(String.fromCharCode(buffer[i]));return _results}().join("")},Dropbox.Util.btoa=function(arg){var buffer,i;return buffer=new Buffer(function(){var _i,_ref,_results;for(_results=[],i=_i=0,_ref=arg.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)_results.push(arg.charCodeAt(i));return _results}()),buffer.toString("base64")}):function(){var atobNibble,base64Digits,btoaNibble;base64Digits="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",btoaNibble=function(accumulator,bytes,result){var i,limit;for(limit=3-bytes,accumulator<<=8*limit,i=3;i>=limit;)result.push(base64Digits.charAt(accumulator>>6*i&63)),i-=1;for(i=bytes;i<3;)result.push("="),i+=1;return null},atobNibble=function(accumulator,digits,result){var i,limit;for(limit=4-digits,accumulator<<=6*limit,i=2;i>=limit;)result.push(String.fromCharCode(accumulator>>8*i&255)),i-=1;return null},Dropbox.Util.btoa=function(string){var accumulator,bytes,i,result,_i,_ref;for(result=[],accumulator=0,bytes=0,i=_i=0,_ref=string.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)accumulator=accumulator<<8|string.charCodeAt(i),3===(bytes+=1)&&(btoaNibble(accumulator,bytes,result),accumulator=bytes=0);return bytes>0&&btoaNibble(accumulator,bytes,result),result.join("")},Dropbox.Util.atob=function(base64){var accumulator,digit,digits,i,result,_i,_ref;for(result=[],accumulator=0,digits=0,i=_i=0,_ref=base64.length;(0<=_ref?_i<_ref:_i>_ref)&&"="!==(digit=base64.charAt(i));i=0<=_ref?++_i:--_i)accumulator=accumulator<<6|base64Digits.indexOf(digit),4===(digits+=1)&&(atobNibble(accumulator,digits,result),accumulator=digits=0);return digits>0&&atobNibble(accumulator,digits,result),result.join("")}}(),function(){var arrayToBase64,crypto,hmacSha1,sha1,sha256,sha256Init,sha256Key,stringToArray,_base64Digits;if(Dropbox.Util.hmac=function(string,key){return arrayToBase64(hmacSha1(stringToArray(string),stringToArray(key),string.length,key.length))},Dropbox.Util.sha1=function(string){return arrayToBase64(sha1(stringToArray(string),string.length))},Dropbox.Util.sha256=function(string){return arrayToBase64(sha256(stringToArray(string),string.length))},Dropbox.Env.require)try{crypto=Dropbox.Env.require("crypto"),crypto.createHmac&&crypto.createHash&&(Dropbox.Util.hmac=function(string,key){var hmac;return hmac=crypto.createHmac("sha1",key),hmac.update(string),hmac.digest("base64")},Dropbox.Util.sha1=function(string){var hash;return hash=crypto.createHash("sha1"),hash.update(string),hash.digest("base64")},Dropbox.Util.sha256=function(string){var hash;return hash=crypto.createHash("sha256"),hash.update(string),hash.digest("base64")})}catch(_error){_error}hmacSha1=function(string,key,length,keyLength){var hash1,i,ipad,opad;return key.length>16&&(key=sha1(key,keyLength)),ipad=function(){var _i,_results;for(_results=[],i=_i=0;_i<16;i=++_i)_results.push(909522486^key[i]);return _results}(),opad=function(){var _i,_results;for(_results=[],i=_i=0;_i<16;i=++_i)_results.push(1549556828^key[i]);return _results}(),hash1=sha1(ipad.concat(string),64+length),sha1(opad.concat(hash1),84)},sha1=function(string,length){var a,a0,b,b0,c,c0,d,d0,e,e0,i,j,limit,n,state,t,_i;for(string[length>>2]|=1<<31-((3&length)<<3),string[15+(length+8>>6<<4)]=length<<3,state=Array(80),a=1732584193,b=4023233417,c=2562383102,d=271733878,e=3285377520,i=0,limit=string.length;i<limit;){for(a0=a,b0=b,c0=c,d0=d,e0=e,j=_i=0;_i<80;j=++_i)j<16?state[j]=0|string[i+j<<2>>2]:(n=(0|state[j-3<<2>>2])^(0|state[j-8<<2>>2])^(0|state[j-14<<2>>2])^(0|state[j-16<<2>>2]),state[j]=n<<1|n>>>31),t=((a<<5|a>>>27)+e|0)+state[j<<2>>2]|0,t=j<20?t+(1518500249+(b&c|~b&d)|0)|0:j<40?t+(1859775393+(b^c^d)|0)|0:j<60?0|t+((b&c|b&d|c&d)-1894007588):t+((b^c^d)-899497514|0)|0,e=d,d=c,c=b<<30|b>>>2,b=a,a=t;a=a0+a|0,b=b0+b|0,c=c0+c|0,d=d0+d|0,e=e0+e|0,i=i+16|0}return[a,b,c,d,e]},sha256=function(string,length){var a,a0,b,b0,c,c0,ch,d,d0,e,e0,f,f0,g,g0,gamma0,gamma0x,gamma1,gamma1x,h,h0,i,j,limit,maj,sigma0,sigma1,sj,state,t1,t2,_i;for(string[length>>2]|=1<<31-((3&length)<<3),string[15+(length+8>>6<<4)]=length<<3,state=Array(80),a=sha256Init[0],b=sha256Init[1],c=sha256Init[2],d=sha256Init[3],e=sha256Init[4],f=sha256Init[5],g=sha256Init[6],h=sha256Init[7],i=0,limit=string.length;i<limit;){for(a0=a,b0=b,c0=c,d0=d,e0=e,f0=f,g0=g,h0=h,j=_i=0;_i<64;j=++_i)j<16?sj=state[j]=0|string[i+j<<2>>2]:(gamma0x=0|state[j-15<<2>>2],gamma0=(gamma0x<<25|gamma0x>>>7)^(gamma0x<<14|gamma0x>>>18)^gamma0x>>>3,gamma1x=0|state[j-2<<2>>2],gamma1=(gamma1x<<15|gamma1x>>>17)^(gamma1x<<13|gamma1x>>>19)^gamma1x>>>10,sj=state[j]=(gamma0+(0|state[j-7<<2>>2])|0)+(gamma1+(0|state[j-16<<2>>2])|0)|0),ch=e&f^~e&g,maj=a&b^a&c^b&c,sigma0=(a<<30|a>>>2)^(a<<19|a>>>13)^(a<<10|a>>>22),sigma1=(e<<26|e>>>6)^(e<<21|e>>>11)^(e<<7|e>>>25),t1=((h+sigma1|0)+(ch+sj|0)|0)+(0|sha256Key[j<<2>>2])|0,t2=sigma0+maj|0,h=g,g=f,f=e,e=d+t1|0,d=c,c=b,b=a,a=t1+t2|0;a=a0+a|0,b=b0+b|0,c=c0+c|0,d=d0+d|0,e=e0+e|0,f=f0+f|0,g=g0+g|0,h=h0+h|0,i+=16}return[a,b,c,d,e,f,g,h]},function(n){return n<0&&(n=4*(1<<30)+n),n.toString(16)},sha256Init=[],sha256Key=[],function(){var factor,fractional,i,isPrime,prime,_i,_results;for(fractional=function(x){return 4294967296*(x-Math.floor(x))|0},prime=2,_results=[],i=_i=0;_i<64;i=++_i){for(;;){for(isPrime=!0,factor=2;factor*factor<=prime;){if(prime%factor==0){isPrime=!1;break}factor+=1}if(isPrime)break;prime+=1}i<8&&(sha256Init[i]=fractional(Math.pow(prime,.5))),sha256Key[i]=fractional(Math.pow(prime,1/3)),_results.push(prime+=1)}}(),arrayToBase64=function(array){var i,i2,limit,string,trit;for(string="",i=0,limit=4*array.length;i<limit;)i2=i,trit=(array[i2>>2]>>(3-(3&i2)<<3)&255)<<16,i2+=1,trit|=(array[i2>>2]>>(3-(3&i2)<<3)&255)<<8,i2+=1,trit|=array[i2>>2]>>(3-(3&i2)<<3)&255,string+=_base64Digits[trit>>18&63],string+=_base64Digits[trit>>12&63],i+=1,string+=i>=limit?"=":_base64Digits[trit>>6&63],i+=1,string+=i>=limit?"=":_base64Digits[63&trit],i+=1;return string},_base64Digits="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",stringToArray=function(string){var array,i,mask,_i,_ref;for(array=[],mask=255,i=_i=0,_ref=string.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)array[i>>2]|=(string.charCodeAt(i)&mask)<<(3-(3&i)<<3);return array}}(),Dropbox.Util.Oauth=function(){function Oauth(options){this._id=null,this._secret=null,this._stateParam=null,this._authCode=null,this._token=null,this._tokenKey=null,this._tokenKid=null,this._error=null,this._appHash=null,this._loaded=null,this.setCredentials(options)}return Oauth.prototype.setCredentials=function(options){if(options.key)this._id=options.key;else{if(!options.token)throw new Error("No API key supplied");this._id=null}return this._secret=options.secret||null,this._appHash=null,this._error=null,this._loaded=!0,this.reset(),options.token?(this._token=options.token,options.tokenKey&&(this._tokenKey=options.tokenKey,this._tokenKid=options.tokenKid)):options.oauthCode?this._authCode=options.oauthCode:options.oauthStateParam&&(this._stateParam=options.oauthStateParam),this},Oauth.prototype.credentials=function(){var returnValue;return returnValue={},this._id&&(returnValue.key=this._id),this._secret&&(returnValue.secret=this._secret),null!==this._token?(returnValue.token=this._token,this._tokenKey&&(returnValue.tokenKey=this._tokenKey,returnValue.tokenKid=this._tokenKid)):null!==this._authCode?returnValue.oauthCode=this._authCode:null!==this._stateParam&&(returnValue.oauthStateParam=this._stateParam),returnValue},Oauth.prototype.step=function(){return null!==this._token?Dropbox.Client.DONE:null!==this._authCode?Dropbox.Client.AUTHORIZED:null!==this._stateParam?this._loaded?Dropbox.Client.PARAM_LOADED:Dropbox.Client.PARAM_SET:null!==this._error?Dropbox.Client.ERROR:Dropbox.Client.RESET},Oauth.prototype.setAuthStateParam=function(stateParam){if(null===this._id)throw new Error("No API key supplied, cannot do authorization");return this.reset(),this._loaded=!1,this._stateParam=stateParam,this},Oauth.prototype.checkAuthStateParam=function(stateParam){
return this._stateParam===stateParam&&null!==this._stateParam},Oauth.prototype.authStateParam=function(){return this._stateParam},Oauth.prototype.error=function(){return this._error},Oauth.prototype.processRedirectParams=function(queryParams){var tokenType;if(queryParams.error){if(null===this._id)throw new Error("No API key supplied, cannot process errors");return this.reset(),this._error=new Dropbox.AuthError(queryParams),!0}if(queryParams.code){if(null===this._id)throw new Error("No API key supplied, cannot do Authorization Codes");return this.reset(),this._loaded=!1,this._authCode=queryParams.code,!0}if(tokenType=queryParams.token_type){if("bearer"!==(tokenType=tokenType.toLowerCase())&&"mac"!==tokenType)throw new Error("Unimplemented token type "+tokenType);if(this.reset(),this._loaded=!1,"mac"===tokenType){if("hmac-sha-1"!==queryParams.mac_algorithm)throw new Error("Unimplemented MAC algorithms "+queryParams.mac_algorithm);this._tokenKey=queryParams.mac_key,this._tokenKid=queryParams.kid}return this._token=queryParams.access_token,!0}return!1},Oauth.prototype.authHeader=function(method,url,params){var macParams;return null===this._token?"Basic "+(null===this._secret?Dropbox.Util.btoa(this._id+":"):Dropbox.Util.btoa(this._id+":"+this._secret)):null===this._tokenKey?"Bearer "+this._token:(macParams=this.macParams(method,url,params),"MAC kid="+macParams.kid+" ts="+macParams.ts+" access_token="+this._token+" mac="+macParams.mac)},Oauth.prototype.addAuthParams=function(method,url,params){var macParams;return null===this._token?(params.client_id=this._id,null!==this._secret&&(params.client_secret=this._secret)):(null!==this._tokenKey&&(macParams=this.macParams(method,url,params),params.kid=macParams.kid,params.ts=macParams.ts,params.mac=macParams.mac),params.access_token=this._token),params},Oauth.prototype.authorizeUrlParams=function(responseType,redirectUrl){var params;if("token"!==responseType&&"code"!==responseType)throw new Error("Unimplemented /authorize response type "+responseType);return params={client_id:this._id,state:this._stateParam,response_type:responseType},redirectUrl&&(params.redirect_uri=redirectUrl),params},Oauth.prototype.accessTokenParams=function(redirectUrl){var params;return params={grant_type:"authorization_code",code:this._authCode},redirectUrl&&(params.redirect_uri=redirectUrl),params},Oauth.queryParamsFromUrl=function(url){var fragment,fragmentOffset,kvp,match,offset,params,query,_i,_len,_ref;if(!(match=/^[^?#]+(\?([^\#]*))?(\#(.*))?$/.exec(url)))return{};for(query=match[2]||"","/"===query.substring(0,1)&&(query=query.substring(1)),fragment=match[4]||"",fragmentOffset=fragment.indexOf("?"),-1!==fragmentOffset&&(fragment=fragment.substring(fragmentOffset+1)),"/"===fragment.substring(0,1)&&(fragment=fragment.substring(1)),params={},_ref=query.split("&").concat(fragment.split("&")),_i=0,_len=_ref.length;_i<_len;_i++)kvp=_ref[_i],-1!==(offset=kvp.indexOf("="))&&(params[decodeURIComponent(kvp.substring(0,offset))]=decodeURIComponent(kvp.substring(offset+1)));return params},Oauth.prototype.macParams=function(method,url,params){var macParams,string;return macParams={kid:this._tokenKid,ts:Dropbox.Util.Oauth.timestamp()},string=method.toUpperCase()+"&"+Dropbox.Util.Xhr.urlEncodeValue(url)+"&"+Dropbox.Util.Xhr.urlEncodeValue(Dropbox.Util.Xhr.urlEncode(params)),macParams.mac=Dropbox.Util.hmac(string,this._tokenKey),macParams},Oauth.prototype.appHash=function(){return this._appHash?this._appHash:this._appHash=Dropbox.Util.sha1("oauth2-"+this._id).replace(/[\/+=]/g,"")},Oauth.prototype.reset=function(){return this._stateParam=null,this._authCode=null,this._token=null,this._tokenKey=null,this._tokenKid=null,this._error=null,this},Oauth.timestamp=function(){return Math.floor(Date.now()/1e3)},Oauth.randomAuthStateParam=function(){return["oas",Date.now().toString(36),Math.random().toString(36)].join("_")},Oauth}(),null==Date.now&&(Dropbox.Util.Oauth.timestamp=function(){return Math.floor((new Date).getTime()/1e3)}),2274814865e3===new Date("Fri, 31 Jan 2042 21:01:05 +0000").valueOf()?Dropbox.Util.parseDate=function(dateString){return new Date(dateString)}:2274814865e3===Date.parse("Fri, 31 Jan 2042 21:01:05 +0000")?Dropbox.Util.parseDate=function(dateString){return new Date(Date.parse(dateString))}:function(){var parseDateMonths,parseDateRe;parseDateRe=/^\w+\, (\d+) (\w+) (\d+) (\d+)\:(\d+)\:(\d+) (\+\d+|UTC|GMT)$/,parseDateMonths={Jan:0,Feb:1,Mar:2,Apr:3,May:4,Jun:5,Jul:6,Aug:7,Sep:8,Oct:9,Nov:10,Dec:11},Dropbox.Util.parseDate=function(dateString){var match;return(match=parseDateRe.exec(dateString))?new Date(Date.UTC(parseInt(match[3]),parseDateMonths[match[2]],parseInt(match[1]),parseInt(match[4]),parseInt(match[5]),parseInt(match[6]),0)):NaN}}(),Dropbox.Env.global.XMLHttpRequest?(!Dropbox.Env.global.XDomainRequest||"withCredentials"in new XMLHttpRequest?(DbxXhrRequest=XMLHttpRequest,DbxXhrIeMode=!1,DbxXhrCanSendForms="undefined"!=typeof FormData&&-1===navigator.userAgent.indexOf("Firefox")):(DbxXhrRequest=XDomainRequest,DbxXhrIeMode=!0,DbxXhrCanSendForms=!1),DbxXhrDoesPreflight=!0):(DbxXhrRequest=Dropbox.Env.require("xhr2"),DbxXhrIeMode=!1,DbxXhrCanSendForms=!1,DbxXhrDoesPreflight=!1),Dropbox.Env.global.Uint8Array)if(Object.getPrototypeOf?DbxXhrArrayBufferView=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array(0))).constructor:Object.__proto__&&(DbxXhrArrayBufferView=new Uint8Array(0).__proto__.__proto__.constructor),Dropbox.Env.global.Blob){try{!function(){2===new Blob([new Uint8Array(2)]).size?(DbxXhrWrapBlob=!0,DbxXhrSendArrayBufferView=!0):(DbxXhrSendArrayBufferView=!1,DbxXhrWrapBlob=2===new Blob([new ArrayBuffer(2)]).size)}()}catch(_error){DbxXhrSendArrayBufferView=!1,DbxXhrWrapBlob=!1,Dropbox.Env.global.WebKitBlobBuilder&&-1!==navigator.userAgent.indexOf("Android")&&(DbxXhrCanSendForms=!1)}DbxXhrArrayBufferView===Object&&(DbxXhrSendArrayBufferView=!1)}else DbxXhrWrapBlob=!1,DbxXhrSendArrayBufferView=!0;else DbxXhrArrayBufferView=null,DbxXhrWrapBlob=!1,DbxXhrSendArrayBufferView=!1;Dropbox.Util.Xhr=function(){function Xhr(method,baseUrl){this.method=method,this.isGet="GET"===this.method,this.url=baseUrl,this.wantHeaders=!1,this.headers={},this.params=null,this.body=null,this.preflight=!(this.isGet||"POST"===this.method),this.signed=!1,this.completed=!1,this.responseType=null,this.callback=null,this.xhr=null,this.onError=null}return Xhr.Request=DbxXhrRequest,Xhr.ieXdr=DbxXhrIeMode,Xhr.canSendForms=DbxXhrCanSendForms,Xhr.doesPreflight=DbxXhrDoesPreflight,Xhr.ArrayBufferView=DbxXhrArrayBufferView,Xhr.sendArrayBufferView=DbxXhrSendArrayBufferView,Xhr.wrapBlob=DbxXhrWrapBlob,Xhr.prototype.xhr=null,Xhr.prototype.onError=null,Xhr.prototype.setParams=function(params){if(this.signed)throw new Error("setParams called after addOauthParams or addOauthHeader");if(this.params)throw new Error("setParams cannot be called twice");return this.params=params,this},Xhr.prototype.setCallback=function(callback){return this.callback=callback,this},Xhr.prototype.signWithOauth=function(oauth,cacheFriendly){return Dropbox.Util.Xhr.ieXdr?this.addOauthParams(oauth):this.preflight||!Dropbox.Util.Xhr.doesPreflight?this.addOauthHeader(oauth):this.isGet&&cacheFriendly?this.addOauthHeader(oauth):this.addOauthParams(oauth)},Xhr.prototype.addOauthParams=function(oauth){if(this.signed)throw new Error("Request already has an OAuth signature");return this.params||(this.params={}),oauth.addAuthParams(this.method,this.url,this.params),this.signed=!0,this},Xhr.prototype.addOauthHeader=function(oauth){if(this.signed)throw new Error("Request already has an OAuth signature");return this.params||(this.params={}),this.signed=!0,this.setHeader("Authorization",oauth.authHeader(this.method,this.url,this.params))},Xhr.prototype.setBody=function(body){if(this.isGet)throw new Error("setBody cannot be called on GET requests");if(null!==this.body)throw new Error("Request already has a body");return"string"==typeof body||"undefined"!=typeof FormData&&body instanceof FormData||(this.headers["Content-Type"]="application/octet-stream",this.preflight=!0),this.body=body,this},Xhr.prototype.setResponseType=function(responseType){return this.responseType=responseType,this},Xhr.prototype.setHeader=function(headerName,value){var oldValue;if(this.headers[headerName])throw oldValue=this.headers[headerName],new Error("HTTP header "+headerName+" already set to "+oldValue);if("Content-Type"===headerName)throw new Error("Content-Type is automatically computed based on setBody");return this.preflight=!0,this.headers[headerName]=value,this},Xhr.prototype.reportResponseHeaders=function(){return this.wantHeaders=!0},Xhr.prototype.setFileField=function(fieldName,fileName,fileData,contentType){var blob,boundary,builder,useFormData;if(null!==this.body)throw new Error("Request already has a body");if(this.isGet)throw new Error("setFileField cannot be called on GET requests");if("object"==typeof fileData){"undefined"!=typeof ArrayBuffer&&(fileData instanceof ArrayBuffer?Dropbox.Util.Xhr.sendArrayBufferView&&(fileData=new Uint8Array(fileData)):!Dropbox.Util.Xhr.sendArrayBufferView&&0===fileData.byteOffset&&fileData.buffer instanceof ArrayBuffer&&(fileData=fileData.buffer)),contentType||(contentType="application/octet-stream");try{fileData=new Blob([fileData],{type:contentType})}catch(_error){_error,window.WebKitBlobBuilder&&(builder=new WebKitBlobBuilder,builder.append(fileData),(blob=builder.getBlob(contentType))&&(fileData=blob))}"undefined"!=typeof File&&fileData instanceof File&&(fileData=new Blob([fileData],{type:fileData.type})),useFormData=fileData instanceof Blob}else useFormData=!1;return useFormData?(this.body=new FormData,this.body.append(fieldName,fileData,fileName)):(contentType||(contentType="application/octet-stream"),boundary=this.multipartBoundary(),this.headers["Content-Type"]="multipart/form-data; boundary="+boundary,this.body=["--",boundary,"\r\n",'Content-Disposition: form-data; name="',fieldName,'"; filename="',fileName,'"\r\n',"Content-Type: ",contentType,"\r\n","Content-Transfer-Encoding: binary\r\n\r\n",fileData,"\r\n","--",boundary,"--","\r\n"].join(""))},Xhr.prototype.multipartBoundary=function(){return[Date.now().toString(36),Math.random().toString(36)].join("----")},Xhr.prototype.paramsToUrl=function(){var queryString;return this.params&&(queryString=Dropbox.Util.Xhr.urlEncode(this.params),0!==queryString.length&&(this.url=[this.url,"?",queryString].join("")),this.params=null),this},Xhr.prototype.paramsToBody=function(){if(this.params){if(null!==this.body)throw new Error("Request already has a body");if(this.isGet)throw new Error("paramsToBody cannot be called on GET requests");this.headers["Content-Type"]="application/x-www-form-urlencoded",this.body=Dropbox.Util.Xhr.urlEncode(this.params),this.params=null}return this},Xhr.prototype.prepare=function(){var header,ieXdr,value,_ref,_this=this;if(ieXdr=Dropbox.Util.Xhr.ieXdr,this.isGet||null!==this.body||ieXdr?(this.paramsToUrl(),null!==this.body&&"string"==typeof this.body&&(this.headers["Content-Type"]="text/plain; charset=utf8")):this.paramsToBody(),this.xhr=new Dropbox.Util.Xhr.Request,ieXdr?(this.xhr.onload=function(){return _this.onXdrLoad()},this.xhr.onerror=function(){return _this.onXdrError()},this.xhr.ontimeout=function(){return _this.onXdrError()},this.xhr.onprogress=function(){}):this.xhr.onreadystatechange=function(){return _this.onReadyStateChange()},this.xhr.open(this.method,this.url,!0),!ieXdr){_ref=this.headers;for(header in _ref)__hasProp.call(_ref,header)&&(value=_ref[header],this.xhr.setRequestHeader(header,value))}return this.responseType&&("b"===this.responseType?this.xhr.overrideMimeType&&this.xhr.overrideMimeType("text/plain; charset=x-user-defined"):this.xhr.responseType=this.responseType),this},Xhr.prototype.send=function(callback){var body,xhrError;if(this.callback=callback||this.callback,null!==this.body){body=this.body,Dropbox.Util.Xhr.sendArrayBufferView?body instanceof ArrayBuffer&&(body=new Uint8Array(body)):0===body.byteOffset&&body.buffer instanceof ArrayBuffer&&(body=body.buffer);try{this.xhr.send(body)}catch(_error){if(xhrError=_error,Dropbox.Util.Xhr.sendArrayBufferView||!Dropbox.Util.Xhr.wrapBlob)throw xhrError;body=new Blob([body],{type:"application/octet-stream"}),this.xhr.send(body)}}else this.xhr.send();return this},Xhr.urlEncode=function(object){var chunks,key,value;chunks=[];for(key in object)value=object[key],chunks.push(this.urlEncodeValue(key)+"="+this.urlEncodeValue(value));return chunks.sort().join("&")},Xhr.urlEncodeValue=function(object){return encodeURIComponent(object.toString()).replace(/\!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A")},Xhr.urlDecode=function(string){var kvp,result,token,_i,_len,_ref;for(result={},_ref=string.split("&"),_i=0,_len=_ref.length;_i<_len;_i++)token=_ref[_i],kvp=token.split("="),result[decodeURIComponent(kvp[0])]=decodeURIComponent(kvp[1]);return result},Xhr.prototype.onReadyStateChange=function(){var allHeaders,apiError,bytes,contentType,dirtyText,duplicateIndex,headers,i,metadata,metadataJson,offset,text,_i,_ref;if(4!==this.xhr.readyState)return!0;if(this.completed)return!0;if(this.completed=!0,this.xhr.status<200||this.xhr.status>=300)return apiError=new Dropbox.ApiError(this.xhr,this.method,this.url),this.onError?this.onError(apiError,this.callback):this.callback(apiError),!0;if(this.wantHeaders?(allHeaders=this.xhr.getAllResponseHeaders(),headers=allHeaders?Dropbox.Util.Xhr.parseResponseHeaders(allHeaders):this.guessResponseHeaders(),metadataJson=headers["x-dropbox-metadata"]):(headers=void 0,metadataJson=this.xhr.getResponseHeader("x-dropbox-metadata")),null!=metadataJson?metadataJson.length:void 0)try{metadata=JSON.parse(metadataJson)}catch(_error){if(_error,-1!==(duplicateIndex=metadataJson.search(/\}\,\s*\{/)))try{metadataJson=metadataJson.substring(0,duplicateIndex+1),metadata=JSON.parse(metadataJson)}catch(_error){_error,metadata=void 0}else metadata=void 0}else metadata=void 0;if(this.responseType){if("b"===this.responseType){for(dirtyText=null!=this.xhr.responseText?this.xhr.responseText:this.xhr.response,bytes=[],i=_i=0,_ref=dirtyText.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i)bytes.push(String.fromCharCode(255&dirtyText.charCodeAt(i)));text=bytes.join(""),this.callback(null,text,metadata,headers)}else this.callback(null,this.xhr.response,metadata,headers);return!0}switch(text=null!=this.xhr.responseText?this.xhr.responseText:this.xhr.response,contentType=this.xhr.getResponseHeader("Content-Type"),contentType&&-1!==(offset=contentType.indexOf(";"))&&(contentType=contentType.substring(0,offset)),contentType){case"application/x-www-form-urlencoded":this.callback(null,Dropbox.Util.Xhr.urlDecode(text),metadata,headers);break;case"application/json":case"text/javascript":this.callback(null,JSON.parse(text),metadata,headers);break;default:this.callback(null,text,metadata,headers)}return!0},Xhr.parseResponseHeaders=function(allHeaders){var colonIndex,headerLines,headers,line,name,value,_i,_len;for(headers={},headerLines=allHeaders.split("\n"),_i=0,_len=headerLines.length;_i<_len;_i++)line=headerLines[_i],colonIndex=line.indexOf(":"),name=line.substring(0,colonIndex).trim().toLowerCase(),value=line.substring(colonIndex+1).trim(),headers[name]=value;return headers},Xhr.prototype.guessResponseHeaders=function(){var headers,name,value,_i,_len,_ref;for(headers={},_ref=["cache-control","content-language","content-range","content-type","expires","last-modified","pragma","x-dropbox-metadata"],_i=0,_len=_ref.length;_i<_len;_i++)name=_ref[_i],(value=this.xhr.getResponseHeader(name))&&(headers[name]=value);return headers},Xhr.prototype.onXdrLoad=function(){var headers,metadata,text;if(this.completed)return!0;if(this.completed=!0,text=this.xhr.responseText,headers=this.wantHeaders?{"content-type":this.xhr.contentType}:void 0,metadata=void 0,this.responseType)return this.callback(null,text,metadata,headers),!0;switch(this.xhr.contentType){case"application/x-www-form-urlencoded":this.callback(null,Dropbox.Util.Xhr.urlDecode(text),metadata,headers);break;case"application/json":case"text/javascript":this.callback(null,JSON.parse(text),metadata,headers);break;default:this.callback(null,text,metadata,headers)}return!0},Xhr.prototype.onXdrError=function(){var apiError;return!!this.completed||(this.completed=!0,apiError=new Dropbox.ApiError(this.xhr,this.method,this.url),this.onError?this.onError(apiError,this.callback):this.callback(apiError),!0)},Xhr}()}).call(this);
//# sourceMappingURL=libs/dropbox.map