!function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery"],factory):factory(jQuery)}(function($){"use strict";var match,uiVersion,supportSelectstart="onselectstart"in document.createElement("div");$.widget("moogle.contextmenu",{version:"@VERSION",options:{autoTrigger:!0,delegate:null,hide:{effect:"fadeOut",duration:"fast"},ignoreParentSelect:!0,menu:null,position:null,preventContextMenuForPopup:!1,preventSelect:!1,show:{effect:"slideDown",duration:"fast"},taphold:!1,uiMenuOptions:{},beforeOpen:$.noop,blur:$.noop,close:$.noop,create:$.noop,createMenu:$.noop,focus:$.noop,open:$.noop,select:$.noop},_create:function(){var cssText,eventNames,targetId,opts=this.options;if(this.$headStyle=null,this.$menu=null,this.menuIsTemp=!1,this.currentTarget=null,opts.preventSelect){targetId=($(this.element).is(document)?$("body"):this.element).uniqueId().attr("id"),cssText="#"+targetId+" "+opts.delegate+" { -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }",this.$headStyle=$("<style class='moogle-contextmenu-style' />").prop("type","text/css").appendTo("head");try{this.$headStyle.html(cssText)}catch(e){this.$headStyle[0].styleSheet.cssText=cssText}supportSelectstart&&this.element.delegate(opts.delegate,"selectstart"+this.eventNamespace,function(event){event.preventDefault()})}this._createUiMenu(opts.menu),eventNames="contextmenu"+this.eventNamespace,opts.taphold&&(eventNames+=" taphold"+this.eventNamespace),this.element.delegate(opts.delegate,eventNames,$.proxy(this._openMenu,this))},_destroy:function(){this.element.undelegate(this.eventNamespace),this._createUiMenu(null),this.$headStyle&&(this.$headStyle.remove(),this.$headStyle=null)},_createUiMenu:function(menuDef){var ct;this.isOpen()&&(ct=this.currentTarget,this._closeMenu(!0),this.currentTarget=ct),this.menuIsTemp?this.$menu.remove():this.$menu&&this.$menu.menu("destroy").hide(),this.$menu=null,this.menuIsTemp=!1,menuDef&&($.isArray(menuDef)?(this.$menu=$.moogle.contextmenu.createMenuMarkup(menuDef),this.menuIsTemp=!0):this.$menu="string"==typeof menuDef?$(menuDef):menuDef,this.$menu.hide().menu($.extend(!0,{},this.options.uiMenuOptions,{blur:$.proxy(this.options.blur,this),create:$.proxy(this.options.createMenu,this),focus:$.proxy(this.options.focus,this),select:$.proxy(function(event,ui){var retval,isParent=$.moogle.contextmenu.isMenu(ui.item),actionHandler=ui.item.data("actionHandler");ui.cmd=ui.item.attr("data-command"),ui.target=$(this.currentTarget),isParent&&this.options.ignoreParentSelect||(retval=this._trigger.call(this,"select",event,ui),actionHandler&&(retval=actionHandler.call(this,event,ui)),retval!==!1&&this._closeMenu.call(this),event.preventDefault())},this)})))},_openMenu:function(event){var opts=this.options,posOption=opts.position,self=this,manualTrigger=!!event.isTrigger,ui={menu:this.$menu,target:$(event.target),extraData:event.extraData,originalEvent:event};if(opts.autoTrigger||manualTrigger){if(this.currentTarget=event.target,event.preventDefault(),this._trigger("beforeOpen",event,ui)===!1)return this.currentTarget=null,!1;ui.menu=this.$menu,$(document).bind("keydown"+this.eventNamespace,function(event){event.which===$.ui.keyCode.ESCAPE&&self._closeMenu()}).bind("mousedown"+this.eventNamespace+" touchstart"+this.eventNamespace,function(event){$(event.target).closest(".ui-menu-item").length||self._closeMenu()}),$.isFunction(posOption)&&(posOption=posOption(event,ui)),posOption=$.extend({my:"left top",at:"left bottom",of:void 0===event.pageX?event.target:event,collision:"fit"},posOption),this.$menu.show().css({position:"absolute",left:0,top:0}).position(posOption).hide(),opts.preventContextMenuForPopup&&this.$menu.bind("contextmenu"+this.eventNamespace,function(event){event.preventDefault()}),this._show(this.$menu,this.options.show,function(){self._trigger.call(self,"open",event,ui)})}},_closeMenu:function(immediately){var self=this,hideOpts=immediately?!1:this.options.hide;$(document).unbind("mousedown"+this.eventNamespace).unbind("touchstart"+this.eventNamespace).unbind("keydown"+this.eventNamespace),this.$menu.unbind("contextmenu"+this.eventNamespace),self.currentTarget=null,this._hide(this.$menu,hideOpts,function(){self._trigger("close")})},_setOption:function(key,value){switch(key){case"menu":this.replaceMenu(value)}$.Widget.prototype._setOption.apply(this,arguments)},_getMenuEntry:function(cmd){return this.$menu.find("li[data-command="+cmd+"]")},close:function(){this.isOpen()&&this._closeMenu()},enableEntry:function(cmd,flag){this._getMenuEntry(cmd).toggleClass("ui-state-disabled",flag===!1)},getMenu:function(){return this.$menu},isOpen:function(){return!!this.$menu&&!!this.currentTarget},open:function(target,extraData){extraData=extraData||{};var e=jQuery.Event("contextmenu",{target:target.get(0),extraData:extraData});return this.element.trigger(e)},replaceMenu:function(data){this._createUiMenu(data)},setEntry:function(cmd,titleOrData){var $entry=this._getMenuEntry(cmd);"string"==typeof titleOrData?$.moogle.contextmenu.updateTitle($entry,titleOrData):($entry.empty(),titleOrData.cmd=titleOrData.cmd||cmd,$.moogle.contextmenu.createEntryMarkup(titleOrData,$entry))},showEntry:function(cmd,flag){this._getMenuEntry(cmd).toggle(flag!==!1)}}),$.extend($.moogle.contextmenu,{createMenuMarkup:function(options,$parentUl){var i,menu,$ul,$li;for(null==$parentUl&&($parentUl=$("<ul class='ui-helper-hidden' />").appendTo("body")),i=0;i<options.length;i++)menu=options[i],$li=$("<li/>").appendTo($parentUl),$.moogle.contextmenu.createEntryMarkup(menu,$li),$.isArray(menu.children)&&($ul=$("<ul/>").appendTo($li),$.moogle.contextmenu.createMenuMarkup(menu.children,$ul));return $parentUl},replaceFirstTextNodeChild:function(elem,text){elem.contents().filter(function(){return 3===this.nodeType}).first().replaceWith(text)}}),match=$.ui.menu.version.match(/^(\d)\.(\d+)/),uiVersion={major:parseInt(match[1],10),minor:parseInt(match[2],10)},uiVersion.major<2&&uiVersion.minor<11?$.extend($.moogle.contextmenu,{createEntryMarkup:function(entry,$parentLi){var $a=null;/[^\-\u2014\u2013\s]/.test(entry.title)?($parentLi.attr("data-command",entry.cmd),$a=$("<a/>",{html:""+entry.title,href:"#"}).appendTo($parentLi),$.isFunction(entry.action)&&$parentLi.data("actionHandler",entry.action),entry.uiIcon&&$a.append($("<span class='ui-icon' />").addClass(entry.uiIcon)),entry.disabled&&$parentLi.addClass("ui-state-disabled"),$.isPlainObject(entry.data)&&$a.data(entry.data)):$parentLi.text(entry.title)},isMenu:function(item){return item.has(">a[aria-haspopup='true']").length>0},updateTitle:function(item,title){$.moogle.contextmenu.replaceFirstTextNodeChild($("a",item),title)}}):$.extend($.moogle.contextmenu,{createEntryMarkup:function(entry,$parentLi){/[^\-\u2014\u2013\s]/.test(entry.title)?($parentLi.attr("data-command",entry.cmd).html(""+entry.title),$.isFunction(entry.action)&&$parentLi.data("actionHandler",entry.action),entry.uiIcon&&$parentLi.append($("<span class='ui-icon' />").addClass(entry.uiIcon)),entry.disabled&&$parentLi.addClass("ui-state-disabled"),$.isPlainObject(entry.data)&&$parentLi.data(entry.data)):$parentLi.text(entry.title)},isMenu:function(item){return item.is("[aria-haspopup='true']")},updateTitle:function(item,title){$.moogle.contextmenu.replaceFirstTextNodeChild(item,title)}})});