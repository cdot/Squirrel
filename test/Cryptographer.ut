/*@preserve Copyright (C) 2015-2019 Crawford Currie http://c-dot.co.uk license MIT*/
/*eslint-env node, mocha */

if (typeof module !== 'undefined') {
    requirejs = require('requirejs');
    requirejs.config({
        baseUrl: `${__dirname}/..`
    });
}

requirejs(["js/Utils", "js/Cryptographer", "test/TestRunner"], function(Utils, Crypto, TestRunner) {

    let tr = new TestRunner("Crypto");
    let assert = tr.assert;

    tr.addTest('should encrypt / decrypt 256 bytes', function() {
		const sz = 256;
		let ab = new Uint8Array(sz);
        for (let i = 0; i < sz; i++)
            ab[i] = i;
		return Crypto.encrypt(ab, "$ecret")
		.then(cipher => {
			//console.log(btoa(cipher));
			return Crypto.decrypt(cipher, "$ecret");
		})
		.then(ba => {
			assert.equal(ab.length, ba.length);
			for (let i = 0; i < ab.length; i++)
				assert.equal(ab[i], ba[i]);
		});
    });
	
    tr.addTest('should encrypt / decrypt lots of bytes quickly', function() {
		// 2^20 should be plenty
		const sz = Math.pow(2,20);
		let ab = new Uint8Array(sz);
        for (let i = 0; i < sz; i++)
            ab[i] = i;
		return Crypto.encrypt(ab, "$ecret")
		.then(cipher => Crypto.decrypt(cipher, "$ecret"))
		.then(ba => {
			assert.equal(ab.length, ba.length);
			for (let i = 0; i < ab.length; i++)
				assert.equal(ab[i], ba[i]);
		});
    });
	
    tr.addTest('should handle empty bytes', function() {
		let ab = new Uint8Array();
		return Crypto.encrypt(ab, "$ecret")
		.then(cipher => Crypto.decrypt(cipher, "$ecret"))
		.then(ab => {
			assert.equal(ab.length, 0);
		});
    });
	
    tr.run();
});
